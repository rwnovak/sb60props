<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Bowl LX Props</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, where, orderBy, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Attach to window for React to use
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, setDoc, doc, getDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, where, orderBy, deleteField };
    </script>

    <style>
        :root {
            --nfl-blue: #013369;
            --nfl-blue-dark: #002244;
            --nfl-blue-deep: #001122;
            --nfl-red: #D50A0A;
            --text-light: #e6f0ff;
        }
        body {
            background-color: #000c1a;
            color: var(--text-light);
            font-family: 'Roboto', sans-serif;
            background-image: linear-gradient(180deg, #001a33 0%, #000c1a 100%);
            min-height: 100vh;
        }
        h1, h2, h3, .score-display {
            font-family: 'Roboto Condensed', sans-serif;
            text-transform: uppercase;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #002244; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #013369; border-radius: 4px; border: 1px solid #004080; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #024a96; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .shield-icon { clip-path: polygon(50% 0, 100% 20%, 100% 80%, 50% 100%, 0 80%, 0 20%); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .tab-active { border-bottom: 3px solid #D50A0A; color: white; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #6b7280; }
        
        /* Seamless Scroll Animation */
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .animate-scroll {
            animation: scroll 60s linear infinite; /* Slower speed */
        }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect, useCallback } = React;
        
        // --- DATA CONSTANTS (MOVED TO BOTTOM) ---
        const halftimeSongs = [
            "ALAMBRE PúA", "BAILE INoLVIDABLE", "Chambea", "Diles", "DtMF", "Efecto", 
            "I Like It", "La CANCION", "La MuDANZA", "LO QUE LE PASO HAWAii", 
            "Me Porto Bonito", "MONACO", "NUEVAYoL", "Tití Me Preguntó", "VeLDA", "Other"
        ];

        const scrimmagePlayers = [
            "AJ Barner (SEA #88 TE)", "Cooper Kupp (SEA #10 WR)", "Demario Douglas (NE #3 WR)",
            "George Holani (SEA #36 RB)", "Hunter Henry (NE #85 TE)", "Jake Bobo (SEA #19 WR)",
            "Ja'Lynn Polk (NE #1 WR)", "Jaxon Smith-Njigba (SEA #11 WR)", "Kayshon Boutte (NE #9 WR)",
            "Kenneth Walker III (SEA #9 RB)", "Mack Hollins (NE #13 WR)", "Rashid Shaheed (SEA #22 WR)",
            "Rhamondre Stevenson (NE #38 RB)", "Stefon Diggs (NE #8 WR)", "TreVeyon Henderson (NE #32 RB)",
            "Field/Other"
        ];

        const QUESTIONS = [
            { id: 1, q: "How long will Charlie Puth's singing of the national anthem last?", note: "Start: First vocal utterance (e.g., 'Oh'). Stop: Conclusion of the first vocalization of the word 'Brave'.", options: [{ text: "Over 119.5 Seconds (1:59.5)", points: 1 }, { text: "Under 119.5 Seconds (1:59.5)", points: 1 }] },
            { id: 2, q: "Will the result of the coin toss be heads or tails?", options: [{ text: "Heads", points: 1 }, { text: "Tails", points: 1 }] },
            { id: 3, q: "Will the opening kickoff result in a touchback?", options: [{ text: "Yes", points: 1 }, { text: "No", points: 3 }] },
            { id: 4, q: "What will be the first offensive play of the game?", note: "Plays nullified by penalties do not count.", options: [{ text: "Run", points: 1 }, { text: "Pass or Sack", points: 1 }] },
            { id: 5, q: "How many yards will the first rushing attempt of the game gain?", options: [{ text: "Over 3.5 Yards", points: 1 }, { text: "Under 3.5 Yards", points: 1 }] },
            { id: 6, q: "How many yards will the first completed pass of the game gain?", options: [{ text: "Over 7.5 Yards", points: 1 }, { text: "Under 7.5 Yards", points: 1 }] },
            { id: 7, q: "What will be the jersey number of the player credited with the game’s first points?", note: "Includes a touchdown, field goal, or safety. A \"team safety\" results in a push (0 pts).", options: [{ text: "Over 10.5", points: 1 }, { text: "Under 10.5", points: 1 }] },
            { id: 8, q: "Which commercial brand will air first after the opening kickoff?", options: [{ text: "Liquid Death (Water)", points: 1 }, { text: "Dove (Soap)", points: 1 }] },
            { id: 9, q: "Which person will be shown on the broadcast first after the opening kickoff?", options: [{ text: "Robert Kraft (Patriots Owner)", points: 1 }, { text: "Jody Allen (Seahawks Chair)", points: 2 }] },
            { id: 10, q: "What will be the first accepted penalty called in the game?", note: "Offset or declined penalties do not count; only the first fully accepted penalty applies.", options: [{ text: "Holding", points: 2 }, { text: "Any Other Penalty", points: 1 }] },
            { id: 11, q: "Which team will score first?", options: [{ text: "New England Patriots", points: 2 }, { text: "Seattle Seahawks", points: 1 }] },
            { id: 12, q: "Which player will record a run for a first down prior to the other player doing so?", note: "If neither player records a rushing first down, this bet results in a push (0 pts).", options: [{ text: "Rhamondre Stevenson (NE #38 RB)", points: 1 }, { text: "Kenneth Walker III (SEA #9 RB)", points: 1 }] },
            { id: 13, q: "Will the total score after the first quarter be an even or odd number?", options: [{ text: "Even", points: 1 }, { text: "Odd", points: 1 }] },
            { id: 14, q: "Which event will happen first?", options: [{ text: "Touchdown", points: 1 }, { text: "Sack", points: 1 }] },
            { id: 15, q: "What will be the first turnover of the game?", note: "If the game ends with zero turnovers, this bet results in a push (0 pts).", options: [{ text: "Interception", points: 1 }, { text: "Fumble", points: 1 }] },
            { id: 16, q: "Will the first touchdown be a run or a pass?", note: "If no touchdowns are scored in the game, this bet results in a push (0 pts).", options: [{ text: "Run", points: 1 }, { text: "Pass", points: 1 }] },
            { id: 17, q: "Which team’s quarterback on the official depth chart will be the first to record a rush for positive yardage?", note: "If neither quarterback records a positive rush, this bet results in a push (0 pts).", options: [{ text: "Drake Maye (#10) or NE Backups", points: 1 }, { text: "Sam Darnold (#14) or SEA Backups", points: 2 }] },
            { id: 18, q: "Will the total combined score at halftime be an even or odd number?", options: [{ text: "Even", points: 1 }, { text: "Odd", points: 1 }] },
            { id: 19, q: "Will the Super Bowl Halftime Lead be greater than the Puppy Bowl margin of victory?", note: `Puppy Bowl scores since 2018 suggest editors manipulate footage for a tight margin (avg ~4 pts). The broadcast runs from ${puppyTimeRange} on Animal Planet, Discovery, TBS, truTV, and Max. The score is usually posted to X/Twitter shortly after.`, options: [{ text: "Yes (Super Bowl Lead is larger)", points: 1 }, { text: "No (Puppy Bowl Margin is larger or Tie)", points: 3 }] },
            { id: 20, q: "Will Bad Bunny wear a hat at any time during his halftime show performance?", options: [{ text: "Yes", points: 2 }, { text: "No", points: 1 }] },
            { id: 21, q: "Which song will be performed first during the halftime show?", options: halftimeSongs.map(song => ({ text: song, points: 3 })) },
            { id: 22, q: "Will Shakira make a guest appearance during the halftime show?", options: [{ text: "Yes", points: 5 }, { text: "No", points: 1 }] },
            { id: 23, q: "How many times will Cardi B be pictured on the broadcast?", note: "Counts distinct shots separated by a camera cutaway between the opening kickoff and the final whistle. Includes halftime shots; excludes commercials and network promos.", options: [{ text: "Over 1.5 Times", points: 1 }, { text: "Under 1.5 Times", points: 1 }] },
            { id: 24, q: "Will Bad Bunny expose a nipple during the performance?", note: "Visibility through mesh, sheer, or see-through clothing qualifies as exposure.", options: [{ text: "Yes", points: 2 }, { text: "No", points: 1 }] },
            { id: 25, q: "Which song will be performed last during the halftime show?", options: halftimeSongs.map(song => ({ text: song, points: 3 })) },
            { id: 26, q: "How many songs will be performed during the halftime show?", options: [{ text: "Over 11.5 Songs", points: 1 }, { text: "Under 11.5 Songs", points: 1 }] },
            { id: 27, q: "Will Tony consume more than four drinks?", options: [{text: "Yes", points: 1}, {text: "No", points: 1}] },
            { id: 28, q: "Will Dan eat every soup available?", options: [{text: "Yes", points: 1}, {text: "No", points: 1}] },
            { id: 29, q: "Will Cris Collinsworth say his catchphrase 'Now here's a guy...'?", options: [{text: "Yes", points: 2}, {text: "No", points: 1}] },
            { id: 30, q: "Will an unauthorized fan interrupt the game by running onto the field?", options: [{text: "Yes", points: 4}, {text: "No", points: 1}] },
            { id: 31, q: "Will a field goal or extra point attempt hit the crossbar or an upright?", options: [{text: "Yes", points: 5}, {text: "No", points: 1}] },
            { id: 32, q: "Will the broadcast show an endzone pylon knocked down from gameplay?", options: [{text: "Yes", points: 4}, {text: "No", points: 1}] },
            { id: 33, q: "Will there be a lost fumble by either team?", options: [{text: "Yes", points: 1}, {text: "No", points: 1}] },
            { id: 34, q: "Will there be an accepted facemask penalty?", note: "Offset or declined penalties do not count; only the first fully accepted penalty applies.", options: [{text: "Yes", points: 3}, {text: "No", points: 1}] },
            { id: 35, q: "Will there be a successful two-point conversion attempt?", options: [{text: "Yes", points: 3}, {text: "No", points: 1}] },
            { id: 36, q: "Will there be a missed extra point kick?", options: [{text: "Yes", points: 4}, {text: "No", points: 1}] },
            { id: 37, q: "Will there be a safety scored?", options: [{text: "Yes", points: 10}, {text: "No", points: 1}] },
            { id: 38, q: "Will there be a defensive or special teams touchdown?", options: [{text: "Yes", points: 3}, {text: "No", points: 1}] },
            { id: 39, q: "Will the total score after the third quarter be an even or odd number?", options: [{text: "Even", points: 1}, {text: "Odd", points: 1}] },
            { id: 40, q: "Will either team ever have exactly the same number of points that the WM Phoenix Open winner finishes under par?", options: [{text: "Yes", points: 1}, {text: "No", points: 1}] },
            { id: 41, q: "How many rushing yards will Drake Maye (NE #10 QB) record?", options: [{text: "Over 30.5 Yards", points: 1}, {text: "Under 30.5 Yards", points: 1}] },
            { id: 42, q: "How many receiving yards will Jaxon Smith-Njigba (SEA #11 WR) record?", options: [{text: "Over 93.5 Yards", points: 1}, {text: "Under 93.5 Yards", points: 1}] },
            { id: 43, q: "What will be the total yardage of all made field goals?", options: [{text: "Over 133.5 Yards", points: 1}, {text: "Under 133.5 Yards", points: 1}] },
            { id: 44, q: "What will be the total number of sacks recorded?", note: "Sacks during 2-point conversion attempts do not count toward this total.", options: [{text: "Over 5.5 Sacks", points: 1}, {text: "Under 5.5 Sacks", points: 1}] },
            { id: 45, q: "What will be the total number of turnovers?", options: [{text: "Over 2.5 Turnovers", points: 1}, {text: "Under 2.5 Turnovers", points: 1}] },
            { id: 46, q: "What will be the total combined points scored?", options: [{text: "Over 45.5 Points", points: 1}, {text: "Under 45.5 Points", points: 1}] },
            { id: 47, q: "How many players will complete a pass?", note: "Passes completed during 2-point conversion attempts do not count toward this total.", options: [{text: "Over 2.5 Players", points: 1}, {text: "Under 2.5 Players", points: 1}] },
            { id: 48, q: "Will both team lead outright during the fourth quarter?", options: [{text: "Yes", points: 3}, {text: "No", points: 1}] },
            { id: 49, q: "Will the game be tied at any point after 0-0?", options: [{text: "Yes", points: 1}, {text: "No", points: 2}] },
            { id: 50, q: "Will the team that scores first win the game?", options: [{text: "Yes", points: 1}, {text: "No", points: 2}] },
            { id: 51, q: "Will the team that scores last win the game?", options: [{text: "Yes", points: 1}, {text: "No", points: 2}] },
            { id: 52, q: "Will the game go to overtime?", options: [{text: "Yes", points: 9}, {text: "No", points: 1}] },
            { id: 53, q: "Who will have more total receiving yards?", options: [{text: "Stefon Diggs (NE #8 WR)", points: 1}, {text: "Jaxon Smith-Njigba (SEA #11 WR)", points: 1}] },
            { id: 54, q: "Which team will score the longest touchdown?", note: "Applies to any touchdown scored via offense, defense, or special teams return.", options: [{text: "New England Patriots", points: 1}, {text: "Seattle Seahawks", points: 1}] },
            { id: 55, q: "Which player will record the longest play from scrimmage?", note: "Includes rushing and receiving plays from scrimmage only; special teams and defensive returns do not count.", options: scrimmagePlayers.map(p => ({ text: p, points: 8 })) },
            { id: 56, q: "Will the game end with a kneel by any player?", options: [{text: "Yes", points: 1}, {text: "No", points: 2}] },
            { id: 57, q: "Will the final total score be an even or odd number?", options: [{text: "Even", points: 1}, {text: "Odd", points: 1}] },
            { id: 58, q: "What color Gatorade will be poured on the winning coach? (5 pts)", options: [{text: "Lime / Yellow / Green", points: 5}, {text: "Orange", points: 5}, {text: "Blue", points: 5}, {text: "Red / Pink", points: 5}, {text: "Purple", points: 5}, {text: "Clear / Water / None", points: 5}] },
            { id: 59, q: "Will the Super Bowl MVP be the winning quarterback?", options: [{text: "Yes", points: 1}, {text: "No", points: 3}] },
            { id: 60, q: "What will be the exact final score? (60 pts)", type: 'score', options: [] }
        ];

        // --- CONSTANTS MOVED OUTSIDE COMPONENT FOR STABILITY ---
        const DEFAULT_GOLF_CONFIG = { 
            useAuto: true,
            useProxy: false, 
            eventId: '401811931', 
            customText: '' 
        };

        const DEFAULT_PUBLIC_NOTES = { nfl: true, golf: true, puppy: true, hidden: [] };
        
        const DEFAULT_PAYMENT = { methodName: 'Venmo', identifier: '@Joey_Novak', fee: 10, note: '' };

        const DEFAULT_RULES = { 
            payouts: "1st Place: 100%", 
            ties: "Ties split the pot.",
            lateHeader: "Late Entries & Forfeiture",
            late: "Entries submitted after the National Anthem require Admin approval via a Late Key. Questions with outcomes determined prior to submission are subject to forfeiture.",
            goodLuck: "Good Luck To All Participants!",
            disclaimer: "Rules and payouts subject to change. Check back here for official updates."
        };

        // --- TIME HELPER ---
        const getLocalPuppyTime = () => {
            try {
                const start = new Date("2026-02-08T13:00:00-06:00");
                const end = new Date("2026-02-08T16:00:00-06:00");
                if (isNaN(start.getTime())) return "1-4pm CT";
                const opts = { hour: 'numeric', minute: 'numeric' };
                const tz = new Intl.DateTimeFormat(undefined, { timeZoneName: 'short' }).formatToParts(start).find(p => p.type === 'timeZoneName')?.value || "";
                return `${start.toLocaleTimeString([], opts)}-${end.toLocaleTimeString([], opts)} ${tz}`;
            } catch (e) { return "1-4pm CT"; }
        };
        const puppyTimeRange = getLocalPuppyTime();

        // --- MOCK DATA GENERATOR ---
        const generateMockGame = (scenario = 'midgame') => {
            const isFinal = scenario === 'final' || scenario === 'overtime';
            const period = scenario === 'pre' ? 0 : (scenario === 'final' ? 4 : (scenario === 'overtime' ? 5 : 2));
            const neScore = scenario === 'pre' ? 0 : (scenario === 'midgame' ? 7 : 24);
            const seaScore = scenario === 'pre' ? 0 : (scenario === 'midgame' ? 3 : 21);
            
            const mock = {
                header: {
                    competitions: [{
                        status: { 
                            type: { completed: isFinal, state: isFinal ? 'post' : (scenario === 'pre' ? 'pre' : 'in'), description: isFinal ? 'Final' : (scenario === 'pre' ? 'Scheduled' : '2nd Quarter') },
                            period: period 
                        },
                        competitors: [
                            { team: { abbreviation: "NE", id: "17", name: "Patriots" }, score: String(neScore), homeAway: "home", linescores: [{ displayValue: "0" }, { displayValue: String(neScore) }] },
                            { team: { abbreviation: "SEA", id: "26", name: "Seahawks" }, score: String(seaScore), homeAway: "away", linescores: [{ displayValue: "3" }, { displayValue: String(seaScore - 3 > 0 ? seaScore - 3 : 0) }] }
                        ]
                    }]
                },
                scoringPlays: [],
                boxscore: {
                    teams: [
                        { team: { abbreviation: "SEA" }, statistics: [{ name: "turnovers", displayValue: "0" }, { name: "sacksYardsLost", displayValue: "2-12" }, { name: "fumblesLost", displayValue: "0" }, { name: "interceptions", displayValue: "0" }] },
                        { team: { abbreviation: "NE" }, statistics: [{ name: "turnovers", displayValue: "1" }, { name: "sacksYardsLost", displayValue: "1-8" }, { name: "fumblesLost", displayValue: "1" }, { name: "interceptions", displayValue: "0" }] }
                    ],
                    players: [
                        { team: { abbreviation: "SEA" }, statistics: [
                            { name: "passing", keys: ["completions/passingAttempts"], athletes: [{ athlete: { shortName: "S.Darnold", displayName: "Sam Darnold", position: { abbreviation: "QB" } }, stats: ["8/15"] }] },
                            { name: "rushing", keys: ["rushingYards", "longRushing"], athletes: [{ athlete: { shortName: "K.Walker", displayName: "Kenneth Walker III" }, stats: ["50", "18"] }] },
                            { name: "receiving", keys: ["receivingYards", "longReception"], athletes: [{ athlete: { shortName: "J.Smith-Njigba", displayName: "Jaxon Smith-Njigba" }, stats: ["42", "16"] }] }
                        ]},
                        { team: { abbreviation: "NE" }, statistics: [
                            { name: "passing", keys: ["completions/passingAttempts"], athletes: [{ athlete: { shortName: "D.Maye", displayName: "Drake Maye", position: { abbreviation: "QB" } }, stats: ["10/12"] }] },
                            { name: "rushing", keys: ["rushingYards", "longRushing"], athletes: [{ athlete: { shortName: "R.Stevenson", displayName: "Rhamondre Stevenson" }, stats: ["45", "12"] }, { athlete: { shortName: "D.Maye", displayName: "Drake Maye", position: { abbreviation: "QB" } }, stats: ["15", "8"] }] },
                            { name: "receiving", keys: ["receivingYards", "longReception"], athletes: [{ athlete: { shortName: "S.Diggs", displayName: "Stefon Diggs" }, stats: ["55", "25"] }] }
                        ]}
                    ]
                },
                drives: { previous: [{ plays: [] }] }
            };

            if (scenario !== 'pre') {
                mock.scoringPlays = [
                    { type: { abbreviation: "FG", text: "Field Goal Good" }, text: "Jason Myers 45 Yd Field Goal", team: { abbreviation: "SEA", id: "26" }, period: { number: 1 }, statYardage: 45, scoringType: { abbreviation: "FG" }, homeScore: 0, awayScore: 3 },
                    { type: { abbreviation: "TD", text: "Passing Touchdown" }, text: "D.Maye pass short left to R.Stevenson for 15 yards, TOUCHDOWN.", team: { abbreviation: "NE", id: "17" }, period: { number: 2 }, statYardage: 15, scoringType: { abbreviation: "TD", name: "touchdown" }, homeScore: 6, awayScore: 3 }
                ];
                
                mock.drives.previous[0].plays = [
                    { sequenceNumber: "100", type: { abbreviation: "K", text: "Kickoff" }, text: "J.Myers kicks 65 yards to end zone, Touchback.", team: { id: "26" } },
                    { sequenceNumber: "200", type: { text: "Rush", id: "5" }, text: "K.Walker right end to SEA 47 for 12 yards.", statYardage: 12, start: { distance: 10, team: { id: "26" } }, team: { id: "26" } },
                    { sequenceNumber: "350", type: { text: "Sack", id: "7" }, text: "S.Darnold sacked at SEA 40 for -7 yards.", statYardage: -7, team: { id: "26" } },
                    { sequenceNumber: "450", type: { text: "Pass Reception", id: "24" }, text: "(Shotgun) D.Maye pass deep middle to S.Diggs for 25 yards.", statYardage: 25, team: { id: "17" }, start: { team: { id: "17" } } }
                ];
            }
            return mock;
        };

        // --- SHARED FETCH HELPERS ---
        const fetchNFLFromSource = async (nflGameId) => {
            if (!nflGameId) return null;
            const targetUrl = `https://site.web.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${nflGameId}&_t=${Date.now()}`;
            const proxies = [
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`,
                `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`
            ];
            
            for (const proxy of proxies) {
                try {
                    const res = await fetch(proxy);
                    if (res.ok) return await res.json();
                } catch(e) {}
            }
            return null;
        };

        const fetchGolfFromSource = async (golfConfig) => {
            if (!golfConfig?.useAuto || !golfConfig?.eventId) return null;
            const targetUrl = `https://site.web.api.espn.com/apis/site/v2/sports/golf/leaderboard?league=pga&event=${golfConfig.eventId}&_t=${Date.now()}`;
            const fetchUrl = golfConfig.useProxy ? `https://corsproxy.io/?${encodeURIComponent(targetUrl)}` : targetUrl;
            
            try {
                const res = await fetch(fetchUrl);
                if (res.ok) return await res.json();
            } catch(e) {}
            return null;
        };

        // --- HOOKS ---
        
        // 1. DataBroadcaster Component (Only for Admin)
        const DataBroadcaster = ({ db, appId, nflGameId, golfConfig, user }) => {
            const lastWritten = useRef({ nfl: '', golf: '' });

            useEffect(() => {
                if (!db || !appId || !user) return;
                
                const broadcast = async () => {
                    if (!navigator.onLine) return; // Prevent queuing writes if offline

                    const timestamp = Date.now();
                    
                    // NFL Broadcast
                    const nflData = await fetchNFLFromSource(nflGameId);
                    if (nflData) {
                        const nflStr = JSON.stringify(nflData);
                        // Only write if data has changed to save bandwidth/writes
                        if (nflStr !== lastWritten.current.nfl) {
                            const { doc, setDoc } = window.firebaseModules;
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'live_feeds', 'nfl'), { data: nflData, lastUpdated: timestamp })
                                .catch(e => console.warn("NFL Broadcast write failed", e));
                            lastWritten.current.nfl = nflStr;
                        }
                    }
                    
                    // Golf Broadcast
                    const golfData = await fetchGolfFromSource(golfConfig);
                    if (golfData) {
                        const golfStr = JSON.stringify(golfData);
                        if (golfStr !== lastWritten.current.golf) {
                            const { doc, setDoc } = window.firebaseModules;
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'live_feeds', 'golf'), { data: golfData, lastUpdated: timestamp })
                                .catch(e => console.warn("Golf Broadcast write failed", e));
                            lastWritten.current.golf = golfStr;
                        }
                    }
                };

                broadcast();
                const interval = setInterval(broadcast, 60000); // Increased to 60s
                return () => clearInterval(interval);
            }, [db, appId, nflGameId, golfConfig, user]);

            return null; 
        };

        // 2. Generic Live Feed Hook (Consolidated Logic)
        const useLiveFeed = (feedId, options = {}) => {
            const { 
                isEnabled = true, 
                fetchFn, 
                processFn, 
                db, 
                appId, 
                disableFallback 
            } = options;

            const [state, setState] = useState({
                data: null,
                meta: null, // For aux data (like roundStatus)
                status: 'idle',
                isFallbackActive: false
            });

            useEffect(() => {
                if (!isEnabled || !db || !appId) {
                    setState(s => ({ ...s, status: 'idle', data: null, meta: null }));
                    return;
                }

                setState(s => ({ ...s, status: 'loading' }));
                
                const { doc, onSnapshot, setDoc } = window.firebaseModules;
                let lastDataTimestamp = 0;

                // 1. Listen
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'live_feeds', feedId), (snap) => {
                    if (snap.exists()) {
                        const payload = snap.data();
                        lastDataTimestamp = payload.lastUpdated || 0;
                        
                        // Process if needed, or pass through
                        const result = processFn ? processFn(payload.data) : { data: payload.data };
                        
                        setState({
                            data: result.data,
                            meta: result.meta,
                            status: 'success',
                            isFallbackActive: false
                        });
                    }
                }, (err) => {
                    console.warn(`Feed ${feedId} error:`, err);
                    setState(s => ({ ...s, status: 'error' }));
                });

                // 2. Fallback Interval
                const checkInterval = setInterval(async () => {
                    if (disableFallback || !navigator.onLine || !fetchFn) return;

                    const now = Date.now();
                    // If data is older than 90s, try to fetch directly
                    if (now - lastDataTimestamp > 90000) {
                        setState(s => ({ ...s, isFallbackActive: true }));
                        
                        // Jitter (0-15s) to prevent thundering herd
                        await new Promise(r => setTimeout(r, Math.random() * 15000));
                        
                        const freshData = await fetchFn();
                        if (freshData) {
                            const result = processFn ? processFn(freshData) : { data: freshData };
                            
                            // Optimistic update
                            setState({
                                data: result.data,
                                meta: result.meta,
                                status: 'success',
                                isFallbackActive: true
                            });

                            // Try broadcast (Best Effort)
                            try {
                                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'live_feeds', feedId), { 
                                    data: freshData, 
                                    lastUpdated: Date.now() 
                                });
                            } catch(e) {}
                        }
                    }
                }, 30000);

                return () => {
                    unsub();
                    clearInterval(checkInterval);
                };
            }, [feedId, isEnabled, db, appId, disableFallback, fetchFn, processFn]);

            return state;
        };

        // 3. Updated Golf Fetcher
        const useGolfData = (config, db, appId, user, disableFallback) => {
            const fetchFn = useCallback(() => fetchGolfFromSource(config), [config]);
            
            const processFn = useCallback((json) => {
                try {
                    const event = json?.events?.[0];
                    const competition = event?.competitions?.[0];
                    const competitors = competition?.competitors || [];
                    const globalWinnerId = event?.winner?.id || competition?.winner?.id;
                    
                    const processed = competitors.map(c => {
                        const scoreStr = c.score?.displayValue || "E";
                        let scoreVal = scoreStr === "E" ? 0 : (scoreStr.startsWith("+") ? parseInt(scoreStr.substring(1)) : parseInt(scoreStr));
                        const isWinner = (globalWinnerId && String(c.id) === String(globalWinnerId)) || c.winner === true;
                        
                        let displayStatus = c.status?.displayValue || "F";
                        const athleteState = c.status?.type?.state;
                        const teeTimeStr = c.status?.teeTime || "";
                        const teeTimeVal = teeTimeStr ? new Date(teeTimeStr).getTime() : 0;

                        if (athleteState === 'pre' && teeTimeVal > 0) {
                            const dateObj = new Date(teeTimeVal);
                            displayStatus = dateObj.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                        }

                        let holes = 0;
                        if (displayStatus === "F" || displayStatus === "Final" || c.status?.type?.completed) holes = 18;
                        else if (typeof displayStatus === 'string' && displayStatus.includes("Thru")) holes = parseInt(displayStatus.replace("Thru", "").trim()) || 0;
                        
                        return { name: c.athlete?.displayName, scoreStr, scoreVal, thru: displayStatus, isWinner, holesCompleted: holes, teeTimeVal };
                    });

                    processed.sort((a, b) => {
                        if (a.isWinner && !b.isWinner) return -1;
                        if (!a.isWinner && b.isWinner) return 1;
                        if (a.scoreVal !== b.scoreVal) return a.scoreVal - b.scoreVal;
                        if (a.holesCompleted !== b.holesCompleted) return b.holesCompleted - a.holesCompleted;
                        if (a.holesCompleted === 18) return a.teeTimeVal - b.teeTimeVal;
                        return b.teeTimeVal - a.teeTimeVal; 
                    });

                    const period = competition?.status?.period;
                    const state = competition?.status?.type?.state;
                    const desc = competition?.status?.type?.description;
                    let rStr = "";
                    
                    if (state === "pre") {
                        rStr = `START: ${new Date(event.date).toLocaleDateString(undefined, {month: 'short', day: 'numeric'})}`;
                    } else if (state === "post") {
                        const hasWinnerDeclared = processed.some(p => p.isWinner);
                        if (period >= 4 || hasWinnerDeclared) {
                            rStr = "FINAL";
                        } else {
                            rStr = `END OF ROUND ${period}`;
                        }
                    } else {
                        const leaders = processed.filter(p => p.scoreVal === processed[0].scoreVal);
                        const allLeadersFinished = leaders.every(p => p.thru === "F" || p.thru === "Final");
                        const hasWinnerDeclared = processed.some(p => p.isWinner);
                        if (allLeadersFinished && leaders.length > 1 && !hasWinnerDeclared) rStr = "PLAYOFF";
                        else rStr = `ROUND ${period}`;
                    }
                    
                    if (desc && desc.toUpperCase() !== "IN PROGRESS" && desc.toUpperCase() !== "SCHEDULED" && !rStr.toUpperCase().includes(desc.toUpperCase()) && rStr !== "FINAL") {
                            rStr += ` - ${desc}`;
                    }
                    
                    return { data: processed, meta: rStr };
                } catch (e) {
                    console.error("Golf Process Error", e);
                    return { data: null, meta: "" };
                }
            }, []);

            const { data, meta, isFallbackActive, status } = useLiveFeed('golf', {
                isEnabled: config?.useAuto,
                fetchFn,
                processFn,
                db,
                appId,
                disableFallback
            });

            return { data, roundStatus: meta, isFallbackActive, error: status === 'error' ? 'Data Processing Error' : null };
        };

        // 4. Updated NFL Fetcher Hook
        const useNFLData = (gameId, db, appId, user, disableFallback) => {
            // Memoize fetchFn to prevent unnecessary re-subscriptions
            const fetchFn = useCallback(() => fetchNFLFromSource(gameId), [gameId]);
            
            const { data, status, isFallbackActive } = useLiveFeed('nfl', {
                isEnabled: !!gameId,
                fetchFn,
                // No processFn needed for NFL (identity)
                db,
                appId,
                disableFallback
            });

            return { status, rawData: data, isFallbackActive };
        };

        // --- GLOBAL HELPER FUNCTIONS (Extracted from getSuggestions) ---
        
        const getTeamAbbrev = (teamId, patsId, hawksId) => {
            if (String(teamId) === String(patsId)) return "NE";
            if (String(teamId) === String(hawksId)) return "SEA";
            return "";
        };

        const getPlayDesc = (play, patsId, hawksId) => {
            if (!play) return "";
            const qtr = play.period?.number ? `Q${play.period.number}` : "";
            const time = play.clock?.displayValue || "";
            const teamId = play.team?.id || play.start?.team?.id;
            const tm = teamId ? getTeamAbbrev(teamId, patsId, hawksId) : "";
            const tmPrefix = tm ? `${tm}: ` : "";
            return `[${qtr} ${time}] ${tmPrefix}${play.text || ""}`;
        };

        const createOverUnderSuggestion = (val, line, unit, note, isFinal) => {
            return {
                text: val > line ? `Over ${line} ${unit}` : `Under ${line} ${unit}`,
                isFinal: isFinal,
                note: note
            };
        };

        // --- SUGGESTION ENGINE ---
        const getSuggestions = (nflData, gameState, golfData, golfStatus) => {
            if (!nflData || !nflData.header || !nflData.boxscore) return {};

            const suggestions = {};
            const competitors = nflData.header.competitions[0].competitors; 
            const pats = competitors.find(c => c.team.abbreviation === 'NE' || c.team.name === 'Patriots');
            const hawks = competitors.find(c => c.team.abbreviation === 'SEA' || c.team.name === 'Seahawks');

            if (!pats || !hawks) return {}; 
            
            const patsId = pats.team.id;
            const hawksId = hawks.team.id;

            const patsScore = parseInt(pats.score) || 0;
            const hawksScore = parseInt(hawks.score) || 0;
            const totalScore = patsScore + hawksScore;
            const status = nflData.header.competitions[0].status.type;
            const isFinal = status.completed;
            const period = nflData.header.competitions[0].status.period;

            // --- BUILD CHRONOLOGICAL PLAY ARRAY ---
            let allPlays = [];
            if (nflData.drives && nflData.drives.previous) {
                nflData.drives.previous.forEach(drive => {
                    if (drive.plays) allPlays = allPlays.concat(drive.plays);
                });
                allPlays.sort((a, b) => (parseInt(a.sequenceNumber) || 0) - (parseInt(b.sequenceNumber) || 0));
            }

            // Q3: Opening Kickoff Result
            const firstKickoff = allPlays.find(p => p.type && (p.type.abbreviation === "K" || p.type.text === "Kickoff"));
            if (firstKickoff) {
                const isTouchback = (firstKickoff.text || "").toLowerCase().includes("touchback");
                suggestions[3] = {
                    text: isTouchback ? "Yes" : "No",
                    isFinal: true,
                    note: getPlayDesc(firstKickoff, patsId, hawksId)
                };
            } else {
                suggestions[3] = { text: "Waiting...", isFinal: false, note: "Opening kickoff not recorded yet" };
            }

            // Q4: First Offensive Play
            const firstOffensivePlay = allPlays.find(p => {
                const type = p.type?.text || "";
                if ((p.text || "").includes("No Play")) return false; 
                return type === "Rush" || type === "Pass Reception" || type === "Pass Incompletion" || type === "Sack";
            });
            if (firstOffensivePlay) {
                const type = firstOffensivePlay.type.text;
                suggestions[4] = {
                    text: type === "Rush" ? "Run" : "Pass or Sack",
                    isFinal: true,
                    note: getPlayDesc(firstOffensivePlay, patsId, hawksId)
                };
            } else {
                suggestions[4] = { text: "Waiting...", isFinal: false, note: "First offensive play not recorded yet" };
            }

            // Q5: First Rushing Attempt Yards
            const firstRush = allPlays.find(p => p.type?.text === "Rush" && !(p.text||"").includes("No Play"));
            if (firstRush) {
                const yds = firstRush.statYardage || 0;
                suggestions[5] = {
                    text: yds > 3.5 ? "Over 3.5 Yards" : "Under 3.5 Yards",
                    isFinal: true,
                    note: getPlayDesc(firstRush, patsId, hawksId)
                };
            } else {
                suggestions[5] = { text: "Waiting...", isFinal: false, note: "First rushing attempt not recorded yet" };
            }

            // Q6: First Completed Pass Yards
            const firstComp = allPlays.find(p => p.type?.text === "Pass Reception" && !(p.text||"").includes("No Play"));
            if (firstComp) {
                const yds = firstComp.statYardage || 0;
                suggestions[6] = {
                    text: yds > 7.5 ? "Over 7.5 Yards" : "Under 7.5 Yards",
                    isFinal: true,
                    note: getPlayDesc(firstComp, patsId, hawksId)
                };
            } else {
                suggestions[6] = { text: "Waiting...", isFinal: false, note: "First completed pass not recorded yet" };
            }

            // Q7: Jersey Number of First Scorer
            if (nflData.scoringPlays && nflData.scoringPlays.length > 0) {
                const firstScore = nflData.scoringPlays[0];
                const scoreText = firstScore.text || "";
                let matchedJersey = null;
                let matchedName = "";
                
                if (nflData.boxscore && nflData.boxscore.players) {
                    nflData.boxscore.players.forEach(teamPlayers => {
                        teamPlayers.statistics.forEach(cat => {
                            cat.athletes.forEach(a => {
                                const fullName = a.athlete.displayName;
                                const shortName = a.athlete.shortName; 
                                const noSpaceShort = shortName ? shortName.replace(" ", "") : ""; 
                                
                                if ((fullName && scoreText.includes(fullName)) || 
                                    (shortName && scoreText.includes(shortName)) || 
                                    (noSpaceShort && scoreText.includes(noSpaceShort))) {
                                    
                                    if (!matchedJersey || a.athlete.position?.abbreviation !== "QB") {
                                        matchedJersey = parseInt(a.athlete.jersey, 10);
                                        matchedName = fullName;
                                    }
                                }
                            });
                        });
                    });
                }
                
                if (matchedJersey !== null && !isNaN(matchedJersey)) {
                    suggestions[7] = {
                        text: matchedJersey > 10.5 ? "Over 10.5" : "Under 10.5",
                        isFinal: true,
                        note: `${matchedName} (#${matchedJersey}) | ${getPlayDesc(firstScore, patsId, hawksId)}`
                    };
                }
            } else {
                suggestions[7] = { text: "Waiting...", isFinal: false, note: "No scores yet" };
            }

            // Q10: First Accepted Penalty
            const firstPenalty = allPlays.find(p => p.penalty && p.penalty.status?.slug === "accepted");
            if (firstPenalty) {
                const penName = firstPenalty.penalty.type?.text || "";
                const isHolding = penName.toLowerCase().includes("holding");
                suggestions[10] = {
                    text: isHolding ? "Holding" : "Any Other Penalty",
                    isFinal: true,
                    note: getPlayDesc(firstPenalty, patsId, hawksId)
                };
            } else {
                suggestions[10] = { text: "Waiting...", isFinal: false, note: "No accepted penalties yet" };
            }

            // Q11: Which team will score first?
            if (nflData.scoringPlays && nflData.scoringPlays.length > 0) {
                const firstScore = nflData.scoringPlays[0];
                const teamAbbrev = firstScore.team?.abbreviation || firstScore.team?.shortDisplayName;
                if (teamAbbrev) {
                    const isPatriots = teamAbbrev.includes('NE') || teamAbbrev.includes('Patriots');
                    suggestions[11] = {
                        text: isPatriots ? "New England Patriots" : "Seattle Seahawks",
                        isFinal: true,
                        note: getPlayDesc(firstScore, patsId, hawksId)
                    };
                }
            } else {
                suggestions[11] = { text: "Waiting...", isFinal: false, note: "No scores yet" };
            }

            // Q12: First player to record a rushing 1st down
            let q12Winner = null;
            let q12Play = null;
            for (const play of allPlays) {
                if (play.type?.text === "Rush" && play.statYardage >= play.start?.distance && play.start?.distance > 0 && !(play.text||"").includes("No Play")) {
                    const text = play.text || "";
                    if (text.includes("R.Stevenson")) { q12Winner = "Rhamondre Stevenson (NE #38 RB)"; q12Play = play; break; }
                    if (text.includes("K.Walker")) { q12Winner = "Kenneth Walker III (SEA #9 RB)"; q12Play = play; break; }
                }
            }
            if (q12Winner) {
                suggestions[12] = { text: q12Winner, isFinal: true, note: getPlayDesc(q12Play, patsId, hawksId) };
            } else {
                suggestions[12] = { text: "Waiting...", isFinal: false, note: "No rushing 1st downs by Walker/Stevenson yet" };
            }

            // Q13 & Q18 & Q39: Quarter Totals
            const getPeriodScore = (team, periodIndex) => {
                if (team.linescores && team.linescores.length > periodIndex) {
                    return parseInt(team.linescores[periodIndex].displayValue) || 0;
                }
                return 0;
            };

            const p1p = getPeriodScore(pats, 0);
            const p1h = getPeriodScore(hawks, 0);
            const p2p = getPeriodScore(pats, 1);
            const p2h = getPeriodScore(hawks, 1);
            const p3p = getPeriodScore(pats, 2);
            const p3h = getPeriodScore(hawks, 2);
            
            const q1Total = p1p + p1h;
            const halfTotal = p1p + p1h + p2p + p2h;
            const q3Total = halfTotal + p3p + p3h;

            // Helper: Get Game Status Text (e.g. "Mid Q2", "End of Q1", "Final")
            const compStatus = nflData.header.competitions[0].status;
            let statusDetail = compStatus.type?.shortDetail || compStatus.type?.description;
            if (!statusDetail) {
                if (compStatus.type?.state === 'pre') statusDetail = "Pre-Game";
                else if (compStatus.type?.completed) statusDetail = "Final";
                else statusDetail = `Mid Q${compStatus.period}`; // Fallback
            }

            // Q13: 1st Quarter Total
            const isQ1Final = period > 1 || isFinal;
            let q1Note = `Q1 Not Started`;
            if (isQ1Final) {
                q1Note = `Final Q1 Total: ${q1Total} | NE: ${p1p}, SEA: ${p1h}`;
            } else if (period === 1) {
                q1Note = `Current ${statusDetail} Total: ${q1Total} | NE: ${p1p}, SEA: ${p1h}`;
            }

            suggestions[13] = {
                text: q1Total % 2 === 0 ? "Even" : "Odd",
                isFinal: isQ1Final,
                note: q1Note
            };

            // Q18: Halftime Total
            const isHalfFinal = period > 2 || isFinal;
            let halfNote = "";
            if (isHalfFinal) {
                halfNote = `Final Halftime Total: ${halfTotal} | NE: ${p1p+p2p}, SEA: ${p1h+p2h}`;
            } else if (period < 2) {
                halfNote = `Q2 Not Started, Current ${statusDetail} Total: ${totalScore} | NE: ${patsScore}, SEA: ${hawksScore}`;
            } else {
                halfNote = `Current ${statusDetail} Total: ${halfTotal} | NE: ${p1p+p2p}, SEA: ${p1h+p2h}`;
            }

            suggestions[18] = {
                text: halfTotal % 2 === 0 ? "Even" : "Odd",
                isFinal: isHalfFinal,
                note: halfNote
            };

            // Q39: 3rd Quarter Total
            const isQ3Final = period > 3 || isFinal;
            let q3Note = "";
            if (isQ3Final) {
                q3Note = `Final Q3 Total: ${q3Total} | NE: ${p1p+p2p+p3p}, SEA: ${p1h+p2h+p3h}`;
            } else if (period < 3) {
                q3Note = `Q3 Not Started, Current ${statusDetail} Total: ${totalScore} | NE: ${patsScore}, SEA: ${hawksScore}`;
            } else {
                q3Note = `Current ${statusDetail} Total: ${q3Total} | NE: ${p1p+p2p+p3p}, SEA: ${p1h+p2h+p3h}`;
            }

            suggestions[39] = {
                text: q3Total % 2 === 0 ? "Even" : "Odd",
                isFinal: isQ3Final,
                note: q3Note
            };

            // Q14: Touchdown or Sack first?
            let q14Winner = null;
            let q14Play = null;
            for (const play of allPlays) {
                if ((play.text || "").includes("No Play")) continue;
                const isSack = play.type?.text === "Sack" || play.type?.id === "7" || (play.text || "").includes("sacked");
                const isTD = play.scoringType?.abbreviation === "TD" || play.type?.abbreviation === "TD" || (play.text || "").includes("TOUCHDOWN");
                if (isTD) { q14Winner = "Touchdown"; q14Play = play; break; }
                if (isSack) { q14Winner = "Sack"; q14Play = play; break; }
            }
            if (q14Winner) {
                suggestions[14] = { text: q14Winner, isFinal: true, note: getPlayDesc(q14Play, patsId, hawksId) };
            } else {
                suggestions[14] = { text: "Waiting...", isFinal: false, note: "No TDs or Sacks recorded yet" };
            }

            // Q15: First Turnover (INT vs Fumble)
            let q15Winner = null;
            let q15Play = null;
            for (const play of allPlays) {
                if (play.isTurnover && !(play.text || "").includes("No Play")) {
                    const text = (play.text || "").toLowerCase();
                    const type = (play.type?.text || "").toLowerCase();
                    if (text.includes("intercepted") || type.includes("interception")) {
                        q15Winner = "Interception"; q15Play = play; break;
                    } else if (text.includes("fumble") || type.includes("fumble")) {
                        q15Winner = "Fumble"; q15Play = play; break;
                    }
                }
            }
            if (q15Winner) {
                suggestions[15] = { text: q15Winner, isFinal: true, note: getPlayDesc(q15Play, patsId, hawksId) };
            } else {
                suggestions[15] = { text: "Waiting...", isFinal: false, note: "No turnovers recorded yet" };
            }

            // Q16: First TD (Run or Pass)
            let q16Winner = null;
            let q16Play = null;
            for (const play of allPlays) {
                if ((play.text || "").includes("No Play")) continue;
                const isTD = play.scoringType?.abbreviation === "TD" || play.type?.abbreviation === "TD" || (play.text || "").includes("TOUCHDOWN");
                if (isTD) {
                    const type = (play.type?.text || "").toLowerCase();
                    const text = (play.text || "").toLowerCase();
                    if (type.includes("pass") || text.includes(" pass ") || text.includes(" passed ")) {
                        q16Winner = "Pass"; q16Play = play; break;
                    } else if (type.includes("rush") || text.includes(" rush") || text.includes(" scrambles") || text.includes(" up the middle") || text.includes(" left end") || text.includes(" right end") || text.includes(" left tackle") || text.includes(" right tackle") || text.includes(" left guard") || text.includes(" right guard")) {
                        q16Winner = "Run"; q16Play = play; break;
                    }
                }
            }
            if (q16Winner) {
                suggestions[16] = { text: q16Winner, isFinal: true, note: getPlayDesc(q16Play, patsId, hawksId) };
            } else {
                suggestions[16] = { text: "Waiting...", isFinal: false, note: "No touchdowns recorded yet" };
            }

            // Q17: First QB to record a positive rush
            const qbIdentifiers = new Set();
            if (nflData.boxscore && nflData.boxscore.players) {
                nflData.boxscore.players.forEach(teamData => {
                    teamData.statistics.forEach(statBlock => {
                        statBlock.athletes.forEach(a => {
                            if (a.athlete?.position?.abbreviation === "QB") {
                                if (a.athlete.shortName) qbIdentifiers.add(a.athlete.shortName.replace(" ", ""));
                                if (a.athlete.lastName) qbIdentifiers.add(a.athlete.lastName);
                            }
                        });
                    });
                });
            }
            qbIdentifiers.add("D.Maye"); qbIdentifiers.add("S.Darnold"); 
            qbIdentifiers.add("J.Brissett"); qbIdentifiers.add("G.Smith");

            let q17Winner = null;
            for (const play of allPlays) {
                if (!(play.text || "").includes("No Play") && play.statYardage > 0) {
                    const type = (play.type?.text || "").toLowerCase();
                    const text = play.text || "";
                    if (type === "rush" || text.toLowerCase().includes("scrambles")) {
                        const cleanText = text.replace("(Shotgun) ", "").replace("(No Huddle, Shotgun) ", "").replace("(No Huddle) ", "");
                        
                        let isQB = false;
                        for (const qb of qbIdentifiers) {
                            if (cleanText.startsWith(qb)) {
                                isQB = true;
                                break;
                            }
                        }

                        if (isQB) {
                            const teamId = play.start?.team?.id;
                            if (teamId === pats.team.id) {
                                q17Winner = "Drake Maye (#10) or NE Backups";
                            } else if (teamId === hawks.team.id) {
                                q17Winner = "Sam Darnold (#14) or SEA Backups";
                            } else {
                                if (text.includes("Maye") || text.includes("Brissett")) q17Winner = "Drake Maye (#10) or NE Backups";
                                if (text.includes("Darnold") || text.includes("Smith")) q17Winner = "Sam Darnold (#14) or SEA Backups";
                            }
                            
                            if (q17Winner) {
                                suggestions[17] = { text: q17Winner, isFinal: true, note: getPlayDesc(play, patsId, hawksId) };
                                break;
                            }
                        }
                    }
                }
            }
            if (!q17Winner) {
                suggestions[17] = { text: "Waiting...", isFinal: false, note: "No positive QB rushes yet" };
            }

            // Q19: Puppy Bowl Margin
            if (gameState?.puppyBowl && (gameState.puppyBowl.fluff > 0 || gameState.puppyBowl.ruff > 0)) {
                const fluff = parseInt(gameState.puppyBowl.fluff) || 0;
                const ruff = parseInt(gameState.puppyBowl.ruff) || 0;
                const puppyMargin = Math.abs(fluff - ruff);
                if (period > 2 || isFinal) {
                    const halfLead = Math.abs((p1p + p2p) - (p1h + p2h));
                    suggestions[19] = {
                        text: halfLead > puppyMargin ? "Yes (Super Bowl Lead is larger)" : "No (Puppy Bowl Margin is larger or Tie)",
                        isFinal: true,
                        note: `SB Half Lead: ${halfLead} | Puppy Margin: ${puppyMargin}`
                    };
                }
            }

            // Q33-Q38: Fumbles, Penalties, XPs, Safeties, Defensive TDs, 2PTs
            const fumblesLost = allPlays.filter(p => p.isTurnover && (p.text||"").toLowerCase().includes("fumble"));
            if (fumblesLost.length > 0) {
                suggestions[33] = { text: "Yes", isFinal: true, note: `${fumblesLost.length > 1 ? `${fumblesLost.length} Lost Fumbles. First: ` : ''}${getPlayDesc(fumblesLost[0], patsId, hawksId)}` };
            } else {
                suggestions[33] = { text: "No", isFinal: isFinal, note: "0 lost fumbles recorded" };
            }

            const facemasks = allPlays.filter(p => p.penalty?.status?.slug === "accepted" && p.penalty?.type?.text?.toLowerCase().includes("facemask"));
            if (facemasks.length > 0) {
                suggestions[34] = { text: "Yes", isFinal: true, note: `${facemasks.length > 1 ? `${facemasks.length} Facemasks. First: ` : ''}${getPlayDesc(facemasks[0], patsId, hawksId)}` };
            } else {
                suggestions[34] = { text: "No", isFinal: isFinal, note: "No accepted facemasks" };
            }

            const twoPts = allPlays.filter(p => p.text?.includes("TWO-POINT") && (p.text?.includes("SUCCEEDS") || p.text?.includes("is GOOD")));
            if (twoPts.length > 0) {
                suggestions[35] = { text: "Yes", isFinal: true, note: `${twoPts.length > 1 ? `${twoPts.length} 2PT Conversions. First: ` : ''}${getPlayDesc(twoPts[0], patsId, hawksId)}` };
            } else {
                suggestions[35] = { text: "No", isFinal: isFinal, note: "No successful 2PT conversions" };
            }

            const missedXPs = allPlays.filter(p => p.type?.text === "Extra Point Missed" || p.type?.text === "Extra Point Blocked" || (p.text||"").includes("extra point is No Good") || (p.text||"").includes("extra point is Blocked"));
            if (missedXPs.length > 0) {
                suggestions[36] = { text: "Yes", isFinal: true, note: `${missedXPs.length > 1 ? `${missedXPs.length} Missed XPs. First: ` : ''}${getPlayDesc(missedXPs[0], patsId, hawksId)}` };
            } else {
                suggestions[36] = { text: "No", isFinal: isFinal, note: "No missed XPs" };
            }

            const safeties = (nflData.scoringPlays || []).filter(p => p.type?.abbreviation === "SAF" || p.scoringType?.abbreviation === "SAF" || p.scoringType?.name === "safety");
            if (safeties.length > 0) {
                suggestions[37] = { text: "Yes", isFinal: true, note: `${safeties.length > 1 ? `${safeties.length} Safeties. First: ` : ''}${getPlayDesc(safeties[0], patsId, hawksId)}` };
            } else {
                suggestions[37] = { text: "No", isFinal: isFinal, note: "No safeties" };
            }

            const defSTTds = (nflData.scoringPlays || []).filter(p => {
                const tText = (p.type?.text || "").toLowerCase();
                return tText.includes("interception return") || tText.includes("fumble return") || tText.includes("kickoff return") || tText.includes("punt return") || tText.includes("blocked");
            });
            if (defSTTds.length > 0) {
                suggestions[38] = { text: "Yes", isFinal: true, note: `${defSTTds.length > 1 ? `${defSTTds.length} Def/ST TDs. First: ` : ''}${getPlayDesc(defSTTds[0], patsId, hawksId)}` };
            } else {
                suggestions[38] = { text: "No", isFinal: isFinal, note: "No Def/ST TDs" };
            }

            // Q40: WM Phoenix Open Tie
            if (golfData && golfData.length > 0) {
                const leaderScoreVal = golfData[0].scoreVal; 
                if (leaderScoreVal < 0) {
                    const underPar = Math.abs(leaderScoreVal);
                    let neHit = false;
                    let seaHit = false;
                    let neSkipText = "";
                    let seaSkipText = "";
                    let currentPats = 0;
                    let currentHawks = 0;

                    const isPatsHome = nflData.header.competitions[0].competitors.find(c => c.homeAway === 'home').team.id === pats.team.id;

                    if (nflData.scoringPlays) {
                        nflData.scoringPlays.forEach(play => {
                            const playAwayScore = parseInt(play.awayScore) || 0;
                            const playHomeScore = parseInt(play.homeScore) || 0;

                            const nextPats = isPatsHome ? playHomeScore : playAwayScore;
                            const nextHawks = isPatsHome ? playAwayScore : playHomeScore;

                            if (play.scoringType && (play.scoringType.abbreviation === "TD" || play.scoringType.name === "touchdown")) {
                                if (play.team?.id === pats.team.id) {
                                    const intScore = currentPats + 6;
                                    if (intScore === underPar) neHit = true;
                                    if (!neHit && currentPats < underPar && intScore > underPar) {
                                        neSkipText = `Skipped (${currentPats} to ${intScore})`;
                                    } else if (!neHit && intScore < underPar && nextPats > underPar) {
                                        neSkipText = `Skipped (${intScore} to ${nextPats})`;
                                    }
                                } else if (play.team?.id === hawks.team.id) {
                                    const intScore = currentHawks + 6;
                                    if (intScore === underPar) seaHit = true;
                                    if (!seaHit && currentHawks < underPar && intScore > underPar) {
                                        seaSkipText = `Skipped (${currentHawks} to ${intScore})`;
                                    } else if (!seaHit && intScore < underPar && nextHawks > underPar) {
                                        seaSkipText = `Skipped (${intScore} to ${nextHawks})`;
                                    }
                                }
                            } else {
                                if (!neHit && currentPats < underPar && nextPats > underPar) {
                                    neSkipText = `Skipped (${currentPats} to ${nextPats})`;
                                }
                                if (!seaHit && currentHawks < underPar && nextHawks > underPar) {
                                    seaSkipText = `Skipped (${currentHawks} to ${nextHawks})`;
                                }
                            }

                            if (nextPats === underPar) neHit = true;
                            if (nextHawks === underPar) seaHit = true;

                            currentPats = nextPats;
                            currentHawks = nextHawks;
                        });
                    }
                    
                    const hitGolfScore = neHit || seaHit;
                    const neStatus = neHit ? "Hit" : (patsScore < underPar ? "Hasn't reached" : (neSkipText || "Skipped"));
                    const seaStatus = seaHit ? "Hit" : (hawksScore < underPar ? "Hasn't reached" : (seaSkipText || "Skipped"));
                    
                    // Logic check: If playoff or final, target is locked at 72-hole score.
                    const isTargetLocked = golfStatus && (golfStatus.includes("PLAYOFF") || golfStatus.includes("FINAL"));
                    const targetNote = isTargetLocked ? `Target: ${underPar} (Locked)` : `Target: ${underPar}`;

                    suggestions[40] = {
                        text: hitGolfScore ? "Yes" : "No",
                        isFinal: isFinal || hitGolfScore,
                        note: `${targetNote} | NE: ${neStatus} | SEA: ${seaStatus}`
                    };
                }
            }
            
            // Player Stat Helper
            const getPlayerStat = (playerName, statCategory, statKey) => {
                let statValue = 0;
                if (nflData.boxscore && nflData.boxscore.players) {
                    nflData.boxscore.players.forEach(teamPlayers => {
                        const category = teamPlayers.statistics.find(s => s.name === statCategory);
                        if (category) {
                            const keyIndex = category.keys.indexOf(statKey);
                            if (keyIndex !== -1) {
                                const athlete = category.athletes.find(a => 
                                    a.athlete.displayName === playerName || a.athlete.shortName === playerName
                                );
                                if (athlete && athlete.stats[keyIndex]) {
                                    statValue = parseInt(athlete.stats[keyIndex]) || 0;
                                }
                            }
                        }
                    });
                }
                return statValue;
            };
            
            // Q41: Drake Maye Rushing
            const mayeRush = getPlayerStat("Drake Maye", "rushing", "rushingYards");
            suggestions[41] = createOverUnderSuggestion(mayeRush, 30.5, "Yards", `Drake Maye Rushing: ${mayeRush} yards`, isFinal);

            // Q42: JSN Receiving
            const jsnRec = getPlayerStat("Jaxon Smith-Njigba", "receiving", "receivingYards");
            suggestions[42] = createOverUnderSuggestion(jsnRec, 93.5, "Yards", `JSN Receiving: ${jsnRec} yards`, isFinal);
            
            // Q53: More Receiving Yards (Diggs vs JSN)
            const diggsRec = getPlayerStat("Stefon Diggs", "receiving", "receivingYards");
            suggestions[53] = {
                text: diggsRec > jsnRec ? "Stefon Diggs (NE #8 WR)" : "Jaxon Smith-Njigba (SEA #11 WR)",
                isFinal: isFinal,
                note: `Diggs: ${diggsRec} | JSN: ${jsnRec}${diggsRec === jsnRec ? ' (TIE - PUSH)' : ''}`
            };

            // Q43: Total FG Yardage & Q54: Longest Touchdown
            let fgYardage = 0;
            let longestTD = 0;
            let longestTDTeam = "None";
            let longestTDPlay = null;
            
            if (nflData.scoringPlays) {
                nflData.scoringPlays.forEach(play => {
                    const text = play.text || "";
                    const match = text.match(/(\d+)\s+yd/i) || text.match(/(\d+)\s+yard/i);
                    const yds = match ? parseInt(match[1], 10) : 0;
                    
                    if (play.type && play.type.abbreviation === "FG") {
                        fgYardage += yds;
                    }
                    if (play.type && (play.type.abbreviation === "TD" || play.type.text?.toLowerCase().includes("touchdown"))) {
                        if (yds > longestTD) {
                            longestTD = yds;
                            longestTDPlay = play;
                            const tm = play.team?.abbreviation || "";
                            if (tm === 'NE' || tm === 'Patriots') longestTDTeam = "New England Patriots";
                            else if (tm === 'SEA' || tm === 'Seahawks') longestTDTeam = "Seattle Seahawks";
                            else longestTDTeam = tm;
                        }
                    }
                });
            }
            
            suggestions[43] = createOverUnderSuggestion(fgYardage, 133.5, "Yards", `${isFinal ? 'Final' : 'Current'} Total FG Yardage: ${fgYardage}`, isFinal);
            
            if (longestTD > 0) {
                suggestions[54] = {
                    text: longestTDTeam,
                    isFinal: isFinal,
                    note: getPlayDesc(longestTDPlay, patsId, hawksId)
                };
            } else {
                suggestions[54] = { text: "Waiting...", isFinal: false, note: "No touchdowns yet" };
            }
            
            // Q47: Passers with a completion & Q55: Longest Scrimmage Play
            let passers = 0;
            let passerNames = [];
            let maxScrimmageYards = 0;
            let maxScrimmagePlayer = "None";
            
            if (nflData.boxscore && nflData.boxscore.players) {
                nflData.boxscore.players.forEach(teamPlayers => {
                    // Passers
                    const passCat = teamPlayers.statistics.find(s => s.name === "passing");
                    if (passCat) {
                        const compIdx = passCat.keys.indexOf("completions/passingAttempts");
                        if (compIdx !== -1) {
                            passCat.athletes.forEach(a => {
                                const compStr = a.stats[compIdx] || "0/0";
                                const completions = parseInt(compStr.split('/')[0]) || 0;
                                if (completions > 0) {
                                    passers++;
                                    passerNames.push(a.athlete.shortName || a.athlete.displayName);
                                }
                            });
                        }
                    }
                    
                    // Long Rushing
                    const rushCat = teamPlayers.statistics.find(s => s.name === "rushing");
                    if (rushCat) {
                        const longIdx = rushCat.keys.indexOf("longRushing");
                        if (longIdx !== -1) {
                            rushCat.athletes.forEach(a => {
                                const yds = parseInt(a.stats[longIdx]) || 0;
                                if (yds > maxScrimmageYards) {
                                    maxScrimmageYards = yds;
                                    maxScrimmagePlayer = a.athlete.displayName;
                                }
                            });
                        }
                    }
                    
                    // Long Receiving
                    const recCat = teamPlayers.statistics.find(s => s.name === "receiving");
                    if (recCat) {
                        const longIdx = recCat.keys.indexOf("longReception");
                        if (longIdx !== -1) {
                            recCat.athletes.forEach(a => {
                                const yds = parseInt(a.stats[longIdx]) || 0;
                                if (yds > maxScrimmageYards) {
                                    maxScrimmageYards = yds;
                                    maxScrimmagePlayer = a.athlete.displayName;
                                }
                            });
                        }
                    }
                });
            }

            suggestions[47] = createOverUnderSuggestion(passers, 2.5, "Players", `Passers with completions: ${passers}${passers > 0 ? ` (${passerNames.join(', ')})` : ''}`, isFinal);
            
            if (maxScrimmageYards > 0) {
                let suggestedPlayerOption = "Field/Other";
                const nameParts = maxScrimmagePlayer.split(' ');
                const matchedOpt = scrimmagePlayers.find(p => {
                    const lowP = p.toLowerCase();
                    return nameParts.every(part => lowP.includes(part.toLowerCase().replace('.', '')));
                });

                if (matchedOpt) suggestedPlayerOption = matchedOpt;
                
                const lastName = nameParts[nameParts.length - 1];
                const longestPlay = allPlays.find(p => 
                    !p.text?.includes("No Play") && 
                    p.statYardage == maxScrimmageYards && 
                    p.text?.includes(lastName) && 
                    !p.type?.text?.includes("Kickoff") && 
                    !p.type?.text?.includes("Punt")
                );
                
                suggestions[55] = {
                    text: suggestedPlayerOption,
                    isFinal: isFinal,
                    note: longestPlay ? getPlayDesc(longestPlay, patsId, hawksId) : `${maxScrimmageYards} yards by ${maxScrimmagePlayer}`
                };
            } else {
                suggestions[55] = { text: "Waiting...", isFinal: false, note: "No scrimmage yards recorded" };
            }

            // Q48, Q49, Q50, Q51: Lead Changes, Ties, First/Last Scorer Win
            if (nflData.scoringPlays && nflData.scoringPlays.length > 0) {
                let tiedAfter00 = false;
                let q4HomeLed = false;
                let q4AwayLed = false;
                let scoreBeforeQ4 = { home: 0, away: 0 };
                
                nflData.scoringPlays.forEach(play => {
                    const hScore = play.homeScore || 0;
                    const aScore = play.awayScore || 0;
                    
                    if (hScore === aScore && (hScore > 0 || aScore > 0)) {
                        tiedAfter00 = true;
                    }
                    
                    if (play.period && play.period.number < 4) {
                        scoreBeforeQ4.home = hScore;
                        scoreBeforeQ4.away = aScore;
                    }
                });
                
                if (scoreBeforeQ4.home > scoreBeforeQ4.away) q4HomeLed = true;
                if (scoreBeforeQ4.away > scoreBeforeQ4.home) q4AwayLed = true;
                
                nflData.scoringPlays.forEach(play => {
                    if (play.period && play.period.number === 4) {
                        if (play.homeScore > play.awayScore) q4HomeLed = true;
                        if (play.awayScore > play.homeScore) q4AwayLed = true;
                    }
                });
                
                const bothLedQ4 = q4HomeLed && q4AwayLed;
                const isQ4Over = period > 4 || isFinal;
                
                if (period >= 4 || isFinal) {
                    if (bothLedQ4 || isQ4Over) {
                        suggestions[48] = {
                            text: bothLedQ4 ? "Yes" : "No",
                            isFinal: bothLedQ4 || isQ4Over,
                            note: bothLedQ4 ? "Both teams led outright in Q4" : "Both did not lead outright in Q4"
                        };
                    }
                }
                
                suggestions[49] = {
                    text: tiedAfter00 ? "Yes" : "No",
                    isFinal: tiedAfter00 || isFinal,
                    note: tiedAfter00 ? "Game was tied after 0-0" : (isFinal ? "No ties after 0-0" : "No ties yet")
                };

                const firstPlay = nflData.scoringPlays[0];
                const lastPlay = nflData.scoringPlays[nflData.scoringPlays.length - 1];
                const firstScoringTeamId = firstPlay.team?.id;
                const lastScoringTeamId = lastPlay.team?.id;
                
                let currentLeaderId = null;
                if (patsScore > hawksScore) currentLeaderId = pats.team.id;
                else if (hawksScore > patsScore) currentLeaderId = hawks.team.id;

                if (currentLeaderId) {
                    const winnerAbbrev = currentLeaderId === pats.team.id ? pats.team.abbreviation : hawks.team.abbreviation;
                    
                    suggestions[50] = {
                        text: firstScoringTeamId === currentLeaderId ? "Yes" : "No",
                        isFinal: isFinal,
                        note: `[First Score] ${getPlayDesc(firstPlay, patsId, hawksId)}`
                    };
                    suggestions[51] = {
                        text: lastScoringTeamId === currentLeaderId ? "Yes" : "No",
                        isFinal: isFinal,
                        note: `[Last Score] ${getPlayDesc(lastPlay, patsId, hawksId)}`
                    };
                }
            } else {
                suggestions[49] = { text: "No", isFinal: false, note: "No scores yet" };
                suggestions[50] = { text: "Waiting...", isFinal: false, note: "No scores yet" };
                suggestions[51] = { text: "Waiting...", isFinal: false, note: "No scores yet" };
            }

            // Q52: Will the game go to overtime?
            if (period > 4 || isFinal) {
                const wentToOT = period > 4;
                suggestions[52] = {
                    text: wentToOT ? "Yes" : "No",
                    isFinal: true,
                    note: wentToOT ? "Game reached OT" : "Game ended in regulation"
                };
            }

            // Q46: Total combined points
            suggestions[46] = createOverUnderSuggestion(totalScore, 45.5, "Points", `Total: ${totalScore} | NE: ${patsScore}, SEA: ${hawksScore}`, isFinal);

            // Q57: Final Total Score Even/Odd
            suggestions[57] = {
                text: totalScore % 2 === 0 ? "Even" : "Odd",
                isFinal: isFinal,
                note: `${isFinal ? 'Final' : `Current ${statusDetail}`} Total: ${totalScore} | NE: ${patsScore}, SEA: ${hawksScore}`
            };

            // Q60: Exact Score
            suggestions[60] = {
                text: `Patriots: ${patsScore}, Seahawks: ${hawksScore}`,
                isFinal: isFinal,
                note: `${isFinal ? "Final" : "Current"} Score: Patriots ${patsScore} - Seahawks ${hawksScore}`,
                scores: { patriots: patsScore, seahawks: hawksScore }
            };

            // Q44 & Q45: Sacks & Turnovers
            if (nflData.boxscore && nflData.boxscore.teams) {
                let totalSacks = 0;
                let totalTurnovers = 0;
                let turnoverDetails = [];

                nflData.boxscore.teams.forEach(t => {
                    const stats = t.statistics || [];
                    const teamAbbrev = t.team?.abbreviation || "";
                    
                    const toStat = stats.find(s => s.name === "turnovers");
                    const teamTOs = toStat ? parseInt(toStat.displayValue) || 0 : 0;
                    totalTurnovers += teamTOs;

                    if (teamTOs > 0) {
                        const intStat = stats.find(s => s.name === "interceptions");
                        const fumStat = stats.find(s => s.name === "fumblesLost");
                        const ints = intStat ? parseInt(intStat.displayValue) || 0 : 0;
                        const fums = fumStat ? parseInt(fumStat.displayValue) || 0 : 0;
                        
                        let details = [];
                        if (fums > 0) details.push(`${fums} Fumble${fums > 1 ? 's' : ''}`);
                        if (ints > 0) details.push(`${ints} Int${ints > 1 ? 's' : ''}`);
                        turnoverDetails.push(`${teamAbbrev}: ${details.join(', ')}`);
                    }

                    const sackStat = stats.find(s => s.name === "sacksYardsLost");
                    if (sackStat && sackStat.displayValue) {
                        const sackCount = parseInt(sackStat.displayValue.split('-')[0]);
                        if (!isNaN(sackCount)) totalSacks += sackCount;
                    }
                });

                suggestions[44] = createOverUnderSuggestion(totalSacks, 5.5, "Sacks", `${isFinal ? 'Final' : 'Current'} Sacks: ${totalSacks}`, isFinal);
                suggestions[45] = createOverUnderSuggestion(totalTurnovers, 2.5, "Turnovers", `Turnovers: ${totalTurnovers}${turnoverDetails.length > 0 ? '. ' + turnoverDetails.join(' | ') : ''}`, isFinal);
            }

            return suggestions;
        };

        const generatePrintWindow = (input, name = "") => {
            // Normalize input to array for batch processing
            // Case 1: Batch (Array of {selections, name})
            // Case 2: Single (selections object, name string)
            let entries = [];
            if (Array.isArray(input)) {
                entries = input;
            } else {
                entries = [{ selections: input, name: name }];
            }

            const w = window.open('', '_blank');
            
            // Safety check for popup blockers
            if (!w) {
                alert("Popup blocker detected! Please allow popups for this site to print your sheet.");
                return;
            }

            const content = entries.map((entry, index) => {
                const selections = entry.selections || {};
                const entryName = entry.name || "";
                
                const questionsHtml = QUESTIONS.map(q => {
                    let displayQ = q.q;
                    let displayNote = q.note || "";
                    const userPick = selections[q.id];
                    
                    const isSelected = (optText) => userPick && userPick.text === optText;
                    
                    return `
                        <div class="question">
                            <div class="q-text">${q.id}. ${displayQ}</div>
                            ${displayNote ? `<div style="font-style:italic; font-size:10px; margin-bottom:4px; color:#555; margin-left:15px;">${displayNote}</div>` : ''}
                            ${q.options.length > 4 ? `
                                <div class="long-list">
                                    ${q.options.map(o => {
                                        const selected = isSelected(o.text);
                                        const boxStyle = selected ? "background-color:black;color:white;text-align:center;line-height:10px;" : "";
                                        const textStyle = selected ? "font-weight:bold;text-decoration:underline;" : "";
                                        const mark = selected ? "X" : "";
                                        return `<div class="option" style="${textStyle}"><span class="box" style="${boxStyle}">${mark}</span> ${o.text} (${o.points})</div>`;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="options">
                                    ${q.options.map(o => {
                                        const selected = isSelected(o.text);
                                        const boxStyle = selected ? "background-color:black;color:white;text-align:center;line-height:10px;" : "";
                                        const textStyle = selected ? "font-weight:bold;text-decoration:underline;" : "";
                                        const mark = selected ? "X" : "";
                                        return `<div class="option" style="${textStyle}"><span class="box" style="${boxStyle}">${mark}</span> ${o.text} <span style="font-size:10px;color:#666;margin-left:2px">(${o.points})</span></div>`;
                                    }).join('')}
                                </div>
                            `}
                            ${q.type === 'score' ? `
                                <div style="margin-top:5px; font-weight:bold;">
                                    Patriots: <span style="text-decoration:underline; display:inline-block; width:30px; text-align:center;">${userPick?.scores?.patriots || '___'}</span> &nbsp;&nbsp; 
                                    Seahawks: <span style="text-decoration:underline; display:inline-block; width:30px; text-align:center;">${userPick?.scores?.seahawks || '___'}</span>
                                </div>` : ''}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="page-container ${index < entries.length - 1 ? 'page-break' : ''}">
                        <h1>Super Bowl LX Prop Bets</h1>
                        ${entryName ? `<h2>Participant: ${entryName}</h2>` : ''}
                        <div class="grid-container">
                            ${questionsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            w.document.write(`
                <html>
                <head>
                    <title>Super Bowl LX Props Sheet</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; font-size: 12px; margin: 0; }
                        h1 { text-align: center; text-transform: uppercase; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 5px; }
                        h2 { text-align: center; font-size: 14px; margin-top: 0; margin-bottom: 20px; color: #555; }
                        .grid-container { column-count: 2; column-gap: 40px; }
                        .question { break-inside: avoid; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                        .q-text { font-weight: bold; margin-bottom: 4px; }
                        .options { display: flex; flex-wrap: wrap; gap: 15px; }
                        .option { display: flex; align-items: center; }
                        .box { width: 12px; height: 12px; border: 1px solid black; margin-right: 5px; display: inline-block; font-size: 10px; }
                        .long-list { display: grid; grid-template-columns: 1fr 1fr; font-size: 10px; gap: 2px; margin-top: 5px; }
                        .page-container { padding: 20px; }
                        @media print { 
                            .no-print { display: none; } 
                            .page-break { page-break-after: always; display: block; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            w.document.close();
        };

        const RulesView = ({ paymentConfig, rulesConfig, accessConfig, onNavigate }) => {
            const isFree = !paymentConfig.fee || paymentConfig.fee === 0;
            
            // Phase 3: Schedule Logic
            let scheduleDisplay = null;
            if (accessConfig?.submissionStatus === 'scheduled' && accessConfig?.openTimestamp) {
                const openDate = new Date(accessConfig.openTimestamp);
                // Phase 4: Date Safety Check
                if (!isNaN(openDate.getTime())) {
                    const dateStr = openDate.toLocaleString([], { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                    const isQuestionsVisible = !accessConfig.questionsHidden;

                    scheduleDisplay = (
                        <div className="bg-[#001122] p-4 rounded border border-blue-800 mb-6 text-left relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-2 opacity-10">
                                <i className="fas fa-clock text-4xl text-white"></i>
                            </div>
                            <p className="text-blue-300 uppercase text-xs font-bold tracking-widest mb-1">Submission Schedule</p>
                            <p className="text-white text-sm mb-2 relative z-10">
                                The digital submission form is currently locked.
                                <br/>
                                Submissions will open on <span className="font-bold text-[#D50A0A]">{dateStr}</span>.
                            </p>
                            {isQuestionsVisible && (
                                <div className="mt-3 pt-3 border-t border-blue-900/50 relative z-10">
                                    <p className="text-xs text-green-400 font-bold uppercase tracking-wide mb-1"><i className="fas fa-print mr-1"></i> Early Access Available</p>
                                    <p className="text-xs text-gray-400 mb-2">You can view and print the questions now to start planning your picks!</p>
                                    <button
                                        onClick={() => onNavigate('print')}
                                        className="text-[10px] bg-green-900/30 text-green-300 border border-green-700 px-3 py-1.5 rounded hover:bg-green-900/50 transition-colors uppercase font-bold tracking-wider"
                                    >
                                        <i className="fas fa-file-pdf mr-1"></i> Go to Print View
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                }
            } else if (accessConfig?.submissionStatus === 'closed') {
                scheduleDisplay = (
                    <div className="bg-red-900/20 p-4 rounded border border-red-900/50 mb-6 text-left">
                        <p className="text-red-400 uppercase text-xs font-bold tracking-widest mb-1">Status</p>
                        <p className="text-white text-sm font-bold"><i className="fas fa-lock mr-2"></i>Contest is currently Closed.</p>
                    </div>
                );
            }

            return (
                <div className="bg-[#001f3f] border border-[#003366] rounded-lg p-6 text-center animate-fade-in flex flex-col min-h-[60vh]">
                    <div className="flex-1">
                        <h3 className="text-2xl font-black text-white uppercase mb-4">Official Rules</h3>
                        
                        {scheduleDisplay}

                        <div className="bg-[#001122] p-4 rounded border border-[#003366] inline-block mb-6 min-w-[200px]">
                            <p className="text-blue-300 uppercase text-xs font-bold tracking-widest mb-1">Entry Fee</p>
                            <p className={`text-3xl font-black ${isFree ? 'text-green-400' : 'text-[#D50A0A]'}`}>
                                {isFree ? "FREE TO PLAY" : `$${paymentConfig.fee}`}
                            </p>
                            {!isFree && (
                                <>
                                    <p className="text-white text-sm mt-1">{paymentConfig.methodName}{paymentConfig.methodName ? ': ' : ''}<span className="font-bold">{paymentConfig.identifier}</span></p>
                                    {paymentConfig.note && <p className="text-xs text-gray-400 mt-2 italic border-t border-[#003366] pt-2">{paymentConfig.note}</p>}
                                </>
                            )}
                            {isFree && paymentConfig.note && <p className="text-xs text-gray-400 mt-2 italic border-t border-[#003366] pt-2">{paymentConfig.note}</p>}
                        </div>
                        <div className="space-y-4 text-blue-100 max-w-md mx-auto text-left">
                            {rulesConfig?.payouts && (
                                <div className="flex items-start gap-3">
                                    <i className="fas fa-trophy text-yellow-500 mt-1"></i>
                                    <div>
                                        <p className="font-bold text-sm text-yellow-400 uppercase tracking-wider mb-1">Payouts</p>
                                        <p className="text-sm whitespace-pre-line">{rulesConfig.payouts}</p>
                                    </div>
                                </div>
                            )}
                            {rulesConfig?.ties && (
                                <div className="flex items-start gap-3">
                                    <i className="fas fa-handshake text-blue-400 mt-1"></i>
                                    <div>
                                        <p className="font-bold text-sm text-blue-300 uppercase tracking-wider mb-1">Tie-Breaker</p>
                                        <p className="text-sm">{rulesConfig.ties}</p>
                                    </div>
                                </div>
                            )}
                            
                            {rulesConfig?.late && (
                                <div className="mt-6 pt-4 border-t border-[#003366]">
                                    {rulesConfig.lateHeader && (
                                        <p className="text-xs font-bold text-red-400 uppercase tracking-widest mb-2">
                                            <i className="fas fa-exclamation-triangle mr-1"></i> {rulesConfig.lateHeader}
                                        </p>
                                    )}
                                    <p className="text-xs text-gray-300 leading-relaxed bg-[#001122] p-3 rounded border border-red-900/30">
                                        {rulesConfig.late}
                                    </p>
                                </div>
                            )}
                        </div>
                        
                        {rulesConfig?.goodLuck && (
                            <div className="mt-8 pt-6 border-t border-[#003366]">
                                <p className="text-sm font-bold text-green-400 uppercase tracking-widest animate-pulse">{rulesConfig.goodLuck}</p>
                            </div>
                        )}
                    </div>
                    
                    {rulesConfig?.disclaimer && (
                        <div className="mt-auto pt-8 text-[10px] text-gray-500 uppercase tracking-wide">
                            {rulesConfig.disclaimer}
                        </div>
                    )}
                </div>
            );
        };

        const PrintView = ({ userSelections, userName }) => {
            const hasSelections = userSelections && Object.keys(userSelections).length > 0;
            const selectionCount = userSelections ? Object.keys(userSelections).length : 0;
            const totalQuestions = QUESTIONS.length;
            const isComplete = selectionCount === totalQuestions;

            const printBlank = () => {
                generatePrintWindow({}, "");
            };

            const printCurrent = () => {
                generatePrintWindow(userSelections, userName);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-[50vh] text-center space-y-6 animate-fade-in p-4">
                    <div className="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 mx-auto">
                        <i className="fas fa-print text-[#013369] text-4xl"></i>
                    </div>
                    <h2 className="text-2xl font-bold text-white uppercase">Printable Prop Sheet</h2>
                    <p className="text-blue-200 max-w-md text-sm sm:text-base">
                        Generate a printer-friendly PDF. You can print a blank sheet for a party, or print your current picks to save a hard copy record.
                    </p>
                    
                    <div className="flex flex-col gap-4 w-full max-w-xs mt-4">
                        <button 
                            onClick={printBlank}
                            className="bg-white text-[#013369] font-black uppercase py-4 px-6 rounded shadow-lg hover:bg-blue-50 transition-colors flex items-center justify-center gap-3"
                        >
                            <i className="fas fa-file-alt text-lg"></i> 
                            <span>Print Blank Sheet</span>
                        </button>

                        <div className="relative">
                            <button 
                                onClick={printCurrent}
                                disabled={!hasSelections}
                                className={`w-full font-black uppercase py-4 px-6 rounded shadow-lg transition-all flex flex-col items-center justify-center gap-1 ${hasSelections ? 'bg-[#D50A0A] text-white hover:bg-[#b00808]' : 'bg-gray-800 text-gray-500 cursor-not-allowed border border-gray-700'}`}
                            >
                                <div className="flex items-center gap-3">
                                    <i className="fas fa-check-square text-lg"></i>
                                    <span>Print My Selections</span>
                                </div>
                                {hasSelections && (
                                    <span className={`text-[10px] uppercase font-bold tracking-wider ${isComplete ? 'text-green-300' : 'text-yellow-300'}`}>
                                        {selectionCount} / {totalQuestions} Selected
                                    </span>
                                )}
                            </button>
                            
                            {!hasSelections ? (
                                <p className="text-[10px] text-gray-500 mt-2 absolute w-full text-center">
                                    <i className="fas fa-info-circle mr-1"></i> Make picks in the "Make Picks" tab to enable.
                                </p>
                            ) : !userName ? (
                                <p className="text-[10px] text-yellow-500 mt-2 absolute w-full text-center font-bold animate-pulse">
                                    <i className="fas fa-exclamation-triangle mr-1"></i> Warning: No Name Entered
                                </p>
                            ) : null}
                        </div>
                    </div>
                </div>
            );
        };

        const HOFView = () => (
            <div className="bg-[#001f3f] border border-[#003366] rounded-lg p-6 text-center animate-fade-in">
                <h3 className="text-2xl font-black text-white uppercase mb-6"><i className="fas fa-trophy text-yellow-500 mr-2"></i> Hall of Fame</h3>
                
                <div className="space-y-4">
                    <div className="bg-[#001122] p-4 rounded border border-[#003366] flex justify-between items-center">
                        <span className="text-white font-bold text-lg">Joey</span>
                        <span className="text-blue-300 font-mono">LVII, LVIII, LIX</span>
                    </div>
                    <div className="bg-[#001122] p-4 rounded border border-[#003366] flex justify-between items-center">
                        <span className="text-white font-bold text-lg">Ellie</span>
                        <span className="text-blue-300 font-mono">LVIII</span>
                    </div>
                    <div className="bg-[#001122] p-4 rounded border border-[#003366] flex justify-between items-center">
                        <span className="text-white font-bold text-lg">Bobby</span>
                        <span className="text-blue-300 font-mono">LV</span>
                    </div>
                </div>
            </div>
        );

        // --- COMPONENTS ---
        
        // Reusable Save Button (Extracted)
        const SaveButton = ({ saveKey, onClick, disabled, saveStatus }) => {
            const status = (saveStatus && saveStatus[saveKey]) || 'idle';
            let btnClass = "px-3 py-1.5 rounded text-xs font-bold uppercase transition-all shadow-sm ";
            let content = "Save";
            
            if (status === 'saving') {
                btnClass += "bg-gray-500 text-white cursor-wait";
                content = "Saving...";
            } else if (status === 'saved') {
                btnClass += "bg-green-600 text-white shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                content = <><i className="fas fa-check mr-1"></i> Saved</>;
            } else if (disabled) {
                btnClass += "bg-gray-700 text-gray-500 cursor-not-allowed opacity-50";
            } else {
                btnClass += "bg-blue-600 hover:bg-blue-500 text-white";
            }
            
            return (
                <button onClick={onClick} disabled={status !== 'idle' && !disabled} className={btnClass}>
                    {content}
                </button>
            );
        };

        const ProgressBar = ({ current, total, onRandomClick, randomState, onClearClick, clearState }) => (
            <div className="flex items-center gap-2 mb-2 w-full">
                <button 
                    onClick={onClearClick}
                    className={`shrink-0 p-2 rounded-full w-8 h-8 flex items-center justify-center transition-colors border ${
                        clearState === 'undo' 
                        ? 'bg-yellow-900/50 text-yellow-500 border-yellow-700 hover:bg-yellow-900' 
                        : 'bg-red-900/30 text-red-400 border-red-900/50 hover:bg-red-900/50'
                    }`}
                    title={clearState === 'undo' ? "Undo Clear" : "Clear All Picks"}
                >
                    <i className={`fas ${clearState === 'undo' ? 'fa-undo' : 'fa-trash-alt'} text-xs`}></i>
                </button>

                <div className="flex-1 bg-[#001122] rounded-full h-3 border border-[#002a55] mx-2">
                    <div 
                        className="h-full rounded-full transition-all duration-500 bg-[#D50A0A] relative"
                        style={{ width: `${Math.min(100, (current / total) * 100)}%` }}
                    >
                        <div className="absolute top-0 right-0 bottom-0 w-1 bg-white shadow-[0_0_10px_#fff]"></div>
                    </div>
                </div>

                <button 
                    onClick={onRandomClick}
                    className={`shrink-0 p-2 rounded-full w-8 h-8 flex items-center justify-center transition-colors border ${
                        randomState === 'undo' 
                        ? 'bg-yellow-900/50 text-yellow-500 border-yellow-700 hover:bg-yellow-900' 
                        : 'bg-blue-900/50 text-blue-300 border-blue-800 hover:bg-blue-800'
                    }`}
                    title={randomState === 'undo' ? "Undo Random Fill" : "Randomly Fill Empty Questions"}
                >
                    <i className={`fas ${randomState === 'undo' ? 'fa-undo' : 'fa-magic'} text-xs`}></i>
                </button>
            </div>
        );

        const CustomDropdown = ({ options, selected, onSelect, disabled }) => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            let buttonClass = "w-full flex justify-between items-center p-4 rounded text-base transition-all font-medium border-l-4 ";
            
            if (disabled) {
                 buttonClass += "bg-[#002244] border-l-blue-800 text-blue-400 opacity-50 cursor-not-allowed";
            } else {
                if (selected) buttonClass += "bg-[#013369] border-l-[#D50A0A] text-white hover:bg-[#012a55] cursor-pointer shadow-lg ring-1 ring-[#D50A0A]/30";
                else buttonClass += "bg-[#002244] border-l-blue-800 text-blue-200 hover:bg-[#003366] cursor-pointer";
            }

            return (
                <div className="relative w-full" ref={dropdownRef}>
                    <button 
                        onClick={() => !disabled && setIsOpen(!isOpen)}
                        className={buttonClass}
                        type="button"
                    >
                        <span className="truncate mr-2 flex items-center gap-2">
                            <span>{selected ? selected.text : "Select prediction..."}</span>
                            {selected && <span className="text-sm font-bold bg-[#D50A0A] text-white px-2 py-0.5 rounded border border-[#D50A0A]">{selected.points} pts</span>}
                        </span>
                        <div className="flex items-center gap-2">
                            <i className={`fas fa-chevron-down transition-transform ${isOpen ? 'rotate-180' : ''}`}></i>
                        </div>
                    </button>

                    {isOpen && !disabled && (
                        <div className="absolute z-50 w-full mt-1 bg-[#002a55] border border-[#013369] rounded shadow-2xl max-h-60 overflow-y-auto custom-scrollbar">
                            {options.map((opt, i) => (
                                <div 
                                    key={i}
                                    onClick={() => {
                                        onSelect(opt.text, opt.points);
                                        setIsOpen(false);
                                    }}
                                    className={`p-3 text-sm cursor-pointer hover:bg-[#003366] flex justify-between items-center border-b border-[#013369] last:border-0 ${
                                        selected?.text === opt.text ? 'bg-[#013369] text-white' : 'text-blue-100'
                                    }`}
                                >
                                    <span>{opt.text}</span>
                                    <span className="text-sm font-bold text-blue-400">{opt.points} pts</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionCard = ({ q, userSelection, onSelect, onScoreChange, onVoid, onRestore, disabled, highlight, isAdmin, gameState, golfData, golfError, officialResults, golfRound, suggestion, showSuggestions, isCollapsed, onToggleCollapse, publicNotesConfig, onTogglePublicNote }) => {
            const isScoreInput = q.type === 'score';
            const isDropdown = !isScoreInput && q.options.length > 2;
            const isVoid = userSelection?.isVoid;
            
            // Conflict Detection
            const hasConflict = isAdmin && userSelection && suggestion && userSelection.text !== suggestion.text && suggestion.text !== "Exact Score" && suggestion.text !== "Waiting..." && !isVoid;

            // Admin: Check Publish Status
            let publishStatus = null;
            let showRestore = false;

            if (isAdmin) {
                const official = officialResults ? officialResults[q.id] : null;
                
                if (userSelection) {
                    // Local selection exists. Is it different from official?
                    const isMatch = official && 
                                    official.text === userSelection.text && 
                                    official.isVoid === userSelection.isVoid && 
                                    JSON.stringify(official.scores) === JSON.stringify(userSelection.scores);
                    
                    if (isMatch) {
                        publishStatus = <span className="text-[10px] bg-green-900 text-green-300 px-2 py-1 rounded border border-green-700 font-bold uppercase tracking-wider shadow-sm"><i className="fas fa-check-circle mr-1"></i> Published</span>;
                    } else {
                        publishStatus = <span className="text-[10px] bg-yellow-600 text-white px-2 py-1 rounded border border-yellow-500 font-bold uppercase tracking-wider shadow-sm animate-pulse"><i className="fas fa-pen mr-1"></i> {official ? 'Changed' : 'Draft'}</span>;
                    }
                } else if (official) {
                    // No local selection, but official exists (Pending Deletion)
                    publishStatus = <span className="text-[10px] bg-red-900 text-red-200 px-2 py-1 rounded border border-red-700 font-bold uppercase tracking-wider shadow-sm"><i className="fas fa-eraser mr-1"></i> Pending Unpublish</span>;
                    showRestore = true;
                }
            }

            // Determine card style based on state
            let cardClass = `p-5 rounded-lg border-l-4 transition-all duration-300 shadow-lg shadow-black/20 relative `;
            if (isVoid) {
                cardClass += `bg-gray-800 border-l-gray-500 border-gray-600 opacity-90`;
            } else if (userSelection && !isAdmin) {
                cardClass += `bg-[#001f3f] border-l-[#D50A0A] ring-1 ring-[#D50A0A]/20`;
            } else if (highlight && isAdmin) {
                cardClass += `bg-[#001f3f] border-l-[#D50A0A] border-4 border-[#D50A0A]`; 
            } else {
                cardClass += `bg-[#001f3f] border-l-[#013369] border-[#003366]`;
            }
            
            // Logic for Puppy Bowl Display
            let showPuppyBowlContext = false;
            if (q.id === 19 && gameState?.puppyBowl && (isAdmin || publicNotesConfig?.puppy)) {
                if (gameState.puppyBowl.publishStrategy === 'now' || isAdmin) {
                    showPuppyBowlContext = true;
                } else if (gameState.puppyBowl.publishStrategy === 'delayed') {
                    if (officialResults && officialResults[13] && !officialResults[13].isVoid) {
                        showPuppyBowlContext = true;
                    }
                }
            }
            
            // Logic for Golf Display
            const showGolfContext = q.id === 40 && (isAdmin || publicNotesConfig?.golf);
            const useCustomGolf = gameState?.golf && !gameState.golf.useAuto && gameState.golf.customText;
            
            const isPublicNoteHidden = publicNotesConfig?.hidden?.includes(q.id);

            return (
                <div className={cardClass}>
                    {/* Admin Status Header */}
                    {(isAdmin && (publishStatus || showRestore || isVoid)) && (
                        <div className="flex justify-end items-center gap-2 mb-3 pb-2 border-b border-white/10 -mx-2 px-2">
                             {/* Status Badge */}
                             {publishStatus}
                             
                             {/* Restore Button */}
                             {showRestore && (
                                <button 
                                    onClick={() => onRestore(q.id)}
                                    className="text-[10px] bg-blue-700 text-white px-2 py-1 rounded border border-blue-500 font-bold uppercase tracking-wider shadow-sm hover:bg-blue-600 transition-colors"
                                >
                                    <i className="fas fa-undo mr-1"></i> Restore
                                </button>
                             )}

                             {/* Void Badge (Visual only) */}
                             {isVoid && <span className="text-[10px] font-black bg-gray-500 text-black px-2 py-1 rounded uppercase tracking-widest">VOID / PUSH</span>}
                        </div>
                    )}
                    
                    {!isAdmin && isVoid && <div className="absolute top-2 right-4 text-xs font-black bg-gray-500 text-black px-2 py-1 rounded uppercase tracking-widest z-10">VOID / PUSH</div>}
                    
                    <div className="flex justify-between items-start gap-4 mb-4">
                        <div className="flex-1">
                            <p className={`font-bold text-lg leading-tight ${isVoid ? 'text-gray-400' : 'text-white'}`}>
                                <span className={`${isVoid ? 'text-gray-500' : 'text-[#D50A0A]'} mr-2`}>{q.id}.</span>
                                {q.q}
                            </p>
                            {q.note && (
                                <p className={`text-sm italic mt-1 ml-6 ${isVoid ? 'text-gray-500' : 'text-blue-300'}`}>
                                    {q.note}
                                </p>
                            )}
                            
                            {/* Admin Suggestion Sticky Note */}
                            {isAdmin && showSuggestions && suggestion && (
                                isCollapsed ? (
                                    <div className="mt-3 ml-6 flex items-center gap-3">
                                        <button onClick={() => onToggleCollapse(q.id)} className="text-xs text-blue-400 hover:text-white font-bold flex items-center gap-2 border border-[#013369] bg-[#001122] px-3 py-1.5 rounded transition-colors shadow-sm">
                                            <i className="fas fa-search"></i> View Auto-Suggestion
                                        </button>
                                        <button onClick={() => onTogglePublicNote(q.id)} className={`p-1.5 rounded transition-colors border ${isPublicNoteHidden ? 'bg-red-900/50 border-red-500 text-red-400' : 'bg-green-900/50 border-green-500 text-green-400'}`} title={isPublicNoteHidden ? 'Note is hidden from users' : 'Note is visible to users'}>
                                            <i className={`fas ${isPublicNoteHidden ? 'fa-eye-slash' : 'fa-eye'} text-xs`}></i>
                                        </button>
                                    </div>
                                ) : (
                                    <div className={`mt-3 ml-6 rounded p-2 inline-block border relative pr-8 ${hasConflict ? 'bg-red-900/40 border-red-500' : 'bg-blue-900/30 border-blue-500/50'}`}>
                                        <div className="flex flex-wrap items-center gap-x-2 gap-y-1 pr-6">
                                            <div className="flex items-center gap-1.5">
                                                <i className={`fas ${suggestion.isFinal ? 'fa-check-circle text-green-400' : 'fa-info-circle text-blue-400'}`}></i>
                                                <span className="text-xs text-blue-200 font-bold uppercase">
                                                    {suggestion.isFinal ? "Final Result:" : "Current Status:"}
                                                </span>
                                            </div>
                                            <span className={`text-sm font-bold ${suggestion.text === "Waiting..." ? 'text-gray-400 italic' : 'text-[#D50A0A]'}`}>{suggestion.text}</span>
                                        </div>
                                        {suggestion.note && (
                                            <div className="text-sm font-mono text-gray-400 mt-1.5">
                                                {suggestion.note}
                                            </div>
                                        )}
                                        {hasConflict && (
                                            <div className="text-xs text-red-300 mt-1 font-bold animate-pulse">
                                                <i className="fas fa-exclamation-triangle mr-1"></i> Selection differs from data!
                                            </div>
                                        )}
                                        <div className="absolute top-2 right-2 flex flex-col gap-2">
                                            <button 
                                                onClick={() => onToggleCollapse(q.id)}
                                                className="text-gray-400 hover:text-white transition-colors"
                                                title="Hide Suggestion"
                                            >
                                                <i className="fas fa-chevron-up text-xs"></i>
                                            </button>
                                            <button 
                                                onClick={() => onTogglePublicNote(q.id)}
                                                className="text-gray-400 hover:text-white transition-colors mt-1"
                                                title={isPublicNoteHidden ? 'Note is hidden from users' : 'Note is visible to users'}
                                            >
                                                <i className={`fas ${isPublicNoteHidden ? 'fa-eye-slash text-red-400' : 'fa-eye text-green-400'} text-xs`}></i>
                                            </button>
                                        </div>
                                    </div>
                                )
                            )}

                            {/* Live Golf Integration */}
                            {showGolfContext && (
                                <div className="mt-3 ml-6 bg-[#001122] border border-green-800/50 rounded p-2 inline-block max-w-full">
                                    <p className="text-xs text-green-400 font-bold uppercase tracking-wider mb-2 border-b border-green-900 pb-1 flex justify-between items-center">
                                        <span><i className="fas fa-golf-ball mr-1"></i> WM Phoenix Open</span>
                                        <span className="text-[10px] text-gray-500 ml-2">{golfRound || 'Live'}</span>
                                    </p>
                                    
                                    {useCustomGolf ? (
                                        <p className="text-sm text-white font-mono">{gameState.golf.customText}</p>
                                    ) : golfError ? (
                                        <p className="text-xs text-red-400 italic">{golfError}</p>
                                    ) : golfData && golfData.length > 0 ? (
                                        <div className="grid grid-cols-1 gap-1 text-sm font-mono max-h-40 overflow-y-auto custom-scrollbar pr-4">
                                            {golfData.map((g, idx) => (
                                                <div key={idx} className="flex justify-between gap-4 mr-1">
                                                    <span className="text-white truncate max-w-[180px] sm:max-w-[240px] flex items-center">
                                                        {g.isWinner && <i className="fas fa-star text-yellow-500 text-[10px] mr-1"></i>}
                                                        {g.name}
                                                    </span>
                                                    <span className="whitespace-nowrap shrink-0">
                                                        <span className={g.scoreVal < 0 ? "text-[#D50A0A] font-bold" : "text-gray-300"}>{g.scoreStr}</span>
                                                        <span className="text-gray-500 text-xs ml-2 w-10 inline-block text-right">{g.thru === 'F' ? 'F' : g.thru}</span>
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-xs text-gray-500 italic">Leaderboard loading...</p>
                                    )}
                                </div>
                            )}

                            {/* Puppy Bowl Context */}
                            {showPuppyBowlContext && (
                                <div className="mt-3 ml-6 bg-[#001122] border border-[#D50A0A]/50 rounded p-2 inline-block">
                                    <p className="text-xs text-[#D50A0A] font-bold uppercase tracking-wider mb-1"><i className="fas fa-paw mr-1"></i> Puppy Bowl Result</p>
                                    <p className="text-sm text-white font-mono">
                                        Fluff {gameState.puppyBowl.fluff} - Ruff {gameState.puppyBowl.ruff} <span className="text-blue-300 ml-2">| Margin: {Math.abs(gameState.puppyBowl.fluff - gameState.puppyBowl.ruff)}</span>
                                    </p>
                                </div>
                            )}
                        </div>
                        
                        {/* Admin Status Indicators removed from here (now in header) */}
                        
                        {isAdmin && (
                            <button 
                                onClick={() => onVoid(q.id)}
                                className={`ml-2 px-3 py-1 text-xs font-bold uppercase rounded border transition-colors shrink-0 ${isVoid ? 'bg-gray-600 text-white border-gray-400 hover:bg-gray-500' : 'bg-transparent text-gray-400 border-gray-600 hover:text-white hover:border-gray-400'}`}
                            >
                                {isVoid ? 'Unvoid' : 'Void'}
                            </button>
                        )}
                    </div>

                    <div className={`w-full ${isVoid ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                        {isScoreInput ? (
                            <div className="flex flex-col sm:flex-row gap-4 mt-2">
                                <div className="flex-1">
                                    <label className="text-xs text-blue-300 uppercase font-bold mb-1 block">Patriots</label>
                                    <input 
                                        type="number" 
                                        disabled={disabled}
                                        value={userSelection?.scores?.patriots || ''}
                                        onChange={(e) => onScoreChange(q.id, 'patriots', e.target.value)}
                                        placeholder="0"
                                        className="w-full p-4 bg-[#002a55] border border-[#013369] rounded text-white font-bold text-center focus:outline-none focus:border-[#D50A0A] focus:ring-1 focus:ring-[#D50A0A] transition-all" 
                                    />
                                </div>
                                <div className="flex items-center justify-center pt-5">
                                    <span className="text-[#D50A0A] font-black text-xl">-</span>
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs text-blue-300 uppercase font-bold mb-1 block">Seahawks</label>
                                    <input 
                                        type="number" 
                                        disabled={disabled}
                                        value={userSelection?.scores?.seahawks || ''}
                                        onChange={(e) => onScoreChange(q.id, 'seahawks', e.target.value)}
                                        placeholder="0"
                                        className="w-full p-4 bg-[#002a55] border border-[#013369] rounded text-white font-bold text-center focus:outline-none focus:border-[#D50A0A] focus:ring-1 focus:ring-[#D50A0A] transition-all" 
                                    />
                                </div>
                             </div>
                        ) : isDropdown ? (
                            <CustomDropdown 
                                options={q.options}
                                selected={userSelection}
                                onSelect={(text, points) => onSelect(q.id, text, points)}
                                disabled={disabled}
                            />
                        ) : (
                            <div className="flex flex-col gap-3">
                                {q.options.map((opt, i) => {
                                    const isSelected = userSelection?.text === opt.text;
                                    
                                    let btnClass = "relative flex justify-between items-center p-4 rounded text-sm transition-all cursor-pointer font-bold ";
                                    
                                    if (disabled) {
                                         if (isSelected) btnClass += "bg-[#013369] text-white border border-[#D50A0A] opacity-75";
                                         else btnClass += "bg-[#001122] text-gray-600 border border-transparent opacity-50 cursor-not-allowed";
                                    } else {
                                        // Active input state
                                        if (isSelected) btnClass += "bg-[#013369] text-white border border-[#D50A0A] shadow-lg transform scale-[1.01]";
                                        else btnClass += "bg-[#002a55] text-blue-100 border border-transparent hover:bg-[#003366]";
                                    }

                                    return (
                                        <div 
                                            key={i}
                                            onClick={() => !disabled && onSelect(q.id, opt.text, opt.points)}
                                            className={btnClass}
                                        >
                                            <span>{opt.text}</span>
                                            <div className="flex items-center gap-3">
                                                <span className={`text-sm font-bold px-2 py-0.5 rounded border ${isSelected ? 'bg-[#D50A0A] border-[#D50A0A] text-white' : 'bg-[#001122] border-blue-900 text-blue-400'}`}>
                                                    {opt.points} pts
                                                </span>
                                                {isSelected && <i className="fas fa-check text-[#D50A0A]"></i>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EntryDetailModal = ({ entry, rank, officialResults, onClose, onMinimize, initialScroll, isAdminMode, onToggleVoid, suggestionsMap, publicNotesConfig, gameStarted, onToggleEntryLateHide, onToggleQuestionLateHide, gameState, golfData, golfError, golfRound }) => {
            const hasAnyNotes = publicNotesConfig?.nfl || publicNotesConfig?.golf || publicNotesConfig?.puppy;
            const [showStatusNotes, setShowStatusNotes] = useState(!isAdminMode);
            const scrollRef = useRef(null);

            useLayoutEffect(() => {
                if (scrollRef.current && initialScroll > 0) {
                    scrollRef.current.scrollTop = initialScroll;
                }
            }, []);

            const handleMinimize = (e) => {
                e.stopPropagation();
                if (onMinimize && scrollRef.current) {
                    onMinimize(scrollRef.current.scrollTop);
                }
            };
            
            // Visibility Logic
            const isGlobalHidden = publicNotesConfig?.hideLateTags;
            const isEntryLateHidden = entry.hideLate;
            
            // Should the Entry-Level LATE tag be shown?
            // Admin sees it always (dimmed if hidden), User sees it only if not hidden globally or specifically
            const showEntryLateBadge = entry.late && (isAdminMode || (!isGlobalHidden && !isEntryLateHidden));

            // Rank Badge Styling
            let rankBadge = null;
            if (rank > 0) {
                let badgeClass = "text-sm font-black px-2.5 py-0.5 rounded shadow-sm border ";
                if (rank === 1) badgeClass += "bg-yellow-500 text-black border-yellow-400 shadow-yellow-500/20";
                else if (rank === 2) badgeClass += "bg-gray-300 text-black border-gray-400";
                else if (rank === 3) badgeClass += "bg-orange-700 text-white border-orange-600";
                else badgeClass += "bg-[#002244] text-blue-300 border-blue-800";
                
                rankBadge = <span className={badgeClass}>#{rank}</span>;
            }

            // --- PHASE 4a: ROBUST RISK CALCULATION ---
            // Calculate initial potential points if missing (Backwards Compatibility for legacy entries)
            const initialPotential = useMemo(() => {
                if (entry.potentialPoints) return entry.potentialPoints;
                // Fallback: Sum points from selections
                return Object.values(entry.selections || {}).reduce((acc, sel) => acc + (sel.points || 0), 0);
            }, [entry]);

            const getRiskProfile = (potentialPoints) => {
                // Logic based on max possible points vs safe picks
                if (!potentialPoints) return null;
                
                if (potentialPoints < 140) return { label: "Conservative", color: "bg-blue-900/60 text-blue-300 border-blue-700", icon: "fa-shield-alt" };
                if (potentialPoints < 165) return { label: "Balanced", color: "bg-green-900/60 text-green-300 border-green-700", icon: "fa-balance-scale" };
                if (potentialPoints < 190) return { label: "Aggressive", color: "bg-orange-900/60 text-orange-300 border-orange-700", icon: "fa-bolt" };
                return { label: "Degen Mode", color: "bg-purple-900/60 text-purple-300 border-purple-700", icon: "fa-fire" };
            };

            const riskProfile = getRiskProfile(initialPotential);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-[#001f3f] border-2 border-[#003366] rounded-lg w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <div className="p-4 bg-[#013369] border-b border-[#003366] flex justify-between items-center sticky top-0 z-10">
                            <div>
                                <div className="flex items-center gap-3 flex-wrap">
                                    {rankBadge}
                                    <h3 className="text-xl font-bold text-white">{entry.name}</h3>
                                    {showEntryLateBadge && (
                                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider flex items-center gap-1 ${isAdminMode && (isGlobalHidden || isEntryLateHidden) ? 'bg-red-900/40 text-red-400 border border-red-800' : 'bg-red-600 text-white border border-red-500'}`}>
                                            LATE
                                            {isAdminMode && (
                                                <button 
                                                    onClick={() => onToggleEntryLateHide(entry)}
                                                    className="ml-1 w-4 h-4 flex items-center justify-center bg-black/30 rounded hover:bg-black/50"
                                                    title={isEntryLateHidden ? "Show Late Tag to Users" : "Hide Late Tag from Users"}
                                                >
                                                    <i className={`fas ${isEntryLateHidden ? 'fa-eye-slash' : 'fa-eye'} text-[8px]`}></i>
                                                </button>
                                            )}
                                        </span>
                                    )}
                                    {/* Risk Profile Badge (Phase 4b: Contextual Info) */}
                                    {riskProfile && (
                                        <span 
                                            className={`text-[10px] px-2 py-0.5 rounded border font-bold uppercase tracking-wider flex items-center gap-1 cursor-help ${riskProfile.color}`} 
                                            title={`Risk Profile: Based on Initial Max Potential Score (${initialPotential} pts). High potential indicates riskier picks.`}
                                        >
                                            <i className={`fas ${riskProfile.icon}`}></i> 
                                            {riskProfile.label}
                                            <i className="fas fa-info-circle ml-1 opacity-50 text-[8px]"></i>
                                        </span>
                                    )}
                                </div>
                                <p className="text-xs text-blue-300 mt-1 flex gap-3">
                                    <span>Current Score: <span className="text-white font-bold">{entry.currentPoints}</span></span>
                                    <span className="text-gray-500">|</span>
                                    <span>Max Possible: <span className="text-white font-bold">{entry.dynamicMax}</span></span>
                                </p>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                {hasAnyNotes && (
                                    <button 
                                        onClick={() => setShowStatusNotes(!showStatusNotes)}
                                        className={`text-xs font-bold uppercase px-3 py-1.5 rounded transition-colors border hidden sm:block ${showStatusNotes ? 'bg-blue-600 text-white border-blue-500' : 'bg-[#001122] text-blue-400 border-blue-900 hover:bg-[#002244]'}`}
                                    >
                                        <i className={`fas fa-comment-dots mr-1`}></i> Notes
                                    </button>
                                )}
                                {onMinimize && (
                                    <button onClick={handleMinimize} className="w-8 h-8 rounded flex items-center justify-center bg-[#002244] text-blue-300 hover:text-white hover:bg-blue-700 transition-colors border border-blue-900" title="Minimize">
                                        <i className="fas fa-minus"></i>
                                    </button>
                                )}
                                <button onClick={onClose} className="w-8 h-8 rounded flex items-center justify-center bg-red-900/30 text-red-400 hover:text-white hover:bg-red-700 transition-colors border border-red-900" title="Close">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div ref={scrollRef} className="overflow-y-auto p-4 space-y-3 custom-scrollbar">
                            {QUESTIONS.map(q => {
                                const userSelection = entry.selections[q.id];
                                const officialResult = officialResults[q.id];
                                const isVoid = officialResult?.isVoid || userSelection?.isAdminVoid;
                                
                                // NEW LOGIC: 
                                // If ANY result is published, the game has started -> Admin can see everything.
                                // If NO results are published, everything is hidden (anti-cheating).
                                const hasAnyResults = Object.keys(officialResults).length > 0;
                                const isHiddenForAdmin = isAdminMode && !hasAnyResults;

                                // Check if this specific question was already published when user submitted
                                // UPDATE: Only show "LATE PICK" if the result is CURRENTLY published.
                                // This ensures that unpublishing a result (e.g. simulation reset) clears the late designation.
                                const wasLatePick = entry.publishedAtSubmission && 
                                                    entry.publishedAtSubmission.includes(String(q.id)) &&
                                                    officialResults[q.id];
                                
                                const isQuestionLateHidden = userSelection?.hideLate;
                                const showQuestionLateBadge = wasLatePick && (isAdminMode || (!isGlobalHidden && !isEntryLateHidden && !isQuestionLateHidden));

                                // Logic for Puppy Bowl Sticky Note in Modal
                                const showPuppyBowlContext = q.id === 19 && 
                                    gameState?.puppyBowl && 
                                    (gameState.puppyBowl.fluff > 0 || gameState.puppyBowl.ruff > 0) &&
                                    (isAdminMode || publicNotesConfig?.puppy) &&
                                    (gameState.puppyBowl.publishStrategy === 'now' || isAdminMode || (gameState.puppyBowl.publishStrategy === 'delayed' && officialResults && officialResults[13] && !officialResults[13].isVoid));

                                // Logic for Golf Sticky Note in Modal
                                const showGolfContext = q.id === 40 && (isAdminMode || publicNotesConfig?.golf);
                                const useCustomGolf = gameState?.golf && !gameState.golf.useAuto && gameState.golf.customText;

                                let statusClass = "border-gray-700 bg-[#001122]";
                                let statusIcon = null;

                                if (userSelection) {
                                    if (isVoid) {
                                        statusClass = "border-gray-500 bg-gray-800 opacity-75";
                                        statusIcon = <span className="text-gray-400 font-bold text-xs uppercase">VOID</span>;
                                    } else if (officialResult) {
                                        if (officialResult.text === userSelection.text) {
                                            statusClass = "border-green-600 bg-green-900/20";
                                            statusIcon = <i className="fas fa-check text-green-500"></i>;
                                        } else {
                                            statusClass = "border-red-900/50 bg-red-900/10";
                                            statusIcon = <i className="fas fa-times text-red-500"></i>;
                                        }
                                    }
                                }
                                
                                let canShowNote = false;
                                if (q.id === 40 && publicNotesConfig?.golf) canShowNote = true;
                                else if (q.id === 19 && publicNotesConfig?.puppy) canShowNote = true;
                                else if (q.id !== 40 && q.id !== 19 && publicNotesConfig?.nfl && gameStarted) canShowNote = true;

                                if (publicNotesConfig?.hidden?.includes(q.id)) canShowNote = false;

                                const noteText = suggestionsMap[q.id]?.note;

                                return (
                                    <div key={q.id} className={`p-3 rounded border flex justify-between items-start gap-3 ${statusClass}`}>
                                        <div className="flex-1">
                                            <p className="text-xs text-gray-400 mb-1">
                                                {q.id}. {q.q}
                                                {showQuestionLateBadge && (
                                                    <span className={`ml-2 text-[9px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider inline-flex items-center gap-1 ${isAdminMode && (isGlobalHidden || isEntryLateHidden || isQuestionLateHidden) ? 'bg-red-900/40 text-red-400 border border-red-800' : 'bg-red-600 text-white border border-red-500'}`} title="This result was already known when entry was submitted">
                                                        LATE PICK
                                                        {isAdminMode && (
                                                            <button 
                                                                onClick={() => onToggleQuestionLateHide(entry, q.id)}
                                                                className="ml-1 w-3 h-3 flex items-center justify-center bg-black/30 rounded hover:bg-black/50"
                                                                title={isQuestionLateHidden ? "Show Late Tag" : "Hide Late Tag"}
                                                            >
                                                                <i className={`fas ${isQuestionLateHidden ? 'fa-eye-slash' : 'fa-eye'} text-[7px]`}></i>
                                                            </button>
                                                        )}
                                                    </span>
                                                )}
                                            </p>
                                            
                                            {isHiddenForAdmin ? (
                                                <div className="mt-2 text-sm text-gray-500 italic flex items-center gap-2 bg-[#000c1a] p-2 rounded border border-gray-800">
                                                    <i className="fas fa-eye-slash"></i> Selection hidden until game starts (1st result published)
                                                </div>
                                            ) : (
                                                <>
                                                    {q.options && q.options.length > 0 && q.options.length < 4 ? (
                                                        <div className="flex flex-col sm:flex-row flex-wrap gap-2 mt-2">
                                                            {q.options.map(opt => {
                                                                const isUserPick = userSelection?.text === opt.text;
                                                                const isWinner = officialResult?.text === opt.text && !officialResult?.isVoid;
                                                                const isLoser = officialResult && officialResult.text !== opt.text && !officialResult.isVoid;
                                                                
                                                                let pillClass = "px-2 py-1 text-[10px] sm:text-xs rounded border font-bold flex items-center gap-1 transition-all ";
                                                                let icon = null;

                                                                if (isWinner && isUserPick) {
                                                                    pillClass += "bg-green-900/80 border-green-500 text-white shadow-[0_0_8px_rgba(34,197,94,0.4)]";
                                                                    icon = <i className="fas fa-check-circle text-green-400"></i>;
                                                                } else if (isWinner) {
                                                                    pillClass += "bg-green-900/30 border-green-700 text-green-400";
                                                                    icon = <i className="fas fa-check text-green-500"></i>;
                                                                } else if (isUserPick && officialResult && !isVoid) {
                                                                    pillClass += "bg-red-900/60 border-red-500 text-white opacity-75";
                                                                    icon = <i className="fas fa-times-circle text-red-400"></i>;
                                                                } else if (isUserPick) {
                                                                    pillClass += "bg-[#013369] border-[#D50A0A] text-white";
                                                                    icon = <i className="fas fa-user-circle text-blue-300"></i>;
                                                                } else if (isLoser) {
                                                                     pillClass += "bg-gray-800/50 border-gray-700 text-gray-500 opacity-50";
                                                                } else {
                                                                    pillClass += "bg-[#001122] border-[#003366] text-gray-400";
                                                                }

                                                                if (isVoid) {
                                                                    pillClass = "bg-gray-800 border-gray-600 text-gray-500 opacity-50 px-2 py-1 text-[10px] sm:text-xs rounded border font-bold flex items-center gap-1";
                                                                    if (isUserPick) icon = <i className="fas fa-minus-circle"></i>;
                                                                }

                                                                return (
                                                                    <span key={opt.text} className={pillClass}>
                                                                        {icon} {opt.text}
                                                                    </span>
                                                                );
                                                            })}
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-col mt-1 gap-1">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-white text-sm">
                                                                    {userSelection ? userSelection.text : <span className="text-gray-500 italic">No Pick</span>}
                                                                </span>
                                                                {userSelection?.points && <span className="text-[10px] bg-[#000c1a] px-1.5 py-0.5 rounded text-blue-300">{userSelection.points} pts</span>}
                                                            </div>
                                                            {officialResult && !officialResult.isVoid && (
                                                                <div className="text-xs text-green-400 font-bold bg-green-900/20 px-2 py-1 rounded border border-green-800 self-start">
                                                                    <i className="fas fa-check-circle mr-1"></i> Result: {officialResult.text}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </>
                                            )}

                                            {showStatusNotes && canShowNote && noteText && (
                                                <div className="mt-3 text-xs bg-[#000c1a] p-2 rounded border border-blue-900/50 text-blue-300 font-mono">
                                                    <i className="fas fa-info-circle mr-1 text-blue-500"></i> {noteText}
                                                </div>
                                            )}

                                            {showStatusNotes && showGolfContext && (
                                                <div className="mt-2 text-xs bg-[#001122] border border-green-800/50 rounded p-2">
                                                    <p className="text-[10px] text-green-400 font-bold uppercase tracking-wider mb-1 flex justify-between items-center">
                                                        <span><i className="fas fa-golf-ball mr-1"></i> WM Phoenix Open</span>
                                                        <span className="text-[9px] text-gray-500 ml-2">{golfRound || 'Live'}</span>
                                                    </p>
                                                    
                                                    {useCustomGolf ? (
                                                        <p className="text-xs text-white font-mono">{gameState.golf.customText}</p>
                                                    ) : golfError ? (
                                                        <p className="text-xs text-red-400 italic">{golfError}</p>
                                                    ) : golfData && golfData.length > 0 ? (
                                                        <div className="grid grid-cols-1 gap-1 text-xs font-mono max-h-32 overflow-y-auto custom-scrollbar pr-2">
                                                            {golfData.map((g, idx) => (
                                                                <div key={idx} className="flex justify-between gap-2">
                                                                    <span className="text-white truncate flex items-center">
                                                                        {g.isWinner && <i className="fas fa-star text-yellow-500 text-[8px] mr-1"></i>}
                                                                        {g.name}
                                                                    </span>
                                                                    <span className="whitespace-nowrap shrink-0">
                                                                        <span className={g.scoreVal < 0 ? "text-[#D50A0A] font-bold" : "text-gray-300"}>{g.scoreStr}</span>
                                                                        <span className="text-gray-500 text-[9px] ml-1 w-6 inline-block text-right">{g.thru === 'F' ? 'F' : g.thru}</span>
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className="text-xs text-gray-500 italic">Leaderboard loading...</p>
                                                    )}
                                                </div>
                                            )}

                                            {showStatusNotes && showPuppyBowlContext && (
                                                <div className="mt-2 text-xs bg-[#001122] border border-[#D50A0A]/50 rounded p-2">
                                                    <p className="text-[10px] text-[#D50A0A] font-bold uppercase tracking-wider mb-1"><i className="fas fa-paw mr-1"></i> Puppy Bowl Result</p>
                                                    <p className="text-xs text-white font-mono">
                                                        Fluff {gameState.puppyBowl.fluff} - Ruff {gameState.puppyBowl.ruff} <span className="text-blue-300 ml-1">| Margin: {Math.abs(gameState.puppyBowl.fluff - gameState.puppyBowl.ruff)}</span>
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-col items-end gap-2 shrink-0">
                                            {statusIcon}
                                            {isAdminMode && userSelection && !isHiddenForAdmin && (
                                                <button 
                                                    onClick={() => onToggleVoid(entry, q.id)}
                                                    className="text-[10px] uppercase font-bold text-blue-400 hover:text-white border border-blue-900 px-1 rounded bg-[#000c1a]"
                                                >
                                                    {userSelection.isAdminVoid ? "Unvoid" : "Void Pick"}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const StandingsView = ({ db, appId, officialResults, gameState, golfData, golfError, golfRound, suggestionsMap, gameStarted, standingsState, updateStandingsState }) => {
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // --- PHASE 3, STEP 5: Remove Local State & Map Props ---
            // Read from Parent State
            const { viewingEntryId, isMinimized, modalScroll } = standingsState;

            // --- PHASE 3, STEP 6: Update Handlers to use Parent Updater ---
            
            const publicNotesConfig = gameState?.publicNotesConfig || { nfl: true, golf: true, puppy: true, hidden: [] };
            
            // Grading Status Logic
            const gradedCount = Object.keys(officialResults).length;
            const totalQuestions = QUESTIONS.length;
            const isFullyGraded = gradedCount === totalQuestions;
            const isOfficial = gameState?.isOfficial || false;

            useEffect(() => {
                if (!db) return;
                
                // Fetch ALL entries
                const q = window.firebaseModules.query(
                    window.firebaseModules.collection(db, 'artifacts', appId, 'public', 'data', 'prop_bets')
                );

                const unsubEntries = window.firebaseModules.onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        const entry = { id: doc.id, ...doc.data() };
                        // Filter out hidden entries locally
                        if (!entry.hidden) {
                            data.push(entry);
                        }
                    });
                    setEntries(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching standings:", error);
                    setLoading(false);
                });

                return () => unsubEntries();
            }, [db, appId]);

            const calculatedEntries = useMemo(() => {
                return entries.map(entry => {
                    let currentPoints = 0;
                    let dynamicMax = 0;
                    let hasVoids = false;
                    
                    Object.keys(entry.selections).forEach(qId => {
                        const userSelection = entry.selections[qId];
                        const userPick = userSelection.text;
                        const officialResult = officialResults[qId];
                        const points = userSelection.points || 0;
                        const isAdminVoid = userSelection.isAdminVoid; 
                        
                        if (isAdminVoid) {
                            hasVoids = true;
                        }
                        
                        if (officialResult) {
                            if (!officialResult.isVoid && !isAdminVoid) {
                                if (officialResult.text === userPick) {
                                    currentPoints += points;
                                    dynamicMax += points;
                                }
                            }
                        } else {
                            if (!isAdminVoid) {
                                dynamicMax += points;
                            }
                        }
                    });

                    return { ...entry, currentPoints, dynamicMax, hasVoids };
                }).sort((a, b) => {
                    // Primary Sort: Score (High to Low)
                    if (b.currentPoints !== a.currentPoints) {
                        return b.currentPoints - a.currentPoints;
                    }
                    // Secondary Sort: Name (A to Z) - Keeps list clean when scores are tied (e.g. 0-0 start)
                    const nameA = a.name || "";
                    const nameB = b.name || "";
                    return nameA.localeCompare(nameB);
                });
            }, [entries, officialResults]);

            // Updated to use destructured variable
            const activeEntry = useMemo(() => 
                viewingEntryId ? calculatedEntries.find(e => e.id === viewingEntryId) : null
            , [viewingEntryId, calculatedEntries]);

            // Updated to use destructured variable
            const activeRank = useMemo(() => 
                viewingEntryId ? calculatedEntries.findIndex(e => e.id === viewingEntryId) + 1 : 0
            , [viewingEntryId, calculatedEntries]);

            const handleEntryClick = (entry) => {
                if (!gameStarted) return;
                updateStandingsState({ viewingEntryId: entry.id, isMinimized: false, modalScroll: 0 });
            };

            const handleMinimize = (scrollPos) => {
                updateStandingsState({ modalScroll: scrollPos, isMinimized: true });
            };

            const handleRestore = () => {
                updateStandingsState({ isMinimized: false });
            };

            const handleCloseEntry = () => {
                updateStandingsState({ viewingEntryId: null, isMinimized: false, modalScroll: 0 });
            };

            // Determine if we should show ranks
            const highestScore = calculatedEntries.length > 0 ? calculatedEntries[0].currentPoints : 0;
            const showRanks = highestScore > 0;

            if (loading) return <div className="text-center p-8 text-blue-200">Loading Standings...</div>;

            if (entries.length === 0) {
                return (
                    <div className="text-center p-8 border border-[#003366] rounded-lg bg-[#001f3f]">
                        <p className="text-xl text-white mb-2">No Entries Yet</p>
                        <p className="text-blue-300">Be the first to submit picks!</p>
                    </div>
                );
            }

            return (
                <div className="space-y-4 animate-fade-in relative">
                    {!gameStarted && (
                        <div className="bg-blue-900/30 border border-blue-500/30 p-3 rounded text-sm text-center text-blue-200 mb-2">
                            <i className="fas fa-lock mr-2"></i> Picks are hidden until the first result is published.
                        </div>
                    )}
                    
                    {/* Status Banner */}
                    <div className={`rounded-lg border p-3 flex flex-col items-center justify-center text-center shadow-lg ${isOfficial ? 'bg-yellow-600/20 border-yellow-500' : isFullyGraded ? 'bg-blue-900/40 border-blue-400' : 'bg-[#001122] border-[#003366]'}`}>
                        {isOfficial ? (
                            <div className="animate-pulse">
                                <h4 className="text-yellow-400 font-black text-lg uppercase tracking-widest"><i className="fas fa-trophy mr-2"></i> Official Final Standings</h4>
                                <p className="text-yellow-200/70 text-xs mt-1">All results have been certified.</p>
                            </div>
                        ) : isFullyGraded ? (
                            <div>
                                <h4 className="text-white font-black text-lg uppercase tracking-widest">Unofficial Final Standings</h4>
                                <p className="text-blue-300 text-xs mt-1">Pending admin certification.</p>
                            </div>
                        ) : (
                            <div className="w-full">
                                <div className="flex justify-between items-end mb-1">
                                    <span className="text-xs text-blue-300 font-bold uppercase tracking-wider">Grading Progress</span>
                                    <span className="text-xs text-white font-mono">{gradedCount} / {totalQuestions}</span>
                                </div>
                                <div className="h-2 bg-[#000c1a] rounded-full overflow-hidden border border-[#003366]">
                                    <div className="h-full bg-green-500 transition-all duration-500" style={{width: `${(gradedCount / totalQuestions) * 100}%`}}></div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="bg-[#001f3f] border border-[#003366] rounded-lg overflow-hidden">
                        <div className="p-4 bg-[#013369] border-b border-[#003366] flex justify-between items-center">
                            <h3 className="text-lg font-bold text-white">Leaderboard</h3>
                            <span className="text-xs text-blue-300 uppercase font-bold">{entries.length} Entries</span>
                        </div>
                        <div className="divide-y divide-[#003366]">
                            <div className="bg-[#001122] p-2 flex justify-between text-xs text-blue-400 font-bold uppercase tracking-wider">
                                <span className="pl-14">Participant</span>
                                <span>Score</span>
                            </div>
                            {calculatedEntries.map((entry, index) => (
                                <div 
                                    key={entry.id} 
                                    onClick={() => handleEntryClick(entry)}
                                    className={`p-4 flex justify-between items-center transition-colors relative ${gameStarted ? 'cursor-pointer hover:bg-[#002a55]' : 'cursor-default opacity-90'}`}
                                >
                                    <div className="flex items-center gap-4">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm absolute left-3 ${showRanks ? (index === 0 ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20' : index === 1 ? 'bg-gray-400 text-black' : index === 2 ? 'bg-orange-700 text-white' : 'bg-[#000c1a] text-blue-400 border border-blue-900') : 'bg-[#000c1a] text-gray-600 border border-gray-800'}`}>
                                            {showRanks ? index + 1 : '-'}
                                        </div>
                                        <div className="pl-10">
                                            <div className="flex items-center gap-2">
                                                <p className="font-bold text-white text-lg">{entry.name}</p>
                                                {/* LATE BADGE REMOVED FROM LIST VIEW PER REQUEST */}
                                                {entry.originalName && <span className="text-gray-500 text-[10px] hidden sm:inline">({entry.originalName})</span>}
                                                {entry.hasVoids && <span style={{backgroundColor:'#4a5568', color:'white', fontSize:'10px', padding:'2px 4px', borderRadius:'4px', fontWeight:'bold'}}>VOID*</span>}
                                            </div>
                                            {gameStarted && <p className="text-xs text-blue-400">Max Potential: {entry.dynamicMax}</p>}
                                        </div>
                                    </div>
                                    <div className="text-right flex flex-col items-end">
                                        <p className="text-3xl font-black text-[#D50A0A] leading-none">{entry.currentPoints}</p>
                                        {gameStarted && <span className="text-[10px] text-blue-500 uppercase mt-1">View Details <i className="fas fa-chevron-right ml-1"></i></span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {activeEntry && !isMinimized && (
                        <EntryDetailModal 
                            entry={activeEntry} 
                            rank={activeRank}
                            officialResults={officialResults} 
                            onClose={handleCloseEntry} 
                            onMinimize={handleMinimize}
                            initialScroll={modalScroll}
                            suggestionsMap={suggestionsMap}
                            publicNotesConfig={publicNotesConfig}
                            gameStarted={gameStarted}
                            gameState={gameState}
                            golfData={golfData}
                            golfError={golfError}
                            golfRound={golfRound}
                        />
                    )}

                    {activeEntry && isMinimized && (
                        <div 
                            className="fixed bottom-4 right-4 z-50 bg-[#013369] border border-[#004488] shadow-2xl rounded-lg overflow-hidden flex flex-col w-64 animate-fade-in"
                            onClick={handleRestore}
                        >
                            <div className="p-3 flex justify-between items-center cursor-pointer hover:bg-[#012a55] transition-colors">
                                <div>
                                    <p className="text-xs text-blue-300 uppercase font-bold">Viewing Entry</p>
                                    <p className="text-white font-bold truncate">{activeEntry.name}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={(e) => { e.stopPropagation(); handleRestore(); }} className="w-6 h-6 rounded flex items-center justify-center bg-blue-600 text-white hover:bg-blue-500">
                                        <i className="fas fa-expand-alt text-xs"></i>
                                    </button>
                                    <button onClick={(e) => { e.stopPropagation(); handleCloseEntry(); }} className="w-6 h-6 rounded flex items-center justify-center bg-red-900/50 text-red-300 hover:bg-red-800 hover:text-white">
                                        <i className="fas fa-times text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div className="bg-[#001122] p-2 flex justify-between items-center text-xs">
                                <span className="text-gray-400 flex items-center gap-1">
                                    Score
                                    {gameStarted && <span className="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse" title="Live Updates Active"></span>}
                                </span>
                                <span className="text-[#D50A0A] font-black text-lg transition-all duration-300">{activeEntry.currentPoints}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminView = ({ db, appId, officialResults, gameState, nflStatusHook, suggestionsMap, demoMode, setDemoMode, golfData, golfError, golfRound, adminTab, isAdminAuthenticated, setIsAdminAuthenticated }) => {
            const [adminKey, setAdminKey] = useState("");
            // isAuthenticated state lifted to parent App component
            const [caretVisible, setCaretVisible] = useState(false);
            const [results, setResults] = useState(officialResults); 
            const [loading, setLoading] = useState(false);
            const [allEntries, setAllEntries] = useState([]);
            const [editingEntryId, setEditingEntryId] = useState(null); 
            const [entryToDelete, setEntryToDelete] = useState(null); 
            const [showPublishConfirm, setShowPublishConfirm] = useState(false); 
            const pwInputRef = useRef(null);
            
            // Notes State - Now an Array
            const [notesList, setNotesList] = useState([]);
            const [newNoteText, setNewNoteText] = useState("");
            const [editingNoteId, setEditingNoteId] = useState(null);
            const [editingNoteText, setEditingNoteText] = useState("");
            const [noteToDelete, setNoteToDelete] = useState(null); // Added state for note deletion
            
            const [saveStatus, setSaveStatus] = useState({}); 
            
            // --- NEW: INLINE RENAME STATE ---
            const [renamingId, setRenamingId] = useState(null);
            const [renameValue, setRenameValue] = useState("");
            
            // Local state for metadata forms
            const [puppyScores, setPuppyScores] = useState({ fluff: '', ruff: '', publishStrategy: 'now' });
            
            // Default config for Golf
            const defaultGolfConfig = { 
                useAuto: true,
                useProxy: false,
                eventId: '401811931', 
                customText: '' 
            };
            const [golfConfig, setGolfConfig] = useState(defaultGolfConfig);
            const [nflGameId, setNflGameId] = useState("401772988"); 

            // Suggestion Toggle State
            const [suggestionsEnabled, setSuggestionsEnabled] = useState(true);
            const [autoGradeEnabled, setAutoGradeEnabled] = useState(false);
            const [autoPublishEnabled, setAutoPublishEnabled] = useState(false);
            
            // TEST MODE CONFIG - Granular controls
            const [testConfig, setTestConfig] = useState({
                entries: true,
                nfl: true,
                puppy: true
            });

            // PHASE 1: Access Control State
            const [accessConfig, setAccessConfig] = useState({
                submissionStatus: 'open', // open, closed, scheduled
                openTimestamp: '',
                questionsHidden: false
            });
            
            const [collapsedSuggestions, setCollapsedSuggestions] = useState({}); 
            
            // Public Notes State 
            const [publicNotesConfig, setPublicNotesConfig] = useState({ nfl: true, golf: true, puppy: true, hidden: [] }); 
            
            // Payment State
            const [paymentConfig, setPaymentConfig] = useState({ methodName: 'Venmo', identifier: '@Joey_Novak', fee: 10, note: '' });
            
            // Rules State
            const [rulesConfig, setRulesConfig] = useState({ 
                payouts: "1st Place: 100%", 
                ties: "Ties split the pot.",
                lateHeader: "Late Entries & Forfeiture",
                late: "Entries submitted after the National Anthem require Admin approval via a Late Key. Questions with outcomes determined prior to submission are subject to forfeiture.",
                goodLuck: "Good Luck To All Participants!",
                disclaimer: "Rules and payouts subject to change. Check back here for official updates."
            });

            // Scrolling Message State
            const [scrollingMessage, setScrollingMessage] = useState("");

            // Duplicate IP Calculation
            const ipCounts = useMemo(() => {
                const counts = {};
                allEntries.forEach(entry => {
                    if (entry.ipAddress && entry.ipAddress !== "Unknown" && entry.ipAddress !== "No IP") {
                        counts[entry.ipAddress] = (counts[entry.ipAddress] || 0) + 1;
                    }
                });
                return counts;
            }, [allEntries]);

            // TASK 4: Session Helper
            const refreshSession = () => {
                if (isAdminAuthenticated) {
                    localStorage.setItem('sb60_admin_session', Date.now().toString());
                }
            };

            // --- SIMULATION HANDLER ---
            const handleSimulationChange = async (mode) => {
                refreshSession();
                
                // 1. Reset/Unpublish existing results first
                if (db && window.firebaseModules) {
                    try {
                        const { doc, setDoc } = window.firebaseModules;
                        console.log("Resetting results for simulation...");
                        // Clear database
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_results', 'summary'), { 
                            results: {}, 
                            lastUpdated: Date.now() 
                        });
                        // Clear local state immediately to reflect unpublish
                        setResults({});
                    } catch (e) {
                        console.error("Simulation reset failed", e);
                    }
                }

                // 2. Change Simulation Mode
                setDemoMode(mode);

                // 3. Force Enable Automation (Auto-Grade & Auto-Publish) to "then publish" new results
                if (mode !== 'off') {
                    setSuggestionsEnabled(true);
                    setAutoGradeEnabled(true);
                    setAutoPublishEnabled(true);
                    
                    // Persist these settings so the Auto-Publish useEffect kicks in
                    if (db && window.firebaseModules) {
                        const { doc, setDoc } = window.firebaseModules;
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'config'), { 
                            suggestionsEnabled: true,
                            autoGradeEnabled: true,
                            autoPublishEnabled: true,
                            nflGameId: nflGameId // Persist current ID
                        }, { merge: true });
                    }
                }
            };
            
            // Notes Fetcher (Updated for Array)
            useEffect(() => {
                if (isAdminAuthenticated && db && appId) {
                    const { doc, onSnapshot } = window.firebaseModules;
                    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'admin_notes'), (snap) => {
                        if (snap.exists()) {
                            const data = snap.data();
                            if (data.notesList && Array.isArray(data.notesList)) {
                                setNotesList(data.notesList);
                            } else if (data.notes) {
                                // Migration: Convert old string note to list
                                setNotesList([{ id: Date.now(), text: data.notes, timestamp: Date.now() }]);
                            }
                        }
                    }, (error) => {
                        console.warn("Admin notes permission error (expected if not admin):", error.code);
                    });
                    return () => unsub();
                }
            }, [isAdminAuthenticated, db, appId]);
            
            const saveNotesList = async (updatedList) => {
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'admin_notes'), { notesList: updatedList }, { merge: true });
            };

            const handleAddNote = () => {
                if (!newNoteText.trim()) return;
                const newNote = {
                    id: Date.now(),
                    text: newNoteText,
                    timestamp: Date.now()
                };
                const updated = [newNote, ...notesList];
                setNotesList(updated); // Optimistic update
                setNewNoteText("");
                saveNotesList(updated);
            };

            const handleDeleteNote = (note) => {
                setNoteToDelete(note);
            };

            const performDeleteNote = () => {
                if (!noteToDelete) return;
                const updated = notesList.filter(n => n.id !== noteToDelete.id);
                setNotesList(updated);
                saveNotesList(updated);
                setNoteToDelete(null);
            };

            const startEditNote = (note) => {
                setEditingNoteId(note.id);
                setEditingNoteText(note.text);
            };

            const cancelEditNote = () => {
                setEditingNoteId(null);
                setEditingNoteText("");
            };

            const saveEditNote = () => {
                const updated = notesList.map(n => n.id === editingNoteId ? { ...n, text: editingNoteText } : n);
                setNotesList(updated);
                setEditingNoteId(null);
                saveNotesList(updated);
            };
            
            const handleCertifyOfficial = async () => {
                if (!confirm("Are you sure? This will mark the standings as OFFICIAL FINAL.")) return false;
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'config'), { isOfficial: true }, { merge: true });
                return true;
            };
            
            const generatePuppyScore = () => {
                const isFluffWinner = Math.random() > 0.5;
                const winnerScore = Math.floor(Math.random() * (85 - 55 + 1)) + 55; // 55 to 85
                const margin = Math.floor(Math.random() * (7 - 2 + 1)) + 2; // 2 to 7
                const loserScore = winnerScore - margin;
                
                setPuppyScores({
                    ...puppyScores,
                    fluff: isFluffWinner ? winnerScore : loserScore,
                    ruff: isFluffWinner ? loserScore : winnerScore
                });
            };

            // Session check logic moved to App component

            useEffect(() => {
                // Auto-focus input on mount if not authenticated
                if (!isAdminAuthenticated && pwInputRef.current) {
                    pwInputRef.current.focus();
                    setCaretVisible(false); // Ensure hidden on auto-focus
                }
            }, [isAdminAuthenticated]);

            // Save Handler Wrapper
            const handleSave = async (key, saveFn) => {
                refreshSession();
                setSaveStatus(prev => ({ ...prev, [key]: 'saving' }));
                try {
                    const res = await saveFn();
                    if (res === false) {
                        setSaveStatus(prev => ({ ...prev, [key]: 'idle' }));
                        return;
                    }
                    setSaveStatus(prev => ({ ...prev, [key]: 'saved' }));
                    setTimeout(() => setSaveStatus(prev => ({ ...prev, [key]: 'idle' })), 2000);
                } catch (e) {
                    console.error("Save failed:", e);
                    setSaveStatus(prev => ({ ...prev, [key]: 'idle' }));
                    alert("Failed to save.");
                }
            };

            // Auto-Grade Logic
            useEffect(() => {
                if (!autoGradeEnabled || Object.keys(suggestionsMap).length === 0) return;
                
                setResults(prev => {
                    let newResults = { ...prev };
                    let hasChanges = false;
                    
                    Object.keys(suggestionsMap).forEach(qId => {
                        const sugg = suggestionsMap[qId];
                        const qIdStr = String(qId); // Ensure strict string comparison

                        // 1. UPDATE: Suggestion is Final -> Publish/Update Result
                        if (sugg.isFinal && sugg.text !== "Waiting...") {
                            const current = newResults[qId];
                            
                            // Check if text changed, if it was voided, or if score objects differ
                            const isTextDiff = current?.text !== sugg.text;
                            const isVoidDiff = current?.isVoid; // If currently void, we overwrite with valid grade
                            const isScoreDiff = sugg.scores && JSON.stringify(current?.scores) !== JSON.stringify(sugg.scores);

                            if (!current || isTextDiff || isVoidDiff || isScoreDiff) {
                                newResults[qId] = { text: sugg.text, isVoid: false };
                                if (sugg.scores) {
                                    newResults[qId].scores = sugg.scores;
                                }
                                hasChanges = true;
                            }
                        }
                        // 2. REVERT: Suggestion is NO LONGER Final (Data correction/Reversion)
                        // Specifically for dynamic targets: Puppy Bowl (19), Golf (40), Exact Score (60)
                        // If automation is on, and the data reverts to "In Progress", we must unpublish the previous grade.
                        else if (!sugg.isFinal && (qIdStr === "19" || qIdStr === "40" || qIdStr === "60")) {
                            if (newResults[qId]) {
                                delete newResults[qId]; // Remove from local results
                                hasChanges = true;
                            }
                        }
                    });
                    
                    return hasChanges ? newResults : prev;
                });
            }, [suggestionsMap, autoGradeEnabled]);
            
            // Auto-Publish Logic
            const isFirstMount = useRef(true);
            useEffect(() => {
                if (isFirstMount.current) {
                    isFirstMount.current = false;
                    return;
                }
                
                if (!autoPublishEnabled) return;
                
                // Prevent publishing if it matches live database exactly
                if (JSON.stringify(results) === JSON.stringify(officialResults)) return;

                const timeout = setTimeout(() => {
                    if (db && appId) {
                        const { doc, setDoc } = window.firebaseModules;
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_results', 'summary'), { results: results, lastUpdated: Date.now() })
                        .catch(console.error);
                    }
                }, 2500); // 2.5s debounce

                return () => clearTimeout(timeout);
            }, [results, autoPublishEnabled, db, appId, officialResults]);

            // Load admin data when authenticated (handles both manual login AND auto-session restore)
            useEffect(() => {
                if (isAdminAuthenticated && db) {
                    const { doc, getDoc, query, collection, onSnapshot } = window.firebaseModules;
                    
                    // Fetch Results
                    getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_results', 'summary')).then(snap => {
                        if(snap.exists()) setResults(snap.data().results || {});
                    }).catch(e => console.warn("Results fetch error", e.code));

                    // Fetch Entries
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'prop_bets'));
                    const unsub = onSnapshot(q, (snap) => {
                        const data = [];
                        snap.forEach(d => data.push({id: d.id, ...d.data()}));
                        data.sort((a,b) => b.timestamp - a.timestamp);
                        setAllEntries(data);
                    }, (e) => console.warn("Entries fetch error (expected if not admin)", e.code));
                    
                    return () => unsub();
                }
            }, [isAdminAuthenticated, db, appId]);

            useEffect(() => {
                // Multi-Admin Sync Logic: If officialResults changes (another admin published),
                // we want to merge that into our local state IF we haven't touched that specific question.
                
                if(Object.keys(results).length === 0 && Object.keys(officialResults).length > 0) {
                    setResults(officialResults);
                } else if (Object.keys(officialResults).length > 0) {
                    setResults(prev => {
                        const next = { ...prev };
                        let changed = false;
                        Object.keys(officialResults).forEach(key => {
                            if (!next[key]) {
                                next[key] = officialResults[key];
                                changed = true;
                            }
                        });
                        return changed ? next : prev;
                    });
                }

                if (gameState?.puppyBowl) {
                    setPuppyScores(prev => ({...prev, ...gameState.puppyBowl}));
                }
                if (gameState?.golf) {
                    setGolfConfig(prev => ({...prev, ...gameState.golf}));
                }
                if (gameState?.nflGameId) {
                    setNflGameId(gameState.nflGameId);
                }
                if (gameState?.publicNotesConfig) {
                    setPublicNotesConfig(gameState.publicNotesConfig);
                }
                if (gameState?.payment) {
                    setPaymentConfig(prev => ({ ...prev, ...gameState.payment }));
                }
                if (gameState?.rules) {
                    setRulesConfig(gameState.rules);
                }
                if (gameState?.scrollingMessage) {
                    setScrollingMessage(gameState.scrollingMessage);
                }
                if (typeof gameState?.suggestionsEnabled !== 'undefined') setSuggestionsEnabled(gameState.suggestionsEnabled);
                if (typeof gameState?.autoGradeEnabled !== 'undefined') setAutoGradeEnabled(gameState.autoGradeEnabled);
                if (typeof gameState?.autoPublishEnabled !== 'undefined') setAutoPublishEnabled(gameState.autoPublishEnabled);
                
                if (gameState?.testConfig) {
                    setTestConfig(gameState.testConfig);
                } else if (typeof gameState?.testFeaturesEnabled !== 'undefined') {
                    // Backward compatibility / Migration
                    const val = gameState.testFeaturesEnabled;
                    setTestConfig({ entries: val, nfl: val, puppy: val });
                }
                
                // PHASE 1: Populate Access Config
                if (gameState?.access) {
                    setAccessConfig(prev => ({...prev, ...gameState.access}));
                }
            }, [officialResults, gameState]);

            const handleLogin = () => {
                if (adminKey.trim().toLowerCase() === "sb60") {
                    setIsAdminAuthenticated(true);
                    localStorage.setItem('sb60_admin_session', Date.now().toString()); // Set session
                    // Data loading is now handled by useEffect
                } else {
                    alert("Invalid Admin Key");
                }
            };
            
            const handleToggleCollapseSuggestion = (id) => {
                refreshSession();
                setCollapsedSuggestions(prev => ({...prev, [id]: !prev[id]}));
            }
            
            const handleTogglePublicNoteVisibility = (id) => {
                refreshSession();
                setPublicNotesConfig(prev => {
                    const hidden = prev.hidden || [];
                    const newHidden = hidden.includes(id) ? hidden.filter(qid => qid !== id) : [...hidden, id];
                    const newConfig = { ...prev, hidden: newHidden };
                    
                    // Auto-save to db when toggled to avoid extra clicks
                    if (db) {
                         const { doc, setDoc } = window.firebaseModules;
                         setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'config'), { publicNotesConfig: newConfig }, { merge: true });
                    }
                    
                    return newConfig;
                });
            }

            const handleSeedData = async () => {
                refreshSession();
                
                if (!db) { 
                    console.error("No DB Connection found in AdminView");
                    return; 
                }
                
                setLoading(true);
                try {
                    // Ensure modules are available
                    if (!window.firebaseModules) throw new Error("Firebase modules not loaded");
                    const { collection, addDoc } = window.firebaseModules;

                    // Generate random selections
                    const selections = {};
                    let totalPoints = 0;
                    QUESTIONS.forEach(q => {
                        // Pick random option
                        if (q.options && q.options.length > 0) {
                            const randomOpt = q.options[Math.floor(Math.random() * q.options.length)];
                            selections[q.id] = { text: randomOpt.text, points: randomOpt.points || 1 };
                            totalPoints += (randomOpt.points || 1);
                        } else if (q.type === 'score') {
                            selections[q.id] = { text: "Patriots 24, Seahawks 21", points: 60, scores: { patriots: 24, seahawks: 21 } }; 
                            totalPoints += 60;
                        }
                    });

                    // Determine late status based on officialResults prop
                    const publishedIds = Object.keys(officialResults);
                    const isLate = publishedIds.length > 0;

                    // Add to Firestore
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'prop_bets'), {
                        name: `TEST BOT ${Math.floor(Math.random() * 1000)}`,
                        selections: selections,
                        potentialPoints: totalPoints,
                        timestamp: Date.now(),
                        hidden: false,
                        late: isLate,
                        publishedAtSubmission: publishedIds,
                        ipAddress: "No IP"
                    });
                    
                } catch (e) {
                    console.error("Seed Error:", e);
                }
                setLoading(false);
            };

            const handleResultSelect = (qId, text) => {
                refreshSession();
                setResults(prev => {
                    if (prev[qId]?.text === text && !prev[qId].isVoid) {
                        const newResults = { ...prev };
                        delete newResults[qId];
                        return newResults;
                    }
                    return { ...prev, [qId]: { text, isVoid: false } };
                });
            };

            const handleResultScore = (qId, team, value) => {
                refreshSession();
                setResults(prev => {
                    const currentScores = prev[qId]?.scores || {};
                    const newScores = { ...currentScores, [team]: value };
                    return {
                        ...prev,
                        [qId]: {
                            text: `Patriots: ${newScores.patriots || '0'}, Seahawks: ${newScores.seahawks || '0'}`,
                            scores: newScores,
                            isVoid: false
                        }
                    };
                });
            };

            // TASK 5: Proper Void State Handling
            const handleVoid = (qId) => {
                refreshSession();
                setResults(prev => {
                    const isCurrentlyVoid = prev[qId]?.isVoid;
                    if (isCurrentlyVoid) {
                        const newResults = { ...prev };
                        delete newResults[qId]; // Return to ungraded state rather than keeping text="VOID"
                        return newResults;
                    } else {
                        return { ...prev, [qId]: { text: "VOID", isVoid: true } };
                    }
                });
            };

            const handleRestoreResult = (qId) => {
                refreshSession();
                if (officialResults[qId]) {
                    setResults(prev => ({ ...prev, [qId]: officialResults[qId] }));
                }
            };
            
            const toggleEntryVisibility = async (e, entry) => {
                e.stopPropagation();
                if (!db || !window.firebaseModules) return;
                refreshSession();
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'prop_bets', entry.id), { hidden: !entry.hidden });
                } catch(e) { console.error(e); alert("Failed to toggle visibility: " + e.message); }
            };

            const toggleEntryVoidAnswer = async (entry, qId) => {
                if (!db || !window.firebaseModules) return;
                refreshSession();
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    const currentSelection = entry.selections[qId] || {}; // Handle undefined nicely
                    const currentVoidState = currentSelection.isAdminVoid || false;
                    const updatedSelection = { ...currentSelection, isAdminVoid: !currentVoidState };
                    const updatedSelections = { ...entry.selections, [qId]: updatedSelection };
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'prop_bets', entry.id), { selections: updatedSelections });
                } catch(e) { console.error(e); alert("Failed to toggle void: " + e.message); }
            };

            const toggleEntryLateHide = async (entry) => {
                if (!db || !window.firebaseModules) return;
                refreshSession();
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'prop_bets', entry.id), { hideLate: !entry.hideLate });
                } catch(e) { console.error(e); alert("Failed to toggle entry late visibility"); }
            };

            const toggleQuestionLateHide = async (entry, qId) => {
                if (!db || !window.firebaseModules) return;
                refreshSession();
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    const currentSelection = entry.selections[qId] || {};
                    const currentHideState = currentSelection.hideLate || false;
                    const updatedSelection = { ...currentSelection, hideLate: !currentHideState };
                    const updatedSelections = { ...entry.selections, [qId]: updatedSelection };
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'prop_bets', entry.id), { selections: updatedSelections });
                } catch(e) { console.error(e); alert("Failed to toggle question late visibility"); }
            };

            const requestDelete = (e, entry) => {
                e.stopPropagation();
                setEntryToDelete(entry);
            };

            const confirmDelete = async () => {
                if (!entryToDelete || !db || !window.firebaseModules) return;
                refreshSession();
                
                const { doc, deleteDoc } = window.firebaseModules;

                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'prop_bets', entryToDelete.id));
                    setEntryToDelete(null);
                } catch(err) { 
                    console.error("Delete failed:", err); 
                }
            };
            
            // --- REPLACED: Inline Rename Functions ---
            const startRename = (entry) => {
                refreshSession();
                setRenamingId(entry.id);
                setRenameValue(entry.name);
            };

            const cancelRename = () => {
                setRenamingId(null);
                setRenameValue("");
            };

            const saveRename = async (entry) => {
                if (!db || !window.firebaseModules) return;
                refreshSession();
                
                const newName = renameValue.toUpperCase().trim();
                
                // Validation
                if (!newName) {
                    alert("Name cannot be empty.");
                    return;
                }
                if (newName === entry.name) {
                    cancelRename();
                    return;
                }
                
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    // Logic: If originalName exists, keep it. If not, the current name BECOMES the original name.
                    const originalName = entry.originalName || entry.name;
                    
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'prop_bets', entry.id), { 
                        name: newName, 
                        originalName: originalName 
                    });
                    
                    cancelRename(); // Close edit mode on success
                } catch(e) { 
                    console.error(e); 
                    alert("Rename Failed: " + e.message); 
                }
            };

            // REPLACED: publishResults with request/perform pattern to avoid window.confirm
            const requestPublish = () => {
                refreshSession();
                setShowPublishConfirm(true);
            };

            const performPublish = () => {
                setShowPublishConfirm(false);
                handleSave('publish', async () => {
                    const { doc, updateDoc, setDoc, deleteField } = window.firebaseModules;
                    
                    // MULTI-ADMIN PATCH STRATEGY
                    const updates = { lastUpdated: Date.now() };
                    let hasChanges = false;

                    // 1. Check for new or changed results in local state
                    Object.keys(results).forEach(key => {
                        const localVal = results[key];
                        const officialVal = officialResults[key];
                        
                        const isDifferent = !officialVal || 
                                            localVal.text !== officialVal.text || 
                                            localVal.isVoid !== officialVal.isVoid ||
                                            JSON.stringify(localVal.scores) !== JSON.stringify(officialVal.scores);
                        
                        if (isDifferent) {
                            updates[`results.${key}`] = localVal;
                            hasChanges = true;
                        }
                    });

                    // 2. Check for deletions (present in official but missing in local)
                    Object.keys(officialResults).forEach(key => {
                        if (!results[key]) {
                            updates[`results.${key}`] = deleteField();
                            hasChanges = true;
                        }
                    });

                    if (!hasChanges) {
                        return true; // Nothing to do
                    }

                    const summaryRef = doc(db, 'artifacts', appId, 'public', 'data', 'game_results', 'summary');

                    try {
                        await updateDoc(summaryRef, updates); 
                    } catch (err) {
                        // If doc missing, create it then update
                        // 'not-found' is the code, checking string for safety
                        if (err.code === 'not-found' || err.toString().includes("No document to update")) {
                            await setDoc(summaryRef, { results: {} }); // Initialize
                            await updateDoc(summaryRef, updates);
                        } else {
                            throw err;
                        }
                    }
                    return true;
                });
            };

            // Unified Config Updater
            const updateConfig = async (updates) => {
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'config'), updates, { merge: true });
            };

            if (!isAdminAuthenticated) {
                // ... login form ...
                return (
                    <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-4">
                        <h2 className="text-2xl font-bold text-white uppercase">Admin Access</h2>
                        <input 
                            ref={pwInputRef}
                            type="password" 
                            value={adminKey}
                            onChange={(e) => { setAdminKey(e.target.value); setCaretVisible(true); }}
                            onKeyDown={(e) => { setCaretVisible(true); e.key === 'Enter' && handleLogin(); }}
                            onClick={() => setCaretVisible(true)}
                            placeholder="Enter Admin Key"
                            style={{ caretColor: caretVisible ? 'auto' : 'transparent' }}
                            className="p-3 bg-[#000c1a] border border-[#013369] rounded text-white text-center focus:border-[#D50A0A] outline-none transition-all duration-300"
                        />
                        <button onClick={handleLogin} className="bg-[#D50A0A] px-6 py-2 rounded text-white font-bold uppercase">Login</button>
                    </div>
                );
            }
            
            const unhiddenCount = allEntries.filter(e => !e.hidden).length;
            const totalPot = unhiddenCount * (paymentConfig.fee || 10);
            
            const gradedCount = Object.keys(officialResults).length;
            const totalQuestions = QUESTIONS.length;
            const canCertify = gradedCount === totalQuestions;
            const hasPublishedResults = Object.keys(officialResults).length > 0;

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    {/* Navigation moved to parent App component for sticky behavior */}
                    
                    {adminTab === 'entries' && (
                        // ... entries tab content ...
                        <div className="space-y-4 animate-fade-in">
                            <div className="flex justify-between items-center mb-2 flex-wrap gap-2">
                                <h3 className="text-xl font-bold text-white uppercase flex items-center gap-2">
                                    <i className="fas fa-users text-blue-400"></i> All Entries
                                    <span className="text-xs bg-[#001122] text-green-400 px-2 py-1 rounded border border-green-900 ml-2">Total Pot: ${totalPot} ({unhiddenCount} Entries)</span>
                                </h3>
                                <div className="flex gap-2">
                                    {testConfig.entries && (
                                        <button 
                                            type="button"
                                            onClick={() => { handleSeedData(); }}
                                            disabled={loading}
                                            className={`text-xs px-3 py-1.5 rounded text-white uppercase font-bold transition-colors ${loading ? 'bg-gray-600 cursor-wait' : 'bg-gray-700 hover:bg-gray-600 border border-gray-600'}`}
                                        >
                                            <i className="fas fa-robot mr-1"></i> {loading ? "Generating..." : "Generate Test Entry"}
                                        </button>
                                    )}
                                    {hasPublishedResults && (
                                        <button 
                                            type="button"
                                            onClick={() => generatePrintWindow(allEntries.filter(e => !e.hidden))}
                                            className="text-xs px-3 py-1.5 rounded text-white uppercase font-bold transition-colors bg-blue-600 hover:bg-blue-500 border border-blue-500 shadow-lg"
                                        >
                                            <i className="fas fa-print mr-1"></i> Print All
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="bg-[#001f3f] rounded-lg border border-[#003366] overflow-hidden">
                                {allEntries.map(entry => {
                                    // Calculate permission for styling only (logic is in handler)
                                    const lowerName = (entry.name || "").toLowerCase();
                                    const isRestricted = !lowerName.startsWith('test') && !lowerName.startsWith('delete');
                                    const isRenaming = renamingId === entry.id;
                                    
                                    // IP Check
                                    const ipCount = ipCounts[entry.ipAddress] || 0;
                                    const isSuspicious = ipCount > 1;

                                    // Calculate score for admin view
                                    let currentScore = 0;
                                    let hasVoids = false;
                                    Object.keys(entry.selections).forEach(qId => {
                                        const sel = entry.selections[qId];
                                        const res = results[qId]; // Use local 'results' state which tracks officialResults
                                        if (sel.isAdminVoid) hasVoids = true;
                                        if (res && !res.isVoid && !sel.isAdminVoid && res.text === sel.text) {
                                            currentScore += (sel.points || 0);
                                        }
                                    });

                                    return (
                                        <div 
                                            key={entry.id} 
                                            onClick={() => setEditingEntryId(entry.id)}
                                            className="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-[#003366] last:border-0 hover:bg-[#002a55] gap-3 cursor-pointer transition-colors"
                                        >
                                            <div className="flex items-center gap-3 flex-1 w-full">
                                                <div className="w-full">
                                                    {isRenaming ? (
                                                        <div className="flex items-center gap-2 w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                                            <input 
                                                                type="text" 
                                                                value={renameValue}
                                                                onChange={(e) => setRenameValue(e.target.value)}
                                                                className="flex-1 bg-[#000c1a] border border-blue-500 rounded p-1 text-white font-bold uppercase text-sm focus:outline-none"
                                                                autoFocus
                                                                placeholder="ENTER NAME"
                                                            />
                                                        </div>
                                                    ) : (
                                                        <p className={`font-bold flex items-center gap-2 ${entry.hidden ? 'text-gray-500 line-through' : 'text-white'}`}>
                                                            {entry.name}
                                                            {entry.originalName && <span className="text-gray-500 text-xs font-normal">({entry.originalName})</span>}
                                                            {entry.late && (
                                                                <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold uppercase flex items-center gap-1 transition-colors ${entry.hideLate ? 'bg-red-900/40 text-red-400 border border-red-800' : 'bg-red-600 text-white border border-red-500'}`} onClick={e => e.stopPropagation()}>
                                                                    LATE
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); toggleEntryLateHide(entry); }}
                                                                        className="ml-1 w-4 h-4 flex items-center justify-center bg-black/30 rounded hover:bg-black/50 transition-colors"
                                                                        title={entry.hideLate ? "Show Late Tags to Users" : "Hide All Late Tags for this Entry"}
                                                                    >
                                                                        <i className={`fas ${entry.hideLate ? 'fa-eye-slash' : 'fa-eye'} text-[8px]`}></i>
                                                                    </button>
                                                                </span>
                                                            )}
                                                            {hasVoids && <span style={{backgroundColor:'#4a5568', color:'white', fontSize:'10px', padding:'2px 4px', borderRadius:'4px', fontWeight:'bold'}}>VOID*</span>}
                                                        </p>
                                                    )}
                                                    <div className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 mt-1">
                                                        <p className="text-xs text-blue-300 font-bold">Current Score: {currentScore}</p>
                                                        <div className="hidden sm:block w-1 h-1 bg-gray-600 rounded-full"></div>
                                                        <div className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3">
                                                            <p className="text-xs text-gray-400">{new Date(entry.timestamp).toLocaleString('en-US')}</p>
                                                            <div className="hidden sm:block w-1 h-1 bg-gray-600 rounded-full"></div>
                                                            <span className="text-[10px] text-gray-500 font-mono flex items-center gap-1" title="User IP Address">
                                                                {entry.ipAddress || "No IP"}
                                                                {isSuspicious && <i className="fas fa-exclamation-triangle text-yellow-500 animate-pulse" title={`Duplicate IP Detected: Used ${ipCount} times`}></i>}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 w-full sm:w-auto justify-end">
                                                {hasPublishedResults && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); generatePrintWindow(entry); }}
                                                        className="p-2 rounded w-8 h-8 flex items-center justify-center bg-blue-600 text-white hover:bg-blue-500 transition-colors shadow-sm" 
                                                        title="Print Entry"
                                                    >
                                                        <i className="fas fa-print text-xs"></i>
                                                    </button>
                                                )}

                                                {isRenaming ? (
                                                    <>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); saveRename(entry); }}
                                                            className="p-2 rounded w-8 h-8 flex items-center justify-center bg-green-600 text-white hover:bg-green-500 transition-colors shadow-lg" 
                                                            title="Save Name"
                                                        >
                                                            <i className="fas fa-check text-xs"></i>
                                                        </button>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); cancelRename(); }}
                                                            className="p-2 rounded w-8 h-8 flex items-center justify-center bg-gray-600 text-white hover:bg-gray-500 transition-colors" 
                                                            title="Cancel Rename"
                                                        >
                                                            <i className="fas fa-times text-xs"></i>
                                                        </button>
                                                    </>
                                                ) : (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); startRename(entry); }}
                                                        className="p-2 rounded w-8 h-8 flex items-center justify-center bg-[#003366] text-blue-300 hover:text-white hover:bg-blue-800 transition-colors" 
                                                        title="Rename Entry"
                                                    >
                                                        <i className="fas fa-pen text-xs"></i>
                                                    </button>
                                                )}
                                                
                                                <button onClick={(e) => toggleEntryVisibility(e, entry)} className={`p-2 rounded w-8 h-8 flex items-center justify-center ${entry.hidden ? 'bg-gray-700 text-gray-400 hover:text-white' : 'bg-[#003366] text-blue-300 hover:text-white'}`} title={entry.hidden ? "Unhide Entry" : "Hide Entry"}>
                                                    <i className={`fas ${entry.hidden ? 'fa-eye-slash' : 'fa-eye'} text-sm`}></i>
                                                </button>

                                                <button 
                                                    onClick={(e) => requestDelete(e, entry)}
                                                    disabled={isRestricted}
                                                    className={`p-2 rounded w-8 h-8 flex items-center justify-center transition-colors ${isRestricted ? 'bg-gray-800 text-gray-600 cursor-not-allowed opacity-50' : 'bg-red-900/30 text-red-400 hover:bg-red-600 hover:text-white'}`} 
                                                    title={isRestricted ? "Protected Entry" : "Delete Entry"}
                                                >
                                                    <i className="fas fa-trash-alt text-xs"></i>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                                {allEntries.length === 0 && <div className="p-8 text-center text-gray-500">No entries yet.</div>}
                            </div>
                        </div>
                    )}

                    {adminTab === 'grading' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="bg-[#D50A0A] p-4 rounded text-white text-center font-bold uppercase shadow-lg flex justify-between items-center">
                                <span>Select Winning Outcomes</span>
                                {autoPublishEnabled && <span className="text-xs bg-red-900 border border-red-400 px-2 py-1 rounded shadow animate-pulse"><i className="fas fa-broadcast-tower mr-1"></i> Auto-Publish Active</span>}
                            </div>
                            
                            <div className="space-y-6 pb-10">
                                {QUESTIONS.map((q) => (
                                    <QuestionCard 
                                        key={q.id} 
                                        q={q} 
                                        userSelection={results[q.id]} 
                                        onSelect={handleResultSelect} 
                                        onScoreChange={handleResultScore} 
                                        onVoid={handleVoid}
                                        onRestore={handleRestoreResult}
                                        highlight={!!results[q.id]} 
                                        isAdmin={true}
                                        gameState={gameState}
                                        publicNotesConfig={publicNotesConfig}
                                        golfData={golfData}
                                        golfError={golfError}
                                        officialResults={officialResults}
                                        golfRound={golfRound}
                                        suggestion={suggestionsMap[q.id]}
                                        showSuggestions={suggestionsEnabled}
                                        isCollapsed={collapsedSuggestions[q.id]}
                                        onToggleCollapse={handleToggleCollapseSuggestion}
                                        onTogglePublicNote={handleTogglePublicNoteVisibility}
                                    />
                                ))}
                            </div>

                            <div className="fixed bottom-0 left-0 right-0 p-4 bg-[#001f3f]/95 border-t border-[#003366] backdrop-blur-md flex justify-center z-30">
                                <button onClick={requestPublish} disabled={loading} className={`max-w-md w-full py-3 px-6 rounded font-black uppercase tracking-wider transition-all shadow-lg ${saveStatus.publish === 'saved' ? 'bg-green-500 text-white' : 'bg-green-600 hover:bg-green-500 text-white'}`}>
                                    {saveStatus.publish === 'saved' ? <><i className="fas fa-check mr-2"></i>Published!</> : loading ? 'Publishing...' : autoPublishEnabled ? 'Publish (Auto-Active)' : 'Publish Live Results'}
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {adminTab === 'notes' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-4 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-sticky-note mr-2 text-yellow-500"></i> Admin Notepad</span>
                                </h3>
                                
                                {/* Add Note Input */}
                                <div className="flex gap-2 mb-6">
                                    <input 
                                        type="text" 
                                        value={newNoteText}
                                        onChange={(e) => setNewNoteText(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleAddNote()}
                                        placeholder="Type a new note here..."
                                        className="flex-1 p-3 bg-[#000c1a] border border-[#003366] rounded text-white focus:border-blue-500 focus:outline-none"
                                    />
                                    <button 
                                        onClick={handleAddNote}
                                        disabled={!newNoteText.trim()}
                                        className="px-4 py-2 bg-blue-600 text-white font-bold uppercase rounded hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Add
                                    </button>
                                </div>

                                {/* Notes List */}
                                <div className="space-y-3">
                                    {notesList.length === 0 && <p className="text-gray-500 text-center italic py-4">No notes yet.</p>}
                                    {notesList.map((note) => (
                                        <div key={note.id} className="bg-[#001122] p-3 rounded border border-[#003366] group flex justify-between items-start gap-3 hover:border-blue-800 transition-colors">
                                            {editingNoteId === note.id ? (
                                                <div className="flex-1 flex gap-2">
                                                    <input 
                                                        type="text" 
                                                        value={editingNoteText}
                                                        onChange={(e) => setEditingNoteText(e.target.value)}
                                                        className="flex-1 p-1 bg-[#000c1a] border border-blue-500 rounded text-white text-sm"
                                                        autoFocus
                                                    />
                                                    <button onClick={saveEditNote} className="p-1 text-green-400 hover:text-green-300"><i className="fas fa-check"></i></button>
                                                    <button onClick={cancelEditNote} className="p-1 text-red-400 hover:text-red-300"><i className="fas fa-times"></i></button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex-1">
                                                        <p className="text-white text-sm whitespace-pre-wrap">{note.text}</p>
                                                        <p className="text-[10px] text-gray-500 mt-1">{new Date(note.timestamp).toLocaleString()}</p>
                                                    </div>
                                                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={() => startEditNote(note)}
                                                            className="text-blue-400 hover:text-white p-1" 
                                                            title="Edit"
                                                        >
                                                            <i className="fas fa-pen text-xs"></i>
                                                        </button>
                                                        <button 
                                                            onClick={() => handleDeleteNote(note)}
                                                            className="text-red-400 hover:text-white p-1" 
                                                            title="Delete"
                                                        >
                                                            <i className="fas fa-trash text-xs"></i>
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Note Confirmation Modal */}
                    {noteToDelete && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={() => setNoteToDelete(null)}>
                            <div className="bg-[#001f3f] border-2 border-red-600 rounded-lg w-full max-w-sm p-6 text-center shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white uppercase mb-2">Delete Note?</h3>
                                <p className="text-blue-200 mb-6 text-sm">
                                    Are you sure you want to delete this note?<br/>
                                    <span className="text-gray-400 italic">"{noteToDelete.text.substring(0, 30)}{noteToDelete.text.length > 30 ? '...' : ''}"</span>
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setNoteToDelete(null)}
                                        className="flex-1 py-3 rounded font-bold uppercase bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={performDeleteNote}
                                        className="flex-1 py-3 rounded font-bold uppercase bg-red-600 text-white hover:bg-red-500 transition-colors shadow-lg"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Entry Confirmation Modal */}
                    {entryToDelete && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={() => setEntryToDelete(null)}>
                            <div className="bg-[#001f3f] border-2 border-red-600 rounded-lg w-full max-w-sm p-6 text-center shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white uppercase mb-2">Delete Entry?</h3>
                                <p className="text-blue-200 mb-6 text-sm">
                                    Are you sure you want to delete this entry?<br/>
                                    <span className="text-white font-bold text-lg block mt-2">{entryToDelete.name}</span>
                                    <span className="text-xs text-red-400 mt-1 block">This action cannot be undone.</span>
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setEntryToDelete(null)}
                                        className="flex-1 py-3 rounded font-bold uppercase bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={confirmDelete}
                                        className="flex-1 py-3 rounded font-bold uppercase bg-red-600 text-white hover:bg-red-500 transition-colors shadow-lg"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {adminTab === 'settings' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="bg-blue-900/40 border border-blue-500/50 p-4 rounded-lg text-sm text-blue-200 shadow-inner">
                                <h4 className="font-bold text-white mb-2 uppercase border-b border-blue-500/30 pb-1">Admin Info</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><span className="block text-xs text-blue-400">Late Exemption Key:</span><span className="font-mono font-bold text-white bg-black/30 px-2 py-0.5 rounded">LATE60</span></div>
                                    <div><span className="block text-xs text-blue-400">Delete Keywords:</span><span className="font-mono font-bold text-white bg-black/30 px-2 py-0.5 rounded">TEST*, DELETE*</span></div>
                                </div>
                            </div>
                            
                            {/* PHASE 1: Contest Access Control */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-lock mr-2 text-red-400"></i> Contest Access Control</span>
                                    <SaveButton saveKey="access" onClick={() => handleSave('access', () => updateConfig({ access: accessConfig }))} saveStatus={saveStatus} />
                                </h3>
                                
                                <div className="space-y-4">
                                    {/* Visibility Toggle */}
                                    <label className="flex items-center gap-3 cursor-pointer p-3 bg-[#001122] border border-[#003366] rounded hover:border-blue-500 transition-colors">
                                        <div className={`w-10 h-5 rounded-full relative transition-colors ${accessConfig.questionsHidden ? 'bg-red-600' : 'bg-green-600'}`}>
                                            <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${accessConfig.questionsHidden ? 'right-1' : 'left-1'}`}></div>
                                        </div>
                                        <input type="checkbox" className="hidden" checked={accessConfig.questionsHidden} onChange={e => setAccessConfig({...accessConfig, questionsHidden: e.target.checked})} />
                                        <div>
                                            <span className="text-white text-sm font-bold block">Hide Questions from Public</span>
                                            <span className="text-xs text-gray-400">If hidden, users see a "Coming Soon" message instead of the prop sheet.</span>
                                        </div>
                                    </label>

                                    {/* Submission Status */}
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-2 font-bold uppercase">Submission Status</label>
                                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                            <button 
                                                onClick={() => setAccessConfig({...accessConfig, submissionStatus: 'open'})}
                                                className={`p-2 rounded text-sm font-bold border transition-all ${accessConfig.submissionStatus === 'open' ? 'bg-green-600 text-white border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'bg-[#000c1a] text-gray-400 border-[#003366] hover:border-gray-500'}`}
                                            >
                                                <i className="fas fa-door-open mr-1"></i> Open Now
                                            </button>
                                            <button 
                                                onClick={() => setAccessConfig({...accessConfig, submissionStatus: 'closed'})}
                                                className={`p-2 rounded text-sm font-bold border transition-all ${accessConfig.submissionStatus === 'closed' ? 'bg-red-600 text-white border-red-500 shadow-[0_0_10px_rgba(220,38,38,0.4)]' : 'bg-[#000c1a] text-gray-400 border-[#003366] hover:border-gray-500'}`}
                                            >
                                                <i className="fas fa-ban mr-1"></i> Closed
                                            </button>
                                            <button 
                                                onClick={() => setAccessConfig({...accessConfig, submissionStatus: 'scheduled'})}
                                                className={`p-2 rounded text-sm font-bold border transition-all ${accessConfig.submissionStatus === 'scheduled' ? 'bg-blue-600 text-white border-blue-500 shadow-[0_0_10px_rgba(37,99,235,0.4)]' : 'bg-[#000c1a] text-gray-400 border-[#003366] hover:border-gray-500'}`}
                                            >
                                                <i className="fas fa-clock mr-1"></i> Scheduled
                                            </button>
                                        </div>
                                    </div>

                                    {/* Schedule Picker */}
                                    {accessConfig.submissionStatus === 'scheduled' && (
                                        <div className="p-3 bg-[#000c1a] border border-blue-900/50 rounded animate-fade-in">
                                            <label className="block text-xs text-blue-300 mb-1">Open Date & Time</label>
                                            <input 
                                                type="datetime-local" 
                                                value={accessConfig.openTimestamp}
                                                onChange={e => setAccessConfig({...accessConfig, openTimestamp: e.target.value})}
                                                className="w-full p-2 bg-[#001f3f] border border-[#003366] rounded text-white text-sm focus:border-blue-500 outline-none"
                                            />
                                            <p className="text-[10px] text-gray-500 mt-1">
                                                Submissions will remain CLOSED until this time. Users will see a countdown or the open time.
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Payment Settings */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-dollar-sign mr-2 text-green-400"></i> Payment Settings</span>
                                    <SaveButton saveKey="payment" onClick={() => handleSave('payment', () => updateConfig({ payment: paymentConfig }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Payment Method Name</label>
                                        <input 
                                            type="text" 
                                            value={paymentConfig.methodName} 
                                            onChange={e => setPaymentConfig({...paymentConfig, methodName: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="e.g. Venmo, Cash, PayPal" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Entry Fee ($)</label>
                                        <input 
                                            type="number" 
                                            value={paymentConfig.fee} 
                                            onChange={e => setPaymentConfig({...paymentConfig, fee: parseInt(e.target.value) || 0})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="0 for Free Mode" 
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs text-blue-400 mb-1">Recipient / Handle / Instructions</label>
                                        <input 
                                            type="text" 
                                            value={paymentConfig.identifier} 
                                            onChange={e => setPaymentConfig({...paymentConfig, identifier: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="e.g. @username or 'Pay Host'" 
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs text-blue-400 mb-1">Additional Note (Optional)</label>
                                        <input 
                                            type="text" 
                                            value={paymentConfig.note} 
                                            onChange={e => setPaymentConfig({...paymentConfig, note: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="e.g. Please include emoji in payment note" 
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Scrolling Message Settings */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-scroll mr-2 text-orange-400"></i> Scrolling Banner Message</span>
                                    <SaveButton saveKey="scrolling" onClick={() => handleSave('scrolling', () => updateConfig({ scrollingMessage }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="space-y-2">
                                    <label className="block text-xs text-blue-400">Message (leave empty to disable)</label>
                                    <input 
                                        type="text" 
                                        value={scrollingMessage} 
                                        onChange={e => setScrollingMessage(e.target.value)} 
                                        className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                        placeholder="e.g. Submissions closing at kickoff! Venmo payments due now!" 
                                    />
                                    <p className="text-[10px] text-gray-500">This message will scroll continuously at the top of the user app.</p>
                                </div>
                            </div>

                            {/* Game Rules Settings */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-gavel mr-2 text-yellow-500"></i> Game Rules</span>
                                    <SaveButton saveKey="rules" onClick={() => handleSave('rules', () => updateConfig({ rules: rulesConfig }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="grid grid-cols-1 gap-4">
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Payout Structure</label>
                                        <textarea 
                                            value={rulesConfig.payouts || rulesConfig.winner} 
                                            onChange={e => setRulesConfig({...rulesConfig, payouts: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="e.g. 1st Place: 70%, 2nd Place: 30%" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Tie Rule</label>
                                        <input 
                                            type="text" 
                                            value={rulesConfig.ties} 
                                            onChange={e => setRulesConfig({...rulesConfig, ties: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="Ties split the pot." 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Custom Alert / Notice Header</label>
                                        <input 
                                            type="text" 
                                            value={rulesConfig.lateHeader || ""} 
                                            onChange={e => setRulesConfig({...rulesConfig, lateHeader: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="e.g. Late Entries & Forfeiture" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Custom Alert / Notice Text</label>
                                        <textarea 
                                            value={rulesConfig.late} 
                                            onChange={e => setRulesConfig({...rulesConfig, late: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm h-20" 
                                            placeholder="Enter any important notice here. Clear to hide." 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Good Luck Message</label>
                                        <input 
                                            type="text" 
                                            value={rulesConfig.goodLuck} 
                                            onChange={e => setRulesConfig({...rulesConfig, goodLuck: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="Good Luck To All Participants!" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-blue-400 mb-1">Footer Disclaimer</label>
                                        <input 
                                            type="text" 
                                            value={rulesConfig.disclaimer} 
                                            onChange={e => setRulesConfig({...rulesConfig, disclaimer: e.target.value})} 
                                            className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm" 
                                            placeholder="* Rules and payouts subject to change..." 
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Game Certification */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366] border-l-4 border-l-yellow-500">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-certificate mr-2 text-yellow-500"></i> Game Certification</span>
                                </h3>
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div>
                                        <p className="text-xs text-blue-300 mb-1">Mark results as "Official" once all questions are graded.</p>
                                        <div className="text-sm text-white">
                                            Grading Progress: <span className={canCertify ? "text-green-400 font-bold" : "text-yellow-500 font-bold"}>{gradedCount} / {totalQuestions}</span>
                                        </div>
                                    </div>
                                    <SaveButton 
                                        saveKey="certify" 
                                        onClick={handleCertifyOfficial} 
                                        disabled={!canCertify} 
                                        saveStatus={saveStatus}
                                    />
                                </div>
                            </div>
                            
                            {/* NFL Manager */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-football-ball mr-2 text-blue-400"></i> NFL Game Tracker</span>
                                    <SaveButton saveKey="nfl" onClick={() => handleSave('nfl', () => updateConfig({ nflGameId, suggestionsEnabled, autoGradeEnabled, autoPublishEnabled, publicNotesConfig }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="mb-2">
                                    <div className="flex justify-between items-end mb-1">
                                        <label className="block text-xs text-blue-400">ESPN Game ID</label>
                                        <a href={`https://site.web.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${nflGameId}`} target="_blank" rel="noopener noreferrer" className="text-[10px] text-blue-500 hover:text-white uppercase font-bold flex items-center gap-1">
                                            View JSON <i className="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                    <input type="text" value={nflGameId} onChange={e => setNflGameId(e.target.value)} className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm font-mono" placeholder="e.g. 401547758" />
                                    <p className="text-xs text-gray-500 mt-1">Found in ESPN scoreboard URL.</p>
                                </div>
                                
                                <div className="mt-4 pt-4 border-t border-[#003366] grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* LIVE AUTOMATION COLUMN */}
                                    <div className="space-y-3">
                                        <h4 className="text-xs font-black text-green-400 uppercase tracking-widest border-b border-green-900/30 pb-1">Live Automation</h4>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" checked={suggestionsEnabled} onChange={e => setSuggestionsEnabled(e.target.checked)} />
                                            <span className="text-white text-sm font-bold">Enable Auto-Suggestions</span>
                                        </label>
                                        
                                        {suggestionsEnabled && (
                                            <div className="pl-6 space-y-2 border-l border-[#003366] ml-1">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" checked={autoGradeEnabled} onChange={e => setAutoGradeEnabled(e.target.checked)} />
                                                    <span className="text-blue-200 text-sm">Auto-Grade Final Results</span>
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" checked={autoPublishEnabled} onChange={e => setAutoPublishEnabled(e.target.checked)} />
                                                    <span className="text-blue-200 text-sm">Auto-Publish Live Updates</span>
                                                </label>
                                                {autoPublishEnabled && <p className="text-[10px] text-yellow-500 italic">Warning: Updates database automatically.</p>}
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex flex-col items-end gap-2">
                                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${nflStatusHook === 'success' ? 'bg-green-900/50 text-green-400 border border-green-700' : nflStatusHook === 'error' ? 'bg-red-900/50 text-red-400 border border-red-700' : 'bg-gray-800 text-gray-400'}`}>
                                            Status: {nflStatusHook === 'idle' ? 'Idle' : nflStatusHook === 'loading' ? 'Connecting...' : nflStatusHook === 'success' ? 'Connected' : 'Error'}
                                        </span>
                                    </div>
                                </div>
                                
                                {testConfig.nfl && (
                                    <div className="flex flex-col gap-2 mt-4 p-2 bg-yellow-900/30 border border-yellow-700/50 rounded">
                                        <span className="text-white text-sm font-bold flex items-center gap-2"><i className="fas fa-flask text-yellow-500"></i> Simulation</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleSimulationChange('off')} className={`flex-1 py-1 rounded text-xs font-bold uppercase transition-colors ${demoMode === 'off' ? 'bg-gray-200 text-black' : 'bg-gray-800 text-gray-400 hover:text-white'}`}>OFF</button>
                                            <button onClick={() => handleSimulationChange('on')} className={`flex-1 py-1 rounded text-xs font-bold uppercase transition-colors ${demoMode === 'on' ? 'bg-yellow-600 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}`}>ON</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Public Notes Display Settings */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-users mr-2 text-blue-400"></i> Public Visibility Settings</span>
                                    <SaveButton saveKey="notes" onClick={() => handleSave('notes', () => updateConfig({ publicNotesConfig }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="space-y-3">
                                    <p className="text-xs text-blue-300 mb-2">Control what information users see in the entry detail views.</p>
                                    
                                    {/* LATE TAG GLOBAL TOGGLE */}
                                    <label className="flex items-center gap-3 cursor-pointer p-2 bg-red-900/20 border border-red-900/30 rounded hover:bg-red-900/30 transition-colors">
                                        <input type="checkbox" checked={publicNotesConfig.hideLateTags} onChange={e => setPublicNotesConfig({...publicNotesConfig, hideLateTags: e.target.checked})} className="w-4 h-4 accent-red-500" />
                                        <div>
                                            <span className="text-white text-sm font-bold block">Hide ALL "LATE" Tags from Users</span>
                                            <span className="text-xs text-gray-400">If checked, no LATE tags will be shown to non-admins anywhere.</span>
                                        </div>
                                    </label>

                                    <div className="h-px bg-[#003366] my-2"></div>

                                    <label className="flex items-center gap-3 cursor-pointer p-2 hover:bg-[#002244] rounded transition-colors">
                                        <input type="checkbox" checked={publicNotesConfig.golf} onChange={e => setPublicNotesConfig({...publicNotesConfig, golf: e.target.checked})} className="w-4 h-4" />
                                        <span className="text-white text-sm font-bold">Show Golf Leaderboard to Users</span>
                                    </label>
                                    <label className="flex items-center gap-3 cursor-pointer p-2 hover:bg-[#002244] rounded transition-colors">
                                        <input type="checkbox" checked={publicNotesConfig.puppy} onChange={e => setPublicNotesConfig({...publicNotesConfig, puppy: e.target.checked})} className="w-4 h-4" />
                                        <span className="text-white text-sm font-bold">Show Puppy Bowl Score to Users</span>
                                    </label>
                                    <label className="flex items-center gap-3 cursor-pointer p-2 hover:bg-[#002244] rounded transition-colors">
                                        <input type="checkbox" checked={publicNotesConfig.nfl} onChange={e => setPublicNotesConfig({...publicNotesConfig, nfl: e.target.checked})} className="w-4 h-4" />
                                        <div>
                                            <span className="text-white text-sm font-bold block">Show NFL Play-by-Play Notes to Users</span>
                                            <span className="text-xs text-gray-500">Will only display after the game has started.</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            {/* Puppy Bowl */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-paw mr-2 text-blue-400"></i> Puppy Bowl Manager</span>
                                    <SaveButton saveKey="puppy" onClick={() => handleSave('puppy', () => updateConfig({ puppyBowl: { fluff: parseInt(puppyScores.fluff)||0, ruff: parseInt(puppyScores.ruff)||0, publishStrategy: puppyScores.publishStrategy } }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div className="flex items-center gap-2">
                                        <label className="text-xs text-blue-400 w-16">Fluff:</label>
                                        <input type="number" value={puppyScores.fluff} onChange={e => setPuppyScores({...puppyScores, fluff: e.target.value})} className="w-20 p-1 bg-[#000c1a] border border-[#003366] rounded text-white text-center" />
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <label className="text-xs text-blue-400 w-16">Ruff:</label>
                                        <input type="number" value={puppyScores.ruff} onChange={e => setPuppyScores({...puppyScores, ruff: e.target.value})} className="w-20 p-1 bg-[#000c1a] border border-[#003366] rounded text-white text-center" />
                                    </div>
                                </div>
                                {testConfig.puppy && (
                                    <div className="flex gap-2 mb-4">
                                        <button onClick={() => setPuppyScores({...puppyScores, fluff: 73, ruff: 69})} className="flex-1 bg-gray-700 hover:bg-gray-600 text-xs text-white py-1 rounded border border-gray-600">
                                            Set Final Score (73-69)
                                        </button>
                                        <button onClick={generatePuppyScore} className="flex-1 bg-gray-700 hover:bg-gray-600 text-xs text-white py-1 rounded border border-gray-600">
                                            <i className="fas fa-random mr-1"></i> Simulate
                                        </button>
                                    </div>
                                )}
                                <div>
                                    <label className="block text-xs text-blue-400 mb-2">Publish Strategy</label>
                                    <div className="flex gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="puppyStrategy" value="now" checked={puppyScores.publishStrategy === 'now'} onChange={() => setPuppyScores({...puppyScores, publishStrategy: 'now'})} />
                                            <span className="text-white text-sm">Publish Immediately</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="puppyStrategy" value="delayed" checked={puppyScores.publishStrategy === 'delayed'} onChange={() => setPuppyScores({...puppyScores, publishStrategy: 'delayed'})} />
                                            <span className="text-white text-sm">Wait for Q1 Odd/Even Result</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            {/* Golf */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-golf-ball mr-2 text-blue-400"></i> Golf Tracker</span>
                                    <SaveButton saveKey="golf" onClick={() => handleSave('golf', () => updateConfig({ golf: golfConfig }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="mb-4">
                                    <div className="flex items-center gap-4 mb-2">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" checked={golfConfig.useAuto} onChange={e => setGolfConfig({...golfConfig, useAuto: e.target.checked})} />
                                            <span className="text-white text-sm font-bold">Auto-Fetch</span>
                                        </label>
                                        {golfConfig.useAuto && (
                                            <>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" checked={golfConfig.useProxy} onChange={e => setGolfConfig({...golfConfig, useProxy: e.target.checked})} />
                                                    <span className="text-white text-sm">Use CORS Proxy</span>
                                                </label>
                                                <div className="flex items-center">
                                                    <input type="text" value={golfConfig.eventId} onChange={e => setGolfConfig({...golfConfig, eventId: e.target.value})} className="w-32 p-1 ml-2 bg-[#000c1a] border border-[#003366] rounded text-white text-xs font-mono text-center" placeholder="Event ID" />
                                                    <a href={`https://site.web.api.espn.com/apis/site/v2/sports/golf/leaderboard?league=pga&event=${golfConfig.eventId}`} target="_blank" rel="noopener noreferrer" className="ml-2 text-xs text-blue-400 hover:text-white" title="View Source JSON">
                                                        <i className="fas fa-external-link-alt"></i>
                                                    </a>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                    {!golfConfig.useAuto && (
                                        <div>
                                            <label className="block text-xs text-blue-400 mb-1">Custom Sticky Note Text</label>
                                            <textarea value={golfConfig.customText} onChange={e => setGolfConfig({...golfConfig, customText: e.target.value})} className="w-full p-2 bg-[#000c1a] border border-[#003366] rounded text-white text-sm h-20" placeholder="e.g., Scheffler leads by 2 strokes..."></textarea>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Test Mode & Simulations (Now Last) */}
                            <div className="bg-[#001f3f] p-4 rounded border border-[#003366]">
                                <h3 className="text-white font-bold uppercase mb-3 border-b border-[#003366] pb-2 flex items-center justify-between">
                                    <span><i className="fas fa-vial mr-2 text-yellow-500"></i> Test Mode & Simulations</span>
                                    <SaveButton saveKey="test" onClick={() => handleSave('test', () => updateConfig({ testConfig }))} saveStatus={saveStatus} />
                                </h3>
                                <div className="space-y-3">
                                    <p className="text-xs text-blue-300 mb-2">Toggle simulation features to test logic or preview app behavior.</p>
                                    <label className="flex items-center gap-3 cursor-pointer p-2 hover:bg-[#002244] rounded transition-colors">
                                        <input type="checkbox" checked={testConfig.entries} onChange={e => setTestConfig({...testConfig, entries: e.target.checked})} className="w-4 h-4 accent-yellow-500" />
                                        <div>
                                            <span className="text-white text-sm font-bold block">Enable Entry Generator</span>
                                            <span className="text-xs text-gray-500">Shows "Generate Test Entry" button in Entries tab.</span>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 cursor-pointer p-2 hover:bg-[#002244] rounded transition-colors">
                                        <input type="checkbox" checked={testConfig.nfl} onChange={e => setTestConfig({...testConfig, nfl: e.target.checked})} className="w-4 h-4 accent-yellow-500" />
                                        <div>
                                            <span className="text-white text-sm font-bold block">Enable NFL Simulations</span>
                                            <span className="text-xs text-gray-500">Shows "Simulation Modes" in NFL Game Tracker.</span>
                                        </div>
                                    </label>
                                    <label className="flex items-center gap-3 cursor-pointer p-2 hover:bg-[#002244] rounded transition-colors">
                                        <input type="checkbox" checked={testConfig.puppy} onChange={e => setTestConfig({...testConfig, puppy: e.target.checked})} className="w-4 h-4 accent-yellow-500" />
                                        <div>
                                            <span className="text-white text-sm font-bold block">Enable Puppy Bowl Simulations</span>
                                            <span className="text-xs text-gray-500">Shows "Simulate" buttons in Puppy Bowl Manager.</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ENTRY DETAIL MODAL FOR ADMIN */}
                    {editingEntryId && (
                        <EntryDetailModal 
                            entry={allEntries.find(e => e.id === editingEntryId)} 
                            officialResults={officialResults} 
                            onClose={() => setEditingEntryId(null)} 
                            isAdminMode={true}
                            onToggleVoid={toggleEntryVoidAnswer}
                            onToggleEntryLateHide={toggleEntryLateHide}
                            onToggleQuestionLateHide={toggleQuestionLateHide}
                            suggestionsMap={suggestionsMap}
                            publicNotesConfig={publicNotesConfig}
                            gameStarted={true}
                            gameState={gameState}
                            golfData={golfData}
                            golfError={golfError}
                            golfRound={golfRound}
                        />
                    )}

                    {/* Publish Confirmation Modal */}
                    {showPublishConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={() => setShowPublishConfirm(false)}>
                            <div className="bg-[#001f3f] border-2 border-yellow-500 rounded-lg w-full max-w-sm p-6 text-center shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white uppercase mb-2">Confirm Publish</h3>
                                <p className="text-blue-200 mb-6">
                                    Are you sure you want to publish these results to the live leaderboard?
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowPublishConfirm(false)}
                                        className="flex-1 py-3 rounded font-bold uppercase bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={performPublish}
                                        className="flex-1 py-3 rounded font-bold uppercase bg-green-600 text-white hover:bg-green-500 transition-colors shadow-lg"
                                    >
                                        Publish
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const ScrollingTicker = ({ message, view }) => {
            const [isVisible, setIsVisible] = useState(true);
            const prevMessage = useRef(message);
            const prevView = useRef(view);

            useEffect(() => {
                if (message !== prevMessage.current) {
                    setIsVisible(true);
                    prevMessage.current = message;
                }
                if (view !== prevView.current) {
                    setIsVisible(true);
                    prevView.current = view;
                }
            }, [message, view]);

            if (!message || !isVisible) return null;

            return (
                <div className="bg-[#D50A0A] text-white text-sm font-bold uppercase tracking-wider py-1 overflow-hidden border-b border-[#002244] relative flex items-center">
                    <div className="flex-1 overflow-hidden flex">
                        <div className="animate-scroll flex shrink-0">
                            <span className="px-8">{message}</span>
                            <span className="px-8">{message}</span>
                            <span className="px-8">{message}</span>
                            <span className="px-8">{message}</span>
                        </div>
                        <div className="animate-scroll flex shrink-0">
                            <span className="px-8">{message}</span>
                            <span className="px-8">{message}</span>
                            <span className="px-8">{message}</span>
                            <span className="px-8">{message}</span>
                        </div>
                    </div>
                    <button 
                        onClick={() => setIsVisible(false)}
                        className="absolute right-0 top-0 bottom-0 px-3 bg-[#D50A0A] hover:bg-[#b00808] z-10 flex items-center justify-center shadow-[-5px_0_10px_rgba(0,0,0,0.1)] transition-colors"
                        aria-label="Close"
                    >
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };

        // --- REUSABLE UI COMPONENTS ---
        const SimpleModal = ({ isOpen, onClose, title, children, borderColor = "border-gray-600", icon }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className={`bg-[#001f3f] border-2 ${borderColor} rounded-lg w-full max-w-sm p-6 text-center shadow-2xl relative`} onClick={e => e.stopPropagation()}>
                        {icon && (
                            <div className={`w-16 h-16 ${icon.bg || 'bg-gray-800'} rounded-full flex items-center justify-center mx-auto mb-4 border ${icon.border || borderColor}`}>
                                <i className={`fas ${icon.name} ${icon.color || 'text-white'} text-2xl`}></i>
                            </div>
                        )}
                        {title && <h3 className="text-xl font-bold text-white uppercase mb-2">{title}</h3>}
                        {children}
                    </div>
                </div>
            );
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-screen p-6 text-center">
                            <div className="bg-[#001f3f] border border-red-500 p-8 rounded-lg shadow-2xl max-w-md">
                                <i className="fas fa-bomb text-red-500 text-4xl mb-4"></i>
                                <h2 className="text-xl font-bold text-white mb-2">Something went wrong.</h2>
                                <p className="text-blue-200 mb-6 text-sm">The application encountered an unexpected error.</p>
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="bg-[#D50A0A] hover:bg-[#b00808] text-white font-bold py-2 px-6 rounded uppercase transition-colors"
                                >
                                    Refresh App
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        function App() {
            const [userSelections, setUserSelections] = useState({});
            const [userName, setUserName] = useState("");
            const [exemptionKey, setExemptionKey] = useState("");
            const [view, setView] = useState('form'); 
            const [adminTab, setAdminTab] = useState('grading'); // Lifted state for sticky nav
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false); // Lifted auth state
            const [firebaseInitialized, setFirebaseInitialized] = useState(false);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null); // NEW: Track Firebase User
            const [appId, setAppId] = useState('default-app-id');
            const [submitting, setSubmitting] = useState(false);
            const [officialResults, setOfficialResults] = useState({});
            const [gameState, setGameState] = useState(null);
            const [nameError, setNameError] = useState("");
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [showLateKeyModal, setShowLateKeyModal] = useState(false); // New Modal State
            const [showWarningModal, setShowWarningModal] = useState(false);
            const [warningMessage, setWarningMessage] = useState("");
            const [showPostSubmitModal, setShowPostSubmitModal] = useState(false);
            const [demoMode, setDemoMode] = useState('off');
            const [suggestionsMap, setSuggestionsMap] = useState({});
            const [copyFeedback, setCopyFeedback] = useState(false); // Feedback state for copy button
            
            // Phase 4: Time State for Scheduled Auto-Open
            const [currentTime, setCurrentTime] = useState(Date.now());

            // --- PHASE 1: Persistent Standings State (Lifted from StandingsView) ---
            const [standingsState, setStandingsState] = useState({
                viewingEntryId: null,
                isMinimized: false,
                modalScroll: 0
            });

            const updateStandingsState = (updates) => {
                setStandingsState(prev => ({ ...prev, ...updates }));
            };

            // Define publicNotesConfig here to fix ReferenceError
            const publicNotesConfig = gameState?.publicNotesConfig || DEFAULT_PUBLIC_NOTES;
            
            // Define paymentConfig fallback
            const paymentConfig = gameState?.payment || DEFAULT_PAYMENT;
            
            // Rules State (Fallback)
            const rulesConfig = gameState?.rules || DEFAULT_RULES;

            // Scrolling Message
            const scrollingMessage = gameState?.scrollingMessage || "";

            // PHASE 2: Access Config (Read from Game State)
            const accessConfig = gameState?.access || { submissionStatus: 'open', questionsHidden: false, openTimestamp: '' };

            // --- UNDO STATE ---
            const [backupSelections, setBackupSelections] = useState({});
            const [randomMode, setRandomMode] = useState('fill'); // 'fill' or 'undo'
            const [clearMode, setClearMode] = useState('clear'); // 'clear' or 'undo'
            
            // TASK 1: SCROLL PERSISTENCE
            const scrollPositions = useRef({});
            // TASK 2: ADMIN SCROLL PERSISTENCE
            const adminScrollPositions = useRef({});

            // Phase 4: Timer for Scheduled Open
            useEffect(() => {
                let interval;
                if (accessConfig.submissionStatus === 'scheduled') {
                    // Update every 10 seconds to catch the open time
                    interval = setInterval(() => {
                        setCurrentTime(Date.now());
                    }, 10000);
                }
                return () => clearInterval(interval);
            }, [accessConfig.submissionStatus]);

            useLayoutEffect(() => {
                const savedPosition = scrollPositions.current[view] || 0;
                // Delayed restoration to allow rendering (per Task 1 spec)
                const timeoutId = setTimeout(() => {
                    window.scrollTo(0, savedPosition);
                }, 100);
                
                return () => clearTimeout(timeoutId);
            }, [view]);

            // Admin Scroll Restoration Effect
            useLayoutEffect(() => {
                if (view === 'admin') {
                    const savedPosition = adminScrollPositions.current[adminTab] || 0;
                    const timeoutId = setTimeout(() => {
                        window.scrollTo(0, savedPosition);
                    }, 100);
                    return () => clearTimeout(timeoutId);
                }
            }, [adminTab]); // Triggers only when switching sub-tabs

            // Session Check on Mount (Lifted from AdminView)
            useEffect(() => {
                const storedSession = localStorage.getItem('sb60_admin_session');
                if (storedSession) {
                    const lastActive = parseInt(storedSession);
                    const now = Date.now();
                    // 60 minutes = 3600000 ms
                    if (now - lastActive < 3600000) {
                        setIsAdminAuthenticated(true);
                        localStorage.setItem('sb60_admin_session', now.toString()); // Refresh session
                    } else {
                        localStorage.removeItem('sb60_admin_session'); // Expired
                    }
                }
            }, []);

            // Session Timeout Interval (Lifted from AdminView)
            useEffect(() => {
                let interval;
                if (isAdminAuthenticated) {
                    interval = setInterval(() => {
                        const storedSession = localStorage.getItem('sb60_admin_session');
                        if (storedSession) {
                            const lastActive = parseInt(storedSession);
                            if (Date.now() - lastActive >= 3600000) {
                                setIsAdminAuthenticated(false);
                                localStorage.removeItem('sb60_admin_session');
                                alert("Admin session expired due to inactivity. Please log in again.");
                            }
                        }
                    }, 60000); // Check every 1 minute
                }
                return () => clearInterval(interval);
            }, [isAdminAuthenticated]);

            // Helper to save scroll before switching
            const handleTabChange = (newView) => {
                // Save current position
                scrollPositions.current[view] = window.scrollY;

                if (newView === 'form' && gameStarted) {
                    // Logic moved to button state, alert removed to be less intrusive
                }
                setView(newView);
            };

            const handleAdminTabChange = (newTab) => {
                // Save current position for the active admin tab
                adminScrollPositions.current[adminTab] = window.scrollY;
                setAdminTab(newTab);
            };

            const handleRandomToggle = () => {
                if (randomMode === 'fill') {
                    // Save current state
                    setBackupSelections(userSelections);
                    
                    // Generate Random only for missing
                    const newSelections = { ...userSelections };
                    QUESTIONS.forEach(q => {
                        if (!newSelections[q.id]) {
                            if (q.type === 'score') {
                                const p = Math.floor(Math.random() * 40) + 10;
                                const s = Math.floor(Math.random() * 40) + 10;
                                newSelections[q.id] = { 
                                    text: `Patriots: ${p}, Seahawks: ${s}`, 
                                    scores: { patriots: p, seahawks: s },
                                    points: 60
                                };
                            } else if (q.options) {
                                const randomOpt = q.options[Math.floor(Math.random() * q.options.length)];
                                newSelections[q.id] = { text: randomOpt.text, points: randomOpt.points };
                            }
                        }
                    });
                    setUserSelections(newSelections);
                    
                    // Toggle States
                    setRandomMode('undo');
                    setClearMode('clear');
                } else {
                    // Undo
                    setUserSelections(backupSelections);
                    setRandomMode('fill');
                }
            };

            const handleClearToggle = () => {
                if (clearMode === 'clear') {
                    if (Object.keys(userSelections).length === 0) return;
                    
                    // Save current state
                    setBackupSelections(userSelections);
                    
                    // Clear
                    setUserSelections({});
                    
                    // Toggle States
                    setClearMode('undo');
                    setRandomMode('fill');
                } else {
                    // Undo
                    setUserSelections(backupSelections);
                    setClearMode('clear');
                }
            };

            // Merge defaults with loaded state. If gameState is null, use default.
            const effectiveGolfConfig = gameState?.golf || DEFAULT_GOLF_CONFIG;
            
            // NFL Hook
            // Default SB60 Game ID: 401772988
            const effectiveNflId = gameState?.nflGameId || "401772988";
            
            // --- UPDATED HOOKS ---
            const { data: golfData, error: golfError, roundStatus: golfRound } = useGolfData(effectiveGolfConfig, db, appId, user, isAdminAuthenticated);
            const { status: nflStatusHook, rawData: nflRaw } = useNFLData(effectiveNflId, db, appId, user, isAdminAuthenticated);

            // Hoisted Suggestions Engine execution
            useEffect(() => {
                let effectiveNflRaw = nflRaw;
                if (demoMode === 'on') effectiveNflRaw = simulationData;

                if (effectiveNflRaw) {
                     const suggs = getSuggestions(effectiveNflRaw, gameState, golfData, golfRound);
                     setSuggestionsMap(suggs);
                }
            }, [nflRaw, demoMode, gameState, golfData, golfRound]);

            useEffect(() => {
                const initFirebase = async () => {
                    if (typeof window.firebaseModules === 'undefined') return;
                    const { initializeApp, getAuth, signInAnonymously, getFirestore, signInWithCustomToken, doc, onSnapshot, onAuthStateChanged } = window.firebaseModules;
                    
                    // Safety Check: Do we have a config?
					const __firebase_config = {
					  apiKey: "AIzaSyBU4JJdRpj-l9H0QSONWXXkbPOFHgi8ehc",
					  authDomain: "sb60-prop-bets.firebaseapp.com",
					  projectId: "sb60-prop-bets",
					  storageBucket: "sb60-prop-bets.firebasestorage.app",
					  messagingSenderId: "599388307764",
					  appId: "1:599388307764:web:5de1484d7d0af01331a561"
					};

                    try {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        
                        setAppId(currentAppId);
                        
                        // Setup Auth Listener
                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                // Only set DB after we have a user
                                setDb(firestore);

                                // Use specific documents (summary and config)
                                // IMPORTANT: Only attach listeners after we have a user
                                onSnapshot(doc(firestore, 'artifacts', currentAppId, 'public', 'data', 'game_results', 'summary'), (snap) => {
                                    if (snap.exists()) {
                                        setOfficialResults(snap.data().results || {});
                                    } else {
                                        setOfficialResults({});
                                    }
                                });

                                // Listen for Game State (Metadata)
                                onSnapshot(doc(firestore, 'artifacts', currentAppId, 'public', 'data', 'game_state', 'config'), (snap) => {
                                    if (snap.exists()) {
                                        setGameState(snap.data());
                                    }
                                });
                            }
                        });

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                             await signInAnonymously(auth);
                        }

                        setFirebaseInitialized(true);
                    } catch (error) { console.error("Firebase init error:", error); }
                };
                initFirebase();
            }, []);

            const gameStarted = Object.keys(officialResults).length > 0;

            const checkNameAvailability = async () => {
                const name = userName.trim();
                if (!name) return;
                
                if (!/^[a-zA-Z0-9 .\-]+$/.test(name)) {
                    setNameError("Invalid name. Only letters, numbers, spaces, dots, and dashes.");
                    return;
                }

                if (db) {
                    try {
                        const { collection, query, where, getDocs } = window.firebaseModules;
                        const q = query(
                            collection(db, 'artifacts', appId, 'public', 'data', 'prop_bets'), 
                            where('name', '==', name)
                        );
                        const snap = await getDocs(q);
                        if (!snap.empty) {
                            setNameError("Name already exists. Please choose another.");
                        } else {
                            setNameError("");
                        }
                    } catch(e) { console.error("Name check error", e); }
                }
            };

            const handleSelect = (questionId, optionText, points) => {
                setUserSelections(prev => {
                    if (prev[questionId]?.text === optionText) {
                        const newState = { ...prev };
                        delete newState[questionId];
                        return newState;
                    }
                    return { ...prev, [questionId]: { text: optionText, points: points } };
                });
            };

            const handleScoreChange = (qid, team, value) => {
                setUserSelections(prev => {
                    const current = prev[qid]?.scores || { patriots: '', seahawks: '' };
                    const newScores = { ...current, [team]: value };
                    if (!newScores.patriots && !newScores.seahawks) {
                         const newState = { ...prev };
                         delete newState[qid];
                         return newState;
                    }
                    return { ...prev, [qid]: { text: `Patriots: ${newScores.patriots || '0'}, Seahawks: ${newScores.seahawks || '0'}`, scores: newScores, points: 60 } };
                });
            };

            const handlePreSubmit = () => {
                const missingCount = QUESTIONS.length - Object.keys(userSelections).length;
                if (!userName.trim()) {
                    setWarningMessage("Please enter your name to submit.");
                    setShowWarningModal(true);
                    return;
                }
                if (missingCount > 0) {
                    setWarningMessage(`You have ${missingCount} unanswered questions. Please complete all picks before submitting.`);
                    setShowWarningModal(true);
                    return;
                }
                if (nameError) {
                    setWarningMessage(nameError);
                    setShowWarningModal(true);
                    return;
                }
                
                setShowConfirmModal(true);
            };

            // Refactored actual submission logic into its own function
            const performSubmission = async () => {
                setSubmitting(true);
                const potentialScore = Object.values(userSelections).reduce((acc, curr) => acc + (curr.points || 0), 0);
                const publishedAtSubmission = gameStarted ? Object.keys(officialResults) : [];

                // Fetch IP Address
                let userIp = "Unknown";
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    if (res.ok) {
                        const data = await res.json();
                        userIp = data.ip;
                    }
                } catch (e) {
                    console.warn("IP Fetch failed", e);
                }

                try {
                    const { collection, addDoc } = window.firebaseModules;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'prop_bets'), {
                        name: userName.trim(),
                        selections: userSelections,
                        potentialPoints: potentialScore,
                        timestamp: Date.now(),
                        hidden: false,
                        late: gameStarted,
                        publishedAtSubmission: publishedAtSubmission,
                        ipAddress: userIp // Add IP to saved doc
                    });
                    
                    setShowPostSubmitModal(true);
                    
                } catch (e) {
                    console.error(e);
                    alert("Error submitting picks. Please try again.");
                }
                setSubmitting(false);
            };

            const handleConfirmSubmit = () => {
                setShowConfirmModal(false);
                
                if (gameStarted) {
                    // Trigger the Late Key Modal instead of submitting directly
                    setExemptionKey(""); // Reset key field
                    setShowLateKeyModal(true);
                } else {
                    performSubmission();
                }
            };

            const handleLateKeySubmit = () => {
                if (exemptionKey.trim().toUpperCase() === "LATE60") {
                    setShowLateKeyModal(false);
                    performSubmission();
                } else {
                    alert("Invalid Exemption Key. Please contact the admin.");
                }
            };

            const handlePostSubmitClose = () => {
                setShowPostSubmitModal(false);
                handleTabChange('standings'); // Use helper to ensure scrolling is handled if needed
                setUserSelections({});
                setUserName("");
                setRandomMode('fill');
                setClearMode('clear');
                setBackupSelections({});
            };

            const handlePostSubmitPrint = () => {
                generatePrintWindow(userSelections, userName);
                // Don't close immediately so they can email/copy too if they want
            };

            // Helper to generate text summary for Email/Clipboard
            const generateTextSummary = (selections, name) => {
                let text = `SUPER BOWL LX PICKS\nParticipant: ${name}\n\n`;
                QUESTIONS.forEach(q => {
                    const pick = selections[q.id];
                    if (pick) {
                        if (q.type === 'score') {
                             text += `${q.id}. Patriots ${pick.scores?.patriots || 0} - ${pick.scores?.seahawks || 0} Seahawks (${pick.points} pts)\n`;
                        } else {
                             text += `${q.id}. ${pick.text} (${pick.points} pts)\n`;
                        }
                    } else {
                        text += `${q.id}. [No Pick]\n`;
                    }
                });
                text += `\nTotal Potential Points: ${Object.values(selections).reduce((a,b)=>a+(b.points||0),0)}`;
                return text;
            };

            const handleCopyPicks = () => {
                const text = generateTextSummary(userSelections, userName);
                
                // Fallback method for iframe/older browsers to ensure copy works
                const textArea = document.createElement("textarea");
                textArea.value = text;
                
                // Ensure it's not visible but part of DOM
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    setCopyFeedback(true);
                    setTimeout(() => setCopyFeedback(false), 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert("Failed to copy. Please try printing instead.");
                }
                
                document.body.removeChild(textArea);
            };
            
            // Helper function to render content based on view state
            const renderContent = () => {
                switch(view) {
                    case 'standings':
                        return (
                            <StandingsView 
                                db={db} 
                                appId={appId} 
                                officialResults={officialResults} 
                                gameState={gameState} 
                                golfData={golfData} 
                                golfError={golfError}
                                golfRound={golfRound}
                                suggestionsMap={suggestionsMap} 
                                gameStarted={gameStarted || (demoMode !== 'off')} 
                                standingsState={standingsState}
                                updateStandingsState={updateStandingsState}
                            />
                        );
                    case 'admin':
                        return <AdminView db={db} appId={appId} officialResults={officialResults} gameState={gameState} nflStatusHook={nflStatusHook} suggestionsMap={suggestionsMap} demoMode={demoMode} setDemoMode={setDemoMode} golfData={golfData} golfError={golfError} golfRound={golfRound} adminTab={adminTab} isAdminAuthenticated={isAdminAuthenticated} setIsAdminAuthenticated={setIsAdminAuthenticated} />;
                    case 'rules':
                        // PHASE 3: Pass accessConfig and onNavigate
                        return <RulesView paymentConfig={paymentConfig} rulesConfig={rulesConfig} accessConfig={accessConfig} onNavigate={handleTabChange} />;
                    case 'print':
                        // PHASE 1: Pass userSelections and userName
                        return <PrintView userSelections={userSelections} userName={userName} />;
                    case 'hof':
                        return <HOFView />;
                    case 'form':
                    default:
                        // PHASE 2: Handle Hidden Questions
                        if (accessConfig.questionsHidden) {
                            return (
                                <div className="space-y-6 animate-fade-in flex flex-col items-center justify-center min-h-[40vh] p-4">
                                    <div className="bg-[#001f3f] border-2 border-blue-500/50 rounded-lg p-8 text-center shadow-2xl w-full max-w-lg">
                                        <div className="w-20 h-20 bg-[#001122] rounded-full flex items-center justify-center mx-auto mb-6 border border-blue-500/30">
                                            <i className="fas fa-clipboard-list text-blue-400 text-3xl"></i>
                                        </div>
                                        <h3 className="text-2xl font-black text-white uppercase mb-4 tracking-tight">Prop Sheet Prep</h3>
                                        <p className="text-blue-200 text-lg leading-relaxed">
                                            The questions are currently being finalized by the commissioner.
                                        </p>
                                        <p className="text-blue-400 mt-4 font-bold text-sm uppercase tracking-wider">
                                            Check back soon to make your picks!
                                        </p>
                                    </div>
                                </div>
                            );
                        }

                        return (
                            <div className="space-y-6 animate-fade-in">
                                {QUESTIONS.map((q) => (
                                    <QuestionCard 
                                        key={q.id}
                                        q={q}
                                        userSelection={userSelections[q.id]}
                                        onSelect={handleSelect}
                                        onScoreChange={handleScoreChange}
                                        disabled={submitting}
                                        gameState={gameState}
                                        golfData={golfData}
                                        golfError={golfError}
                                        officialResults={officialResults}
                                        golfRound={golfRound}
                                        publicNotesConfig={publicNotesConfig}
                                        suggestion={suggestionsMap[q.id]}
                                        showSuggestions={true}
                                    />
                                ))}
                            </div>
                        );
                }
            };

            const answeredCount = Object.keys(userSelections).length;
            const totalQuestions = QUESTIONS.length;
            
            // PHASE 2: Submit Button Logic
            const getSubmitButtonProps = () => {
                const { submissionStatus, openTimestamp, questionsHidden } = accessConfig;
                // Phase 4: Use currentTime state instead of Date.now() to ensure re-renders
                const now = currentTime;
                
                // If questions are hidden, button should essentially be disabled or hidden logic
                if (questionsHidden) return { label: "Coming Soon", disabled: true, className: "bg-gray-700 cursor-not-allowed" };
                
                // If status is closed
                if (submissionStatus === 'closed') return { label: "Contest Closed", disabled: true, className: "bg-gray-600 cursor-not-allowed" };
                
                // If status is scheduled (and in future)
                if (submissionStatus === 'scheduled') {
                    const openTime = new Date(openTimestamp).getTime();
                    // Valid future date
                    if (!isNaN(openTime) && now < openTime) {
                        const dateStr = new Date(openTimestamp).toLocaleString([], { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                        return { label: `OPENS ${dateStr.toUpperCase()}`, disabled: true, className: "bg-gray-600 cursor-not-allowed" };
                    }
                    // If time passed, fall through to open state
                }
                
                // Default Open State (Check for Late Entry context)
                if (gameStarted) return { label: "SUBMIT LATE ENTRY (KEY REQUIRED)", disabled: false, className: "bg-[#D50A0A] hover:bg-[#b00808] cursor-pointer transform hover:scale-[1.02]" };
                
                return { label: "Submit Picks to Group", disabled: false, className: "bg-[#D50A0A] hover:bg-[#b00808] cursor-pointer transform hover:scale-[1.02]" };
            };

            const submitBtnProps = getSubmitButtonProps();
            
            return (
                <div className="max-w-3xl mx-auto p-4 pb-20">
                    <ScrollingTicker message={scrollingMessage} view={view} />
                    
                    {/* Render Admin Broadcaster if authenticated */}
                    {isAdminAuthenticated && (
                        <DataBroadcaster 
                            db={db} 
                            appId={appId} 
                            nflGameId={effectiveNflId} 
                            golfConfig={effectiveGolfConfig} 
                            user={user}
                        />
                    )}
                    
                    <div className="sticky top-0 z-20 bg-[#001f3f]/95 backdrop-blur-md border-b-4 border-[#D50A0A] p-5 shadow-2xl mb-8 -mx-4 sm:mx-0 sm:rounded-b-lg">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <div className="flex items-center gap-3 self-start md:self-center">
                                <div className="w-10 h-12 bg-white flex items-center justify-center shield-icon shadow-lg">
                                     <i className="fas fa-football-ball text-[#013369] text-xl"></i>
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black italic text-white leading-none tracking-tighter shadow-black drop-shadow-md">SUPER BOWL LX</h1>
                                    <p className="text-xs text-blue-200 font-medium tracking-widest uppercase mt-1">Prop Bet Pool</p>
                                </div>
                            </div>
                            
                            <div className="w-full md:w-auto flex flex-col gap-2 items-end">
                                {view === 'form' && (
                                    <>
                                        <div className="relative w-full md:w-64">
                                            <input 
                                                type="text" 
                                                value={userName}
                                                onChange={(e) => { setUserName(e.target.value.toUpperCase()); setNameError(""); }}
                                                onBlur={checkNameAvailability}
                                                placeholder="PARTICIPANT NAME"
                                                className={`w-full bg-[#000c1a] border rounded p-2 text-white placeholder-blue-500/50 focus:outline-none transition-all font-bold text-right uppercase ${nameError ? 'border-red-500 ring-1 ring-red-500' : 'border-[#013369] focus:border-[#D50A0A] focus:ring-1 focus:ring-[#D50A0A]'}`}
                                            />
                                            {nameError && <div className="text-[10px] text-red-400 absolute right-0 -bottom-4 font-bold bg-[#000c1a] px-1 rounded">{nameError}</div>}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="flex space-x-6 border-b border-[#003366] mb-4 overflow-x-auto">
                            <button onClick={() => handleTabChange('form')} className={`pb-2 font-bold uppercase text-sm transition-colors whitespace-nowrap ${view === 'form' ? 'tab-active' : 'tab-inactive hover:text-blue-300'}`}>Make Picks</button>
                            <button onClick={() => handleTabChange('standings')} className={`pb-2 font-bold uppercase text-sm transition-colors whitespace-nowrap ${view === 'standings' ? 'tab-active' : 'tab-inactive hover:text-blue-300'}`}>Standings</button>
                            <button onClick={() => handleTabChange('rules')} className={`pb-2 font-bold uppercase text-sm transition-colors whitespace-nowrap ${view === 'rules' ? 'tab-active' : 'tab-inactive hover:text-blue-300'}`}>Rules</button>
                            <button onClick={() => handleTabChange('hof')} className={`pb-2 font-bold uppercase text-sm transition-colors whitespace-nowrap ${view === 'hof' ? 'tab-active' : 'tab-inactive hover:text-blue-300'}`}>HOF</button>
                            <button onClick={() => handleTabChange('print')} className={`pb-2 font-bold uppercase text-sm transition-colors whitespace-nowrap ${view === 'print' ? 'tab-active' : 'tab-inactive hover:text-blue-300'}`}>Print</button>
                            <button onClick={() => handleTabChange('admin')} className={`pb-2 font-bold uppercase text-sm transition-colors whitespace-nowrap ${view === 'admin' ? 'tab-active' : 'tab-inactive hover:text-blue-300'}`}>Admin</button>
                        </div>

                        {view === 'form' && (
                            <>
                                <div className="flex justify-between text-xs font-bold text-blue-200 uppercase tracking-wider mb-2 items-end">
                                    <span>Completion Status</span>
                                    <span>{answeredCount} / {totalQuestions}</span>
                                </div>
                                <ProgressBar 
                                    current={answeredCount} 
                                    total={totalQuestions} 
                                    onRandomClick={handleRandomToggle} 
                                    randomState={randomMode}
                                    onClearClick={handleClearToggle}
                                    clearState={clearMode}
                                />
                            </>
                        )}
                        
                        {view === 'admin' && isAdminAuthenticated && (
                            <div className="flex space-x-4 border-b border-[#003366] mb-1 overflow-x-auto pb-1">
                                <button onClick={() => handleAdminTabChange('grading')} className={`pb-1 font-bold uppercase text-xs transition-colors whitespace-nowrap ${adminTab === 'grading' ? 'border-b-2 border-blue-400 text-white' : 'border-b-2 border-transparent text-gray-500 hover:text-blue-300'}`}>Grading</button>
                                <button onClick={() => handleAdminTabChange('entries')} className={`pb-1 font-bold uppercase text-xs transition-colors whitespace-nowrap ${adminTab === 'entries' ? 'border-b-2 border-blue-400 text-white' : 'border-b-2 border-transparent text-gray-500 hover:text-blue-300'}`}>Manage Entries</button>
                                <button onClick={() => handleAdminTabChange('settings')} className={`pb-1 font-bold uppercase text-xs transition-colors whitespace-nowrap ${adminTab === 'settings' ? 'border-b-2 border-blue-400 text-white' : 'border-b-2 border-transparent text-gray-500 hover:text-blue-300'}`}>Settings</button>
                                <button onClick={() => handleAdminTabChange('notes')} className={`pb-1 font-bold uppercase text-xs transition-colors whitespace-nowrap ${adminTab === 'notes' ? 'border-b-2 border-blue-400 text-white' : 'border-b-2 border-transparent text-gray-500 hover:text-blue-300'}`}>Notes</button>
                            </div>
                        )}
                    </div>
                    
                    <div className="min-h-[50vh]">
                        {renderContent()}
                    </div>

                    {/* PHASE 2: Conditional Button Rendering */}
                    {view === 'form' && !accessConfig.questionsHidden && (
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-[#001f3f]/95 border-t border-[#003366] backdrop-blur-md flex justify-center z-30">
                            <button 
                                onClick={handlePreSubmit} 
                                disabled={submitting || !!nameError || submitBtnProps.disabled} 
                                className={`max-w-md w-full py-3 px-6 rounded font-black uppercase tracking-wider transition-all shadow-lg text-white ${submitBtnProps.disabled ? 'bg-gray-700 cursor-not-allowed opacity-75' : submitBtnProps.className} ${submitting || !!nameError ? 'bg-gray-700 cursor-not-allowed' : ''}`}
                            >
                                {submitting ? 'Submitting...' : submitBtnProps.label}
                            </button>
                        </div>
                    )}
                    
                    {/* Pre-Submission Confirm Modal */}
                    <SimpleModal 
                        isOpen={showConfirmModal} 
                        onClose={() => setShowConfirmModal(false)} 
                        title="Confirm Entry" 
                        borderColor="border-[#D50A0A]"
                    >
                        <div className="bg-[#001122] p-4 rounded border border-[#003366] mb-6">
                            <p className="text-blue-300 uppercase text-xs font-bold tracking-widest mb-1">To Participate</p>
                            <p className="text-white text-sm mb-1">{paymentConfig.fee > 0 ? `${paymentConfig.methodName} $${paymentConfig.fee} to` : 'Free to Play!'}</p>
                            {paymentConfig.fee > 0 && <p className="text-xl font-bold text-white mb-3">{paymentConfig.identifier}</p>}
                            <div className="h-px bg-[#003366] w-full my-3"></div>
                            <p className="text-xs text-blue-200 whitespace-pre-line">
                                {rulesConfig.payouts || "1st Place: 100%"}
                                <br/>
                                {rulesConfig.ties}
                            </p>
                        </div>
                        <div className="flex gap-3">
                            <button 
                                onClick={() => setShowConfirmModal(false)}
                                className="flex-1 py-3 rounded font-bold uppercase bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={handleConfirmSubmit}
                                className="flex-1 py-3 rounded font-bold uppercase bg-[#D50A0A] text-white hover:bg-[#b00808] transition-colors shadow-lg"
                            >
                                Confirm
                            </button>
                        </div>
                    </SimpleModal>

                    {/* Late Key Modal */}
                    <SimpleModal 
                        isOpen={showLateKeyModal} 
                        onClose={() => setShowLateKeyModal(false)} 
                        title="Game In Progress" 
                        borderColor="border-red-500"
                        icon={{ name: 'fa-lock', color: 'text-red-500', bg: 'bg-red-900/30', border: 'border-red-500/50' }}
                    >
                        <p className="text-blue-200 text-sm mb-4">
                            The game has already started. To submit a late entry, you must enter the Admin Exemption Key.
                        </p>
                        <input 
                            type="text" 
                            value={exemptionKey} 
                            onChange={(e) => setExemptionKey(e.target.value)}
                            placeholder="ENTER KEY" 
                            className="w-full bg-[#000c1a] border border-[#003366] rounded p-3 text-white placeholder-gray-600 focus:outline-none focus:border-red-500 transition-all font-bold text-center uppercase tracking-widest mb-4"
                            autoFocus
                        />
                        <div className="flex gap-3">
                            <button 
                                onClick={() => setShowLateKeyModal(false)}
                                className="flex-1 py-3 rounded font-bold uppercase bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={handleLateKeySubmit}
                                disabled={!exemptionKey}
                                className="flex-1 py-3 rounded font-bold uppercase bg-red-600 text-white hover:bg-red-500 transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Submit
                            </button>
                        </div>
                    </SimpleModal>

                    {/* Warning Modal */}
                    <SimpleModal 
                        isOpen={showWarningModal} 
                        onClose={() => setShowWarningModal(false)} 
                        title="Incomplete Entry" 
                        borderColor="border-red-600"
                        icon={{ name: 'fa-exclamation-triangle', color: 'text-red-500', bg: 'bg-red-900/30', border: 'border-red-600/50' }}
                    >
                        <p className="text-blue-200 mb-6">
                            {warningMessage}
                        </p>
                        <button 
                            onClick={() => setShowWarningModal(false)}
                            className="w-full py-3 rounded font-bold uppercase bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors"
                        >
                            OK
                        </button>
                    </SimpleModal>

                    {/* Post-Submission Success Modal */}
                    <SimpleModal 
                        isOpen={showPostSubmitModal} 
                        onClose={handlePostSubmitClose} 
                        title="Submission Successful!" 
                        borderColor="border-green-500"
                        icon={{ name: 'fa-check', color: 'text-white', bg: 'bg-green-500', border: 'border-green-500' }}
                    >
                        <p className="text-blue-200 mb-6">
                            Your picks have been locked in. {!gameStarted && <span>They will remain <strong>hidden on the leaderboard</strong> until the game starts.</span>}
                        </p>
                        <div className="bg-blue-900/30 border border-blue-500/30 p-4 rounded mb-6 text-sm text-blue-100">
                            {gameStarted ? "Save your picks now:" : "Save your picks now (you won't be able to see them again until kickoff):"}
                        </div>
                        
                        <div className="grid grid-cols-1 gap-3 mb-4">
                            <button 
                                onClick={handlePostSubmitPrint}
                                className="w-full py-3 rounded font-bold uppercase bg-[#D50A0A] text-white hover:bg-[#b00808] transition-colors shadow-lg flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-print"></i> Print / Save PDF
                            </button>
                            <div className="flex gap-3">
                                <button 
                                    onClick={handleCopyPicks}
                                    className={`flex-1 py-3 rounded font-bold uppercase transition-colors border flex items-center justify-center gap-2 ${copyFeedback ? 'bg-green-600 text-white border-green-500' : 'bg-[#003366] text-blue-200 hover:bg-[#004080] hover:text-white border-blue-800'}`}
                                >
                                    {copyFeedback ? <><i className="fas fa-check"></i> COPIED!</> : <><i className="fas fa-copy"></i> Copy Text</>}
                                </button>
                            </div>
                        </div>

                        <button 
                            onClick={handlePostSubmitClose}
                            className="text-gray-500 hover:text-white text-sm underline decoration-gray-600 hover:decoration-white underline-offset-4"
                        >
                            Done / Close
                        </button>
                    </SimpleModal>

                    <div className="h-20"></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
